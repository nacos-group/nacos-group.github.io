{
  "filename": "monitor-guide.md",
  "__html": "<h1>Nacos 监控手册</h1>\n<p>Nacos 0.8.0版本完善了监控系统，支持通过暴露metrics数据接入第三方监控系统监控Nacos运行状态，目前支持prometheus、elastic search和influxdb，下面结合prometheus和grafana如何监控Nacos，官网<a href=\"http://monitor.nacos.io\">grafana监控页面</a>。与elastic search和influxdb结合可自己查找相关资料</p>\n<h2>搭建Nacos集群暴露metrics数据</h2>\n<p>按照<a href=\"https://nacos.io/zh-cn/docs/deployment.html\">部署文档</a>搭建好Nacos集群</p>\n<p>配置application.properties文件，暴露metrics数据</p>\n<pre><code>management.endpoints.web.exposure.include=*\n</code></pre>\n<p>访问{ip}:8848/nacos/actuator/prometheus，看是否能访问到metrics数据</p>\n<h2>搭建prometheus采集Nacos metrics数据</h2>\n<p>下载你想安装的prometheus版本，地址为<a href=\"https://prometheus.io/download/\">download prometheus</a></p>\n<h3>linux &amp; mac</h3>\n<p>解压prometheus压缩包</p>\n<pre><code>tar xvfz prometheus-*.tar.gz\ncd prometheus-*\n</code></pre>\n<p>修改配置文件prometheus.yml采集Nacos metrics数据</p>\n<pre><code>    metrics_path: '/nacos/actuator/prometheus'\n    static_configs:\n      - targets: ['{ip1}:8848','{ip2}:8848','{ip3}:8848']\n</code></pre>\n<p>启动prometheus服务</p>\n<pre><code>./prometheus --config.file=&quot;prometheus.yml&quot;\n</code></pre>\n<h3>windows</h3>\n<p>下载对应的windows版本并解压</p>\n<p>修改配置文件prometheus.yml采集Nacos metrics数据</p>\n<pre><code>    metrics_path: '/nacos/actuator/prometheus'\n    static_configs:\n      - targets: ['{ip1}:8848','{ip2}:8848','{ip3}:8848']\n</code></pre>\n<p>启动prometheus服务</p>\n<pre><code>prometheus.exe --config.file=prometheus.yml\n</code></pre>\n<p>通过访问http://{ip}:9090/graph可以看到prometheus的采集数据，在搜索栏搜索nacos_monitor可以搜索到Nacos数据说明采集数据成功\n<img src=\"https://img.alicdn.com/tfs/TB1LThVCQvoK1RjSZFwXXciCFXa-2832-1576.png\" alt=\"IMAGE\"></p>\n<h2>搭建grafana图形化展示metrics数据</h2>\n<p>和prometheus在同一台机器上安装grafana，使用 yum 安装grafana</p>\n<h3>mac</h3>\n<pre><code>brew install grafana\nbrew services start grafana\n</code></pre>\n<h3>linux</h3>\n<pre><code>sudo yum install https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.2.4-1.x86_64.rpm\nsudo service grafana-server start\n</code></pre>\n<h3>windows</h3>\n<p>参考文档：<a href=\"http://docs.grafana.org/installation/windows/\">http://docs.grafana.org/installation/windows/</a></p>\n<p>访问grafana: http://{ip}:3000</p>\n<p>配置prometheus数据源\n<img src=\"https://img.alicdn.com/tfs/TB1bTafCOLaK1RjSZFxXXamPFXa-2832-1568.png\" alt=\"IMAGE\"></p>\n<p>导入Nacos grafana监控<a href=\"https://github.com/nacos-group/nacos-template/blob/master/nacos-grafana.json\">模版</a>\n<img src=\"https://img.alicdn.com/tfs/TB1JadVCPDpK1RjSZFrXXa78VXa-2742-1338.png\" alt=\"IMAGE\"></p>\n<p>Nacos监控分为三个模块:</p>\n<ul>\n<li>nacos monitor展示核心监控项\n<img src=\"https://img.alicdn.com/tfs/TB1PMpUCQvoK1RjSZFDXXXY3pXa-2832-1584.png\" alt=\"IMAGE\"></li>\n<li>nacos detail展示指标的变化曲线\n<img src=\"https://img.alicdn.com/tfs/TB1ZBF4CNjaK1RjSZFAXXbdLFXa-2742-1480.png\" alt=\"IMAGE\"></li>\n<li>nacos alert为告警项\n<img src=\"https://img.alicdn.com/tfs/TB1ALlUCFzqK1RjSZFCXXbbxVXa-2742-1476.png\" alt=\"IMAGE\"></li>\n</ul>\n<h2>配置grafana告警</h2>\n<p>当Nacos运行出现问题时，需要grafana告警通知相关负责人。grafana支持多种告警方式，常用的有邮件，钉钉和webhook方式</p>\n<h3>钉钉告警</h3>\n<p>钉钉可以通过配置钉钉机器人\n<img src=\"https://img.alicdn.com/tfs/TB1eJ0RCSzqK1RjSZFjXXblCFXa-2742-1482.png\" alt=\"IMAGE\"></p>\n<p>配置钉钉通知url\n<img src=\"https://img.alicdn.com/tfs/TB1ERtQCSzqK1RjSZFjXXblCFXa-2832-1578.png\" alt=\"IMAGE\"></p>\n<p>测试告警项\n<img src=\"https://img.alicdn.com/tfs/TB1KvXPCHPpK1RjSZFFXXa5PpXa-996-504.png\" alt=\"IMAGE\"></p>\n<h3>邮件告警</h3>\n<p>修改defaults.ini配置文件，增加邮件告警</p>\n<pre><code>#################################### SMTP / Emailing ##########################\n[smtp]\nenabled = true\nhost = smtp.126.com:25\nuser = xxxxxx\npassword = xxxxx\n;cert_file =\n;key_file =\nskip_verify = true\nfrom_address = xxxxxx@126.com\n\n[emails]\n;welcome_email_on_sign_up = false\n</code></pre>\n<p>配置通知邮箱\n<img src=\"https://img.alicdn.com/tfs/TB12qyhCNnaK1RjSZFtXXbC2VXa-2832-1576.png\" alt=\"IMAGE\"></p>\n<h2>Nacos metrics含义</h2>\n<h3>jvm metrics</h3>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>system_cpu_usage</td>\n<td>CPU使用率</td>\n</tr>\n<tr>\n<td>system_load_average_1m</td>\n<td>load</td>\n</tr>\n<tr>\n<td>jvm_memory_used_bytes</td>\n<td>内存使用字节，包含各种内存区</td>\n</tr>\n<tr>\n<td>jvm_memory_max_bytes</td>\n<td>内存最大字节，包含各种内存区</td>\n</tr>\n<tr>\n<td>jvm_gc_pause_seconds_count</td>\n<td>gc次数，包含各种gc</td>\n</tr>\n<tr>\n<td>jvm_gc_pause_seconds_sum</td>\n<td>gc耗时，包含各种gc</td>\n</tr>\n<tr>\n<td>jvm_threads_daemon</td>\n<td>线程数</td>\n</tr>\n</tbody>\n</table>\n<h3>Nacos 监控指标</h3>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>http_server_requests_seconds_count</td>\n<td>http请求次数，包括多种(url,方法,code)</td>\n</tr>\n<tr>\n<td>http_server_requests_seconds_sum</td>\n<td>http请求总耗时，包括多种(url,方法,code)</td>\n</tr>\n<tr>\n<td>nacos_timer_seconds_sum</td>\n<td>Nacos config水平通知耗时</td>\n</tr>\n<tr>\n<td>nacos_timer_seconds_count</td>\n<td>Nacos config水平通知次数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='longPolling'}</td>\n<td>Nacos config长连接数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='configCount'}</td>\n<td>Nacos config配置个数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='dumpTask'}</td>\n<td>Nacos config配置落盘任务堆积数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='notifyTask'}</td>\n<td>Nacos config配置水平通知任务堆积数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='getConfig'}</td>\n<td>Nacos config读配置统计数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='publish'}</td>\n<td>Nacos config写配置统计数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='ipCount'}</td>\n<td>Nacos naming ip个数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='domCount'}</td>\n<td>Nacos naming域名个数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='failedPush'}</td>\n<td>Nacos naming推送失败数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='avgPushCost'}</td>\n<td>Nacos naming平均推送耗时</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='leaderStatus'}</td>\n<td>Nacos naming角色状态</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='maxPushCost'}</td>\n<td>Nacos naming最大推送耗时</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='mysqlhealthCheck'}</td>\n<td>Nacos naming mysql健康检查次数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='httpHealthCheck'}</td>\n<td>Nacos naming http健康检查次数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='tcpHealthCheck'}</td>\n<td>Nacos naming tcp健康检查次数</td>\n</tr>\n</tbody>\n</table>\n<h3>nacos 异常指标</h3>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>nacos_exception_total{name='db'}</td>\n<td>数据库异常</td>\n</tr>\n<tr>\n<td>nacos_exception_total{name='configNotify'}</td>\n<td>Nacos config水平通知失败</td>\n</tr>\n<tr>\n<td>nacos_exception_total{name='unhealth'}</td>\n<td>Nacos config server之间健康检查异常</td>\n</tr>\n<tr>\n<td>nacos_exception_total{name='disk'}</td>\n<td>Nacos naming写磁盘异常</td>\n</tr>\n<tr>\n<td>nacos_exception_total{name='leaderSendBeatFailed'}</td>\n<td>Nacos naming leader发送心跳异常</td>\n</tr>\n<tr>\n<td>nacos_exception_total{name='illegalArgument'}</td>\n<td>请求参数不合法</td>\n</tr>\n<tr>\n<td>nacos_exception_total{name='nacos'}</td>\n<td>Nacos请求响应内部错误异常（读写失败，没权限，参数错误）</td>\n</tr>\n</tbody>\n</table>\n<h3>client metrics</h3>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>nacos_monitor{name='subServiceCount'}</td>\n<td>订阅的服务数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='pubServiceCount'}</td>\n<td>发布的服务数</td>\n</tr>\n<tr>\n<td>nacos_monitor{name='configListenSize'}</td>\n<td>监听的配置数</td>\n</tr>\n<tr>\n<td>nacos_client_request_seconds_count</td>\n<td>请求的次数，包括多种(url,方法,code)</td>\n</tr>\n<tr>\n<td>nacos_client_request_seconds_sum</td>\n<td>请求的总耗时，包括多种(url,方法,code)</td>\n</tr>\n</tbody>\n</table>\n<h2>Nacos-Sync监控</h2>\n<p>随着Nacos 0.9版本发布，Nacos-Sync 0.3版本支持了metrics监控，能通过metrics数据观察Nacos-Sync服务的运行状态，提升了Nacos-Sync的在生产环境的监控能力。\n整体的监控体系的搭建参考<a href=\"https://nacos.io/zh-cn/docs/monitor-guide.html\">Nacos监控手册</a></p>\n<h2>grafana监控Nacos-Sync</h2>\n<p>和Nacos监控一样，Nacos-Sync也提供了监控模版，导入监控<a href=\"https://github.com/nacos-group/nacos-template/blob/master/nacos-sync-grafana\">模版</a></p>\n<p>Nacos-Sync监控同样也分为三个模块:</p>\n<ul>\n<li>nacos-sync monitor展示核心监控项\n<img src=\"https://img.alicdn.com/tfs/TB1GeNWKmzqK1RjSZFHXXb3CpXa-2834-1588.png\" alt=\"monitor\"></li>\n<li>nacos-sync detail和alert展示监控曲线和告警\n<img src=\"https://img.alicdn.com/tfs/TB1kP8UKbvpK1RjSZPiXXbmwXXa-2834-1570.png\" alt=\"detail\"></li>\n</ul>\n<h2>Nacos-Sync metrics含义</h2>\n<p>Nacos-Sync的metrics分为jvm层和应用层</p>\n<h3>jvm metrics</h3>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>system_cpu_usage</td>\n<td>CPU使用率</td>\n</tr>\n<tr>\n<td>system_load_average_1m</td>\n<td>load</td>\n</tr>\n<tr>\n<td>jvm_memory_used_bytes</td>\n<td>内存使用字节，包含各种内存区</td>\n</tr>\n<tr>\n<td>jvm_memory_max_bytes</td>\n<td>内存最大字节，包含各种内存区</td>\n</tr>\n<tr>\n<td>jvm_gc_pause_seconds_count</td>\n<td>gc次数，包含各种gc</td>\n</tr>\n<tr>\n<td>jvm_gc_pause_seconds_sum</td>\n<td>gc耗时，包含各种gc</td>\n</tr>\n<tr>\n<td>jvm_threads_daemon</td>\n<td>线程数</td>\n</tr>\n</tbody>\n</table>\n<h2>应用层 metrics</h2>\n<table>\n<thead>\n<tr>\n<th>指标</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>nacosSync_task_size</td>\n<td>同步任务数</td>\n</tr>\n<tr>\n<td>nacosSync_cluster_size</td>\n<td>集群数</td>\n</tr>\n<tr>\n<td>nacosSync_add_task_rt</td>\n<td>同步任务执行耗时</td>\n</tr>\n<tr>\n<td>nacosSync_delete_task_rt</td>\n<td>删除任务耗时</td>\n</tr>\n<tr>\n<td>nacosSync_dispatcher_task</td>\n<td>从数据库中分发任务</td>\n</tr>\n<tr>\n<td>nacosSync_sync_task_error</td>\n<td>所有同步执行时的异常</td>\n</tr>\n</tbody>\n</table>\n",
  "link": "\\zh-cn\\docs\\monitor-guide.html",
  "meta": {
    "title": "Nacos 监控手册",
    "keywords": "Nacos,监控手册",
    "description": "Nacos 监控手册"
  }
}