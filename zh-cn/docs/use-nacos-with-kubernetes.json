{
  "filename": "use-nacos-with-kubernetes.md",
  "__html": "<h1>Kubernetes Nacos</h1>\n<p>本项目包含一个可构建的Nacos Docker Image，旨在利用StatefulSets在<a href=\"https://kubernetes.io/\">Kubernetes</a>上部署<a href=\"https://nacos.io\">Nacos</a></p>\n<h1>快速开始</h1>\n<ul>\n<li><strong>Clone 项目</strong></li>\n</ul>\n<pre><code class=\"language-shell\">git clone https://github.com/nacos-group/nacos-k8s.git\n</code></pre>\n<ul>\n<li><strong>简单例子</strong></li>\n</ul>\n<blockquote>\n<p>如果你使用简单方式快速启动,请注意这是没有使用持久化卷的,可能存在数据丢失风险:</p>\n</blockquote>\n<pre><code class=\"language-shell\">cd nacos-k8s\nchmod +x quick-startup.sh\n./quick-startup.sh\n</code></pre>\n<ul>\n<li>\n<p><strong>测试</strong></p>\n<ul>\n<li><strong>服务注册</strong></li>\n</ul>\n<pre><code class=\"language-bash\">curl -X PUT <span class=\"hljs-string\">'http://cluster-ip:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span>\n</code></pre>\n<ul>\n<li><strong>服务发现</strong></li>\n</ul>\n<pre><code class=\"language-bash\">curl -X GET <span class=\"hljs-string\">'http://cluster-ip:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName'</span>\n</code></pre>\n<ul>\n<li><strong>发布配置</strong></li>\n</ul>\n<pre><code class=\"language-bash\">curl -X POST <span class=\"hljs-string\">\"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld\"</span>\n</code></pre>\n<ul>\n<li><strong>获取配置</strong></li>\n</ul>\n<pre><code class=\"language-bash\">curl -X GET <span class=\"hljs-string\">\"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test\"</span>\n</code></pre>\n</li>\n</ul>\n<h1>高级使用</h1>\n<blockquote>\n<p>在高级使用中,Nacos在K8S拥有自动扩容缩容和数据持久特性,请注意如果需要使用这部分功能请使用PVC持久卷,Nacos的自动扩容缩容需要依赖持久卷,以及数据持久化也是一样,本例中使用的是NFS来使用PVC.</p>\n</blockquote>\n<h2>部署 NFS</h2>\n<ul>\n<li>创建角色</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/rbac.yaml\n</code></pre>\n<blockquote>\n<p>如果的K8S命名空间不是<strong>default</strong>，请在部署RBAC之前执行以下脚本:</p>\n</blockquote>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">#</span><span class=\"bash\"> Set the subject of the RBAC objects to the current namespace <span class=\"hljs-built_in\">where</span> the provisioner is being deployed</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> NS=$(kubectl config get-contexts|grep -e <span class=\"hljs-string\">\"^\\*\"</span> |awk <span class=\"hljs-string\">'{print $5}'</span>)</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> NAMESPACE=<span class=\"hljs-variable\">${NS:-default}</span></span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> sed -i<span class=\"hljs-string\">''</span> <span class=\"hljs-string\">\"s/namespace:.*/namespace: <span class=\"hljs-variable\">$NAMESPACE</span>/g\"</span> ./deploy/nfs/rbac.yaml</span>\n\n</code></pre>\n<ul>\n<li>创建 <code>ServiceAccount</code> 和部署 <code>NFS-Client Provisioner</code></li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/deployment.yaml\n</code></pre>\n<ul>\n<li>创建 NFS StorageClass</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/class.yaml\n</code></pre>\n<ul>\n<li>验证NFS部署成功</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl get pod -l app=nfs-client-provisioner\n</code></pre>\n<h2>部署数据库</h2>\n<ul>\n<li>部署主库</li>\n</ul>\n<pre><code class=\"language-shell\">\ncd nacos-k8s\n\nkubectl create -f deploy/mysql/mysql-master-nfs.yaml\n</code></pre>\n<ul>\n<li>部署从库</li>\n</ul>\n<pre><code class=\"language-shell\">\ncd nacos-k8s \n\nkubectl create -f deploy/mysql/mysql-slave-nfs.yaml\n</code></pre>\n<ul>\n<li>验证数据库是否正常工作</li>\n</ul>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">#</span><span class=\"bash\"> master</span>\nkubectl get pod \nNAME                         READY   STATUS    RESTARTS   AGE\nmysql-master-gf2vd                        1/1     Running   0          111m\n<span class=\"hljs-meta\">\n#</span><span class=\"bash\"> slave</span>\nkubectl get pod \nmysql-slave-kf9cb                         1/1     Running   0          110m\n</code></pre>\n<h2>部署Nacos</h2>\n<ul>\n<li>修改  <strong>deploy/nacos/nacos-pvc-nfs.yaml</strong></li>\n</ul>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">data:</span>\n  <span class=\"hljs-attr\">mysql.master.db.name:</span> <span class=\"hljs-string\">\"主库名称\"</span>\n  <span class=\"hljs-attr\">mysql.master.port:</span> <span class=\"hljs-string\">\"主库端口\"</span>\n  <span class=\"hljs-attr\">mysql.slave.port:</span> <span class=\"hljs-string\">\"从库端口\"</span>\n  <span class=\"hljs-attr\">mysql.master.user:</span> <span class=\"hljs-string\">\"主库用户名\"</span>\n  <span class=\"hljs-attr\">mysql.master.password:</span> <span class=\"hljs-string\">\"主库密码\"</span>\n</code></pre>\n<ul>\n<li>创建 Nacos</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f nacos-k8s/deploy/nacos/nacos-pvc-nfs.yaml\n</code></pre>\n<ul>\n<li>验证Nacos节点启动成功</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl get pod -l app=nacos\n\n\nNAME      READY   STATUS    RESTARTS   AGE\nnacos-0   1/1     Running   0          19h\nnacos-1   1/1     Running   0          19h\nnacos-2   1/1     Running   0          19h\n</code></pre>\n<h2>扩容测试</h2>\n<ul>\n<li>在扩容前，使用 <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a>获取在pod中的Nacos集群配置文件信息</li>\n</ul>\n<pre><code class=\"language-powershell\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span>; <span class=\"hljs-keyword\">do</span> echo nacos-<span class=\"hljs-variable\">$i</span>; kubectl exec nacos-<span class=\"hljs-variable\">$i</span> cat conf/cluster.conf; done\n</code></pre>\n<p>StatefulSet控制器根据其序数索引为每个Pod提供唯一的主机名。 主机名采用<statefulset name>  -  <ordinal index>的形式。 因为nacos StatefulSet的副本字段设置为2，所以当前集群文件中只有两个Nacos节点地址</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2019/gif/338441/1562846123635-e361d2b5-4bbe-4347-acad-8f11f75e6d38.gif\" alt=\"k8s\"></p>\n<ul>\n<li>使用kubectl scale 对Nacos动态扩容</li>\n</ul>\n<pre><code class=\"language-bash\">kubectl scale sts nacos --replicas=3\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2019/gif/338441/1562846139093-7a79b709-9afa-448a-b7d6-f57571d3a902.gif\" alt=\"scale\"></p>\n<ul>\n<li>在扩容后，使用 <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a>获取在pod中的Nacos集群配置文件信息</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> 0 1 2; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> nacos-<span class=\"hljs-variable\">$i</span>; kubectl <span class=\"hljs-built_in\">exec</span> nacos-<span class=\"hljs-variable\">$i</span> cat conf/cluster.conf; <span class=\"hljs-keyword\">done</span>\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2019/gif/338441/1562846177553-c1c7f379-1b41-4026-9f0b-23e15dde02a8.gif\" alt=\"get_cluster_after\"></p>\n<ul>\n<li>使用 <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a>执行Nacos API 在每台节点上获取当前<strong>Leader</strong>是否一致</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> 0 1 2; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> nacos-<span class=\"hljs-variable\">$i</span>; kubectl <span class=\"hljs-built_in\">exec</span> nacos-<span class=\"hljs-variable\">$i</span> curl -X GET <span class=\"hljs-string\">\"http://localhost:8848/nacos/v1/ns/raft/state\"</span>; <span class=\"hljs-keyword\">done</span>\n</code></pre>\n<p>到这里你可以发现新节点已经正常加入Nacos集群当中</p>\n<h1>例子部署环境</h1>\n<ul>\n<li>机器配置</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>内网IP</th>\n<th>主机名</th>\n<th>配置</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>172.17.79.3</td>\n<td>k8s-master</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n<tr>\n<td>172.17.79.4</td>\n<td>node01</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n<tr>\n<td>172.17.79.5</td>\n<td>node02</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>Kubernetes 版本：<strong>1.12.2</strong> （如果你和我一样只使用了三台机器，那么记得开启master节点的部署功能）</li>\n<li>NFS 版本：<strong>4.1</strong> 在k8s-master进行安装Server端，并且指定共享目录，本项目指定的**/data/nfs-share**</li>\n<li>Git</li>\n</ul>\n<h1>限制</h1>\n<ul>\n<li>必须要使用持久卷，否则会出现数据丢失的情况</li>\n</ul>\n<h1>项目目录</h1>\n<table>\n<thead>\n<tr>\n<th>目录</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>plugin</code></td>\n<td>帮助Nacos集群进行动态扩容的插件Docker镜像源码</td>\n</tr>\n<tr>\n<td><code>deploy</code></td>\n<td>K8s 部署文件</td>\n</tr>\n</tbody>\n</table>\n<h1>配置属性</h1>\n<ul>\n<li>nacos-pvc-nfs.yaml or nacos-quick-start.yaml</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>必要</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>mysql.master.db.name</code></td>\n<td>Y</td>\n<td>主库名称</td>\n</tr>\n<tr>\n<td><code>mysql.master.port</code></td>\n<td>N</td>\n<td>主库端口</td>\n</tr>\n<tr>\n<td><code>mysql.slave.port</code></td>\n<td>N</td>\n<td>从库端口</td>\n</tr>\n<tr>\n<td><code>mysql.master.user</code></td>\n<td>Y</td>\n<td>主库用户名</td>\n</tr>\n<tr>\n<td><code>mysql.master.password</code></td>\n<td>Y</td>\n<td>主库密码</td>\n</tr>\n<tr>\n<td><code>NACOS_REPLICAS</code></td>\n<td>N</td>\n<td>确定执行Nacos启动节点数量,如果不适用动态扩容插件,就必须配置这个属性，否则使用扩容插件后不会生效</td>\n</tr>\n<tr>\n<td><code>NACOS_SERVER_PORT</code></td>\n<td>N</td>\n<td>Nacos 端口</td>\n</tr>\n<tr>\n<td><code>PREFER_HOST_MODE</code></td>\n<td>Y</td>\n<td>启动Nacos集群按域名解析</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>nfs</strong> deployment.yaml</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>必要</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NFS_SERVER</code></td>\n<td>Y</td>\n<td>NFS 服务端地址</td>\n</tr>\n<tr>\n<td><code>NFS_PATH</code></td>\n<td>Y</td>\n<td>NFS 共享目录</td>\n</tr>\n<tr>\n<td><code>server</code></td>\n<td>Y</td>\n<td>NFS 服务端地址</td>\n</tr>\n<tr>\n<td><code>path</code></td>\n<td>Y</td>\n<td>NFS 共享目录</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>mysql</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>必要</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>MYSQL_ROOT_PASSWORD</code></td>\n<td>N</td>\n<td>ROOT 密码</td>\n</tr>\n<tr>\n<td><code>MYSQL_DATABASE</code></td>\n<td>Y</td>\n<td>数据库名称</td>\n</tr>\n<tr>\n<td><code>MYSQL_USER</code></td>\n<td>Y</td>\n<td>数据库用户名</td>\n</tr>\n<tr>\n<td><code>MYSQL_PASSWORD</code></td>\n<td>Y</td>\n<td>数据库密码</td>\n</tr>\n<tr>\n<td><code>MYSQL_REPLICATION_USER</code></td>\n<td>Y</td>\n<td>数据库复制用户</td>\n</tr>\n<tr>\n<td><code>MYSQL_REPLICATION_PASSWORD</code></td>\n<td>Y</td>\n<td>数据库复制用户密码</td>\n</tr>\n<tr>\n<td><code>Nfs:server</code></td>\n<td>N</td>\n<td>NFS 服务端地址，如果使用本地部署不需要配置</td>\n</tr>\n<tr>\n<td><code>Nfs:path</code></td>\n<td>N</td>\n<td>NFS 共享目录，如果使用本地部署不需要配置</td>\n</tr>\n</tbody>\n</table>\n",
  "link": "\\zh-cn\\docs\\use-nacos-with-kubernetes.html",
  "meta": {
    "title": "Kubernetes Nacos",
    "keywords": "nacos,kubernetes",
    "description": "本项目包含一个可构建的Nacos Docker Image，旨在利用 StatefulSets 在 Kubernetes上部署 Nacos。"
  }
}