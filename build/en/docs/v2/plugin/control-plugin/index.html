<!doctype html>
<html lang="en-US" dir="ltr" class="docs-wrapper docs-doc-page docs-version-2.X plugin-docs plugin-id-default docs-doc-id-v2/plugin/control-plugin" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">control plugin | Nacos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://nacos.io/en/img/nacos_colorful.png"><meta data-rh="true" name="twitter:image" content="https://nacos.io/en/img/nacos_colorful.png"><meta data-rh="true" property="og:url" content="https://nacos.io/en/docs/v2/plugin/control-plugin"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="2.X"><meta data-rh="true" name="docusaurus_tag" content="docs-default-2.X"><meta data-rh="true" name="docsearch:version" content="2.X"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-2.X"><meta data-rh="true" property="og:title" content="control plugin | Nacos"><meta data-rh="true" name="description" content="Nacos support control plugin."><meta data-rh="true" property="og:description" content="Nacos support control plugin."><meta data-rh="true" name="keywords" content="anti-fragile,control limit,connection limit,TPS"><link data-rh="true" rel="icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"><link data-rh="true" rel="canonical" href="https://nacos.io/en/docs/v2/plugin/control-plugin"><link data-rh="true" rel="alternate" href="https://nacos.io/en/docs/v2/plugin/control-plugin" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://nacos.io/zh-cn/docs/v2/plugin/control-plugin" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://nacos.io/docs/v2/plugin/control-plugin" hreflang="default"><link data-rh="true" rel="alternate" href="https://nacos.io/docs/v2/plugin/control-plugin" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1QV814950M-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/en/blog/rss.xml" title="Nacos RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/en/blog/atom.xml" title="Nacos Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Nacos" href="/en/opensearch.xml">


<meta name="aes-config" content="pid=xux-opensource&amp;user_type=101&amp;uid=&amp;username=&amp;dim10=nacos">
<meta name="referrer" content="no-referrer">
<link rel="stylesheet" href="//dev.g.alicdn.com/mamba/mse-arc-ui/0.0.20/umd/mse-arc-ui.min.css">
<script src="//dev.g.alicdn.com/mamba/mse-arc-ui/0.0.20/umd/mse-arc-ui.min.js"></script>
<script src="https://www.googletagmanager.com/gtag/js?id=G-0YDFJ7LX7F" async></script><link rel="stylesheet" href="/en/assets/css/styles.ada177ca.css">
<link rel="preload" href="/en/assets/js/runtime~main.2c7479d0.js" as="script">
<link rel="preload" href="/en/assets/js/main.ffb142c1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>



<script src="//g.alicdn.com/alilog/mlog/aplus_v2.js" id="beacon-aplus" exparams="clog=o&amp;aplus&amp;sidx=aplusSidx&amp;ckx=aplusCkx"></script>
<script src="//g.alicdn.com/aes/??tracker/1.0.34/index.js,tracker-plugin-pv/2.4.5/index.js,tracker-plugin-event/1.2.5/index.js,tracker-plugin-jserror/1.0.13/index.js,tracker-plugin-api/1.1.14/index.js,tracker-plugin-perf/1.1.8/index.js,tracker-plugin-eventTiming/1.0.4/index.js"></script>
<script src="//hm.baidu.com/hm.js?e3a5cec56ef8619cf9d7c2abebd509e3"></script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/en/"><div class="navbar__logo"><img src="/en/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/en/img/nacos_colorful.png" alt="Nacos Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/en/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" docid="/what-is-nacos" href="/en/docs/v2/what-is-nacos">2.X</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/en/docs/next/v2/plugin/control-plugin">User Docs</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/en/docs/v2/plugin/control-plugin">2.X</a></li><li><a class="dropdown__link" href="/en/docs/1.X/v2/what-is-nacos">1.X</a></li></ul></div><a class="navbar__item navbar__link" href="/en/cloud">NACOS CLOUD</a><a href="https://developer.aliyun.com/ebook/36?spm=a2c6h.20345107.ebook-index.18.152c2984fsi5ST" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">E-BOOK-NACOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a class="navbar__item navbar__link" href="/en/blog">BLOG</a><a class="navbar__item navbar__link" href="/en/community">COMMUNITY</a><a href="http://console.nacos.io/nacos/index.html" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">DEMO-CONSOLE<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_DSK9"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>En</a><ul class="dropdown__menu"><li><a href="/en/docs/v2/plugin/control-plugin" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">En</a></li><li><a href="/zh-cn/docs/v2/plugin/control-plugin" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">中</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><span class="theme-doc-version-badge badge badge--secondary">Version: 2.X</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>control plugin</h1></header><blockquote><p>Translated by AI.</p><h1>Control Plugin</h1></blockquote><p>Starting from version 2.3.0, Nacos supports injecting control related plugins through <a href="https://docs.oracle.com/javase/tutorial/sound/SPI-intro.html" target="_blank" rel="noopener noreferrer">SPI</a>, and selecting a specific plugin implementation as the actual control capability in the <code>application.properties</code> configuration file. This document provides a detailed introduction on how to implement an control plugin and how to make it effective.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="concepts-in-control-plugin">Concepts in Control Plugin<a href="#concepts-in-control-plugin" class="hash-link" aria-label="Direct link to Concepts in Control Plugin" title="Direct link to Concepts in Control Plugin">​</a></h2><p>Anti-fragility is a strategy that restricts access to a <strong>certain resource</strong> on the server when the <strong>frequency and number</strong> of accesses reach a certain level. It is used to protect the server from quickly rejecting requests under high pressure, preventing widespread unavailability caused by excessive resource access and exhaustion. The Nacos control plugin abstracts information primarily into <code>control point</code> and <code>control rules</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="control-point">Control Point<a href="#control-point" class="hash-link" aria-label="Direct link to Control Point" title="Direct link to Control Point">​</a></h3><p>The control point correspond to the mapping of resources occupied when making requests to the server. Currently, they mainly focus on <code>Connections</code> and <code>Transactions Per Second (TPS)</code>.</p><ul><li>The &quot;Connections&quot; control point primarily monitors the number of long connections used by Nacos 2.X clients and the number of long polling connections used by Nacos 1.X clients. These two types of connections are monitored independently.</li><li>The &quot;Transactions Per Second (TPS)&quot; control point mainly monitors the frequency of access to core interfaces in the Nacos server. Similar operation interfaces are considered as the same monitor point. For example, the registration service v1 interface and v2 interface are treated as the same monitor point. Please refer to the document for specific TPS monitor <a href="#1.1">point names</a>.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="control-rule">Control Rule<a href="#control-rule" class="hash-link" aria-label="Direct link to Control Rule" title="Direct link to Control Rule">​</a></h3><p>The control rules are different limitation rules that are executed for each control point. They are specifically categorized as &quot;Connection Control Rules&quot; <code>ConnectionControlRule</code> and &quot;Transactions Per Second Control Rules&quot; <code>TpsControlRule</code>.</p><p><code>ConnectionControlRule</code> mainly include follow contents:</p><table><thead><tr><th>Field name</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>countLimit</td><td>int</td><td>Total count limit for connections. Default is -1, indicating no limitation.</td></tr><tr><td>monitorIpList</td><td>Set</td><td>List of IPs to be monitored by trace. It is used to observe the operations performed on the corresponding IP connections in detail. Once added, the connection requests from the corresponding IPs will be logged in detail in the <code>remote-digest.log</code> file.</td></tr></tbody></table><p><code>TpsControlRule</code> mainly include follow contents:</p><table><thead><tr><th>Field name</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>pointName</td><td>String</td><td>Name of the control point corresponding to the rule.</td></tr><tr><td>pointRule</td><td>RuleDetail</td><td>Specific details of the rule content.</td></tr></tbody></table><p>And <code>RuleDetail</code> mainly include follow contents:</p><table><thead><tr><th>Field name</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td>ruleName</td><td>String</td><td>Name of the rule. It is different from the control point name. A control point can have multiple rule names.</td></tr><tr><td>maxCount</td><td>int</td><td>Total count limit for TPS. Default is -1, indicating no limitation.</td></tr><tr><td>period</td><td>TimeUnit</td><td>The period in which the rule is effective, such as counting at the second level or minute level. Default is <code>TimeUnit.SECONDS</code> for second level.</td></tr><tr><td>monitorType</td><td>String</td><td>Monitoring type, can be either <code>monitor</code> or <code>intercept</code>. It corresponds to monitoring mode (only counting and printing TPS, even if the rule is triggered, no interception) and interception mode.</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="plugin-development">Plugin Development<a href="#plugin-development" class="hash-link" aria-label="Direct link to Plugin Development" title="Direct link to Plugin Development">​</a></h2><p>To develop a control plugin for the Nacos server, you first need to depend on the relevant API of the control plugin.</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.alibaba.nacos</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">nacos-control-plugin</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">${project.version}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>${project.version}</code> is the Nacos version, at least <code>2.3.0</code>.</p><p>Then to extend <code>com.alibaba.nacos.plugin.control.connection.ConnectionControlManager</code> abstract class and <code>com.alibaba.nacos.plugin.control.tps.TpsControlManager</code>abstract class，implement their methods; Then implement <code>com.alibaba.nacos.plugin.control.spi.ControlManagerBuilder</code> interface to build the two above classes; Finally add the SPI file to <code>META-INF/services</code>.</p><p><code>com.alibaba.nacos.plugin.control.connection.ConnectionControlManager</code> need implement follow methods:</p><table><thead><tr><th>Method name</th><th>Parameters</th><th>Return</th><th>Description</th></tr></thead><tbody><tr><td>applyConnectionLimitRule</td><td>ConnectionControlRule</td><td>void</td><td>Apply new connection limit rule</td></tr><tr><td>check</td><td>ConnectionCheckRequest</td><td>ConnectionCheckResponse</td><td>To determine if the connection count rule is hit, if the success field in the ConnectionCheckResponse is <code>false</code>, new connections will be rejected.</td></tr></tbody></table><p><code>com.alibaba.nacos.plugin.control.tps.TpsControlManager</code> need implement follow methods:</p><table><thead><tr><th>Method name</th><th>Parameters</th><th>Return</th><th>Description</th></tr></thead><tbody><tr><td>registerTpsPoint</td><td>String</td><td>void</td><td>Registers a TPS control point. The Nacos server will register the current TPS control point to the plugin during startup. The input parameter is the name of the TPS control point. Please refer to the document for <a href="#1.1">point names</a>. The plugin needs to maintain a TpsBarrier within this method to record TPS and rule content. For more details, refer to <a href="#1.2">Custom Time Windows for TPS</a>.</td></tr><tr><td>applyTpsRule</td><td>String, TpsControlRule</td><td>void</td><td>Applies a new TPS rule and associates it with the TPS control point name for update.</td></tr><tr><td>check</td><td>TpsCheckRequest</td><td>TpsCheckResponse</td><td>Checks if the TPS rule is hit. If the success field in the TpsCheckResponse is false, new requests will be rejected.</td></tr></tbody></table><p><code>com.alibaba.nacos.plugin.control.spi.ControlManagerBuilder</code> need implement follow methods:</p><table><thead><tr><th>Method name</th><th>Parameters</th><th>Return</th><th>Description</th></tr></thead><tbody><tr><td>getName</td><td>void</td><td>String</td><td>Returns the name of the plugin. It is used to match the specified type in the configuration file and use the matched plugin.</td></tr><tr><td>buildConnectionControlManager</td><td>void</td><td>ConnectionControlManager</td><td>Creates an implementation of <code>ConnectionControlManager</code> for the plugin. When it is null, the <code>no limit</code> implementation will be used.</td></tr><tr><td>buildTpsControlManager</td><td>void</td><td>TpsControlManager</td><td>Creates an implementation of <code>TpsControlManager</code> for the plugin. When it is null, the <code>no limit</code> implementation will be used.</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="load-plugin">Load Plugin<a href="#load-plugin" class="hash-link" aria-label="Direct link to Load Plugin" title="Direct link to Load Plugin">​</a></h3><p>After the plugin finished, it needs to be packaged into jar/zip and places in the classpath of the nacos server. If you don&#x27;t know how to add plugins into the classpath, please place plugins under <code>${nacos-server.path}/plugins</code> directly.</p><p>After Adding plugins into classpath, also need to modify some configuration in <code>${nacos-server.path}/conf/application.properties</code>.</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">### The name of the control plugin enabled in Nacos, corresponding to the return value of com.alibaba.nacos.plugin.control.spi.ControlManagerBuilder&#x27;s getName method.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nacos.plugin.control.manager.type=${controlPluginName}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After restarting the Nacos cluster and completing the startup, you can see the following logs in <code>${nacos-server.path}/logs/plugin-control.log</code>:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Found control manager plugin of name=${controlPluginName}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Build connection control manager, class=${your plugin ConnectionControlManager class}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Build tps control manager, class=${your plugin TpsControlManager class}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="use-the-default-nacos-control-plugin">Use the default Nacos Control Plugin<a href="#use-the-default-nacos-control-plugin" class="hash-link" aria-label="Direct link to Use the default Nacos Control Plugin" title="Direct link to Use the default Nacos Control Plugin">​</a></h2><p>Starting from version 2.3.0, Nacos comes with a built-in simple control plugin implementation, which can limit the connection count and specified interface TPS of the Nacos server.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enable-the-default-nacos-control-plugin">Enable the default Nacos Control Plugin<a href="#enable-the-default-nacos-control-plugin" class="hash-link" aria-label="Direct link to Enable the default Nacos Control Plugin" title="Direct link to Enable the default Nacos Control Plugin">​</a></h3><p>Modify the following configurations in <code>${nacos-server.path}/conf/application.properties</code>:</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nacos.plugin.control.manager.type=nacos</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-control-plugin-for-default-nacos-control-plugin">Setting control plugin for default Nacos control plugin<a href="#setting-control-plugin-for-default-nacos-control-plugin" class="hash-link" aria-label="Direct link to Setting control plugin for default Nacos control plugin" title="Direct link to Setting control plugin for default Nacos control plugin">​</a></h3><p>You can modify and set control rules by creating and modifying the control rule file. By default, the rules for the control plugin are defined in JSON format.</p><p>For example, if you want to set the connection limit to 100, you can perform the following steps:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p </span><span class="token variable" style="color:#36acaa">${nacos.home}</span><span class="token plain">/data/connection/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{&quot;countLimit&quot;: 100}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${nacos.home}</span><span class="token plain">/data/connection/limitRule</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then restart Nacos server node.</p><p>What&#x27;s more, if you want set the TPS of query config as 100, you can perform the following steps:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p </span><span class="token variable" style="color:#36acaa">${nacos.home}</span><span class="token plain">/data/tps/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ConfigQuery is the PointName of the query config API.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;{&quot;pointName&quot;:&quot;ConfigQuery&quot;,&quot;pointRule&quot;:{&quot;maxCount&quot;:100,&quot;monitorType&quot;:&quot;intercept&quot;}}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">${nacos.home}</span><span class="token plain">/data/tps/ConfigQuery </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then restart Nacos server node.</p><p>More control rules and control point names please move to <a href="#1.1">point names</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-storage-dir-of-control-rules">The Storage Dir of Control Rules<a href="#the-storage-dir-of-control-rules" class="hash-link" aria-label="Direct link to The Storage Dir of Control Rules" title="Direct link to The Storage Dir of Control Rules">​</a></h3><p>The built-in simple control plugin implementation in Nacos stores and reads control rules through the local file system. By default, the rules are stored in <code>${nacos.home}/data/connection</code> and <code>${nacos.home}/data/tps</code> directories.</p><p>If you want to change the directory for storing the rule files, you can modify the following configuration in <code>${nacos-server.path}/conf/application.properties</code>:</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nacos.plugin.control.rule.local.basedir=${expectedDir}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this way, the control rules will be stored in <code>${expectedDir}/data/connection</code> and <code>${expectedDir}/data/tps</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1.1"><a href="#1.1" class="hash-link" aria-label="Direct link to 1.1" title="Direct link to 1.1">​</a></h4><h2 class="anchor anchorWithStickyNavbar_LWe7" id="supported-control-pointnames">Supported Control PointNames<a href="#supported-control-pointnames" class="hash-link" aria-label="Direct link to Supported Control PointNames" title="Direct link to Supported Control PointNames">​</a></h2><table><thead><tr><th>control pointNames</th><th>meaning</th><th>description</th><th>started version</th></tr></thead><tbody><tr><td>connection</td><td>Total Connections</td><td>Maximum Supported Connection Limit for a Specific Node</td><td>2.3.0</td></tr><tr><td>ConfigPublish</td><td>Configuration Publish Interface TPS</td><td>Maximum Supported TPS Limit for Configuration Publishing on a Specific Node, including both HTTP and gRPC access sources</td><td>2.3.0</td></tr><tr><td>ConfigQuery</td><td>Configuration Query Interface TPS</td><td>Maximum Supported TPS Limit for Configuration Querying on a Specific Node, including both HTTP and gRPC access sources</td><td>2.3.0</td></tr><tr><td>ConfigRemove</td><td>Configuration Removal Interface TPS</td><td>Maximum Supported TPS Limit for Configuration Removal on a Specific Node, including both HTTP and gRPC access sources</td><td>2.3.0</td></tr><tr><td>ConfigListen</td><td>Configuration Listening Interface TPS</td><td>Maximum Supported TPS Limit for Configuration Listening on a Specific Node, only including gRPC access source</td><td>2.3.0</td></tr><tr><td>RemoteNamingInstanceRegisterDeregister</td><td>Remote Naming Instance Register and Deregister Interface TPS</td><td>TPS Limit for Registering or Deregistering Service Instances, only including gRPC access source</td><td>2.3.0</td></tr><tr><td>RemoteNamingInstanceBatchRegister</td><td>Remote Naming Instance Batch Register Interface TPS</td><td>TPS Limit for Batch Registering Service Instances, only including gRPC access source</td><td>2.3.0</td></tr><tr><td>RemoteNamingServiceListQuery</td><td>Remote Naming Service List Query Interface TPS</td><td>TPS Limit for Service List Query, only including gRPC access source</td><td>2.3.0</td></tr><tr><td>RemoteNamingServiceQuery</td><td>Remote Naming Service Query Interface TPS</td><td>TPS Limit for Service Query, only including gRPC access source</td><td>2.3.0</td></tr><tr><td>RemoteNamingServiceSubscribeUnSubscribe</td><td>Remote Naming Service Subscribe and Unsubscribe Interface TPS</td><td>TPS Limit for Service Subscribe and Unsubscribe, only including gRPC access source</td><td>2.3.0</td></tr><tr><td>NamingInstanceRegister</td><td>Naming Instance Register Interface TPS</td><td>TPS Limit for Registering Service Instances, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingInstanceDeregister</td><td>Naming Instance Deregister Interface TPS</td><td>TPS Limit for Deregistering Service Instances, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingInstanceUpdate</td><td>Naming Instance Metadata Update Interface TPS</td><td>TPS Limit for Updating Service Instance Metadata, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingInstanceMetadataUpdate</td><td>Naming Instance Batch Metadata Update Interface TPS</td><td>TPS Limit for Batch Updating Service Instance Metadata, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingServiceSubscribe</td><td>Naming Service Query and Subscribe Interface TPS</td><td>TPS Limit for Service Query and Subscribe, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingInstanceQuery</td><td>Single Service Instance Query Interface TPS</td><td>TPS Limit for Querying Single Service Instance, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>HttpHealthCheck</td><td>Service Instance Heartbeat Renewal Interface TPS</td><td>TPS Limit for Service Instance Heartbeat Renewal, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingServiceRegister</td><td>Service Create Interface TPS</td><td>TPS Limit for Creating Services, different from <code>NamingInstanceRegister</code>, this monitoring point represents the TPS for the interface of creating an empty service, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingServiceDeregister</td><td>Service Delete Interface TPS</td><td>TPS Limit for Deleting Services, different from <code>NamingInstanceDeregister</code>, this monitoring point represents the TPS for the interface of deleting services, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingServiceQuery</td><td>Service Query Interface TPS</td><td>TPS Limit for Service Query, different from <code>NamingInstanceQuery</code>, this monitoring point represents the TPS for the interface of querying service information, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingServiceListQuery</td><td>Service List Query Interface TPS</td><td>TPS Limit for Service List Query, different from <code>NamingServiceSubscribe</code>, this monitoring point represents the TPS for the interface of service list query, only including HTTP access source</td><td>2.3.0</td></tr><tr><td>NamingServiceUpdate</td><td>Service Metadata Update Interface TPS</td><td>TPS Limit for Service Metadata Update, different from <code>NamingInstanceUpdate</code>, this monitoring point represents the TPS for the interface of updating service metadata, only including HTTP access source</td><td>2.3.0</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="advanced-development">Advanced Development<a href="#advanced-development" class="hash-link" aria-label="Direct link to Advanced Development" title="Direct link to Advanced Development">​</a></h2><p>Nacos control plugin also supports advanced extensions to meet the higher requirements of developers and users in this aspect.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="external-storage-for-control-rules">External Storage for Control Rules<a href="#external-storage-for-control-rules" class="hash-link" aria-label="Direct link to External Storage for Control Rules" title="Direct link to External Storage for Control Rules">​</a></h3><p>By default, the Nacos control plugin only supports storing and modifying control rules for individual nodes through the local file system. For users with large-scale or multiple clusters, adjusting each node individually can be time-consuming and cumbersome. Additionally, in many containerized environments, there may be issues with disk mounting and persistence for the local file system.</p><p>To address these concerns, the Nacos control plugin allows the option to add an external storage for unified storage and distribution of control rules. This external storage can be implemented by the plugin itself, such as using a <code>database</code> or a <code>configuration center</code>.</p><p>To enable external storage for control rules, you need to implement the <code>com.alibaba.nacos.plugin.control.spi.ExternalRuleStorageBuilder</code> interface in your plugin development, and place the plugin jar file along with the interface implementation in the <code>${nacos-server.path}/plugins</code> directory.</p><p>After placing the plugin files, you need to modify the following configuration in <code>${nacos-server.path}/conf/application.properties</code>:</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nacos.plugin.control.rule.external.storage=${controlPluginName}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Afterwards, restart the Nacos node for the changes to take effect.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-loading-of-control-rules">Dynamic Loading of Control Rules<a href="#dynamic-loading-of-control-rules" class="hash-link" aria-label="Direct link to Dynamic Loading of Control Rules" title="Direct link to Dynamic Loading of Control Rules">​</a></h3><p>In custom plugin implementations, there are two ways to dynamically load contrl rules:</p><ol><li><p>Call the <code>com.alibaba.nacos.plugin.control.ControlManagerCenter#reloadTpsControlRule</code> method or <code>com.alibaba.nacos.plugin.control.ControlManagerCenter#reloadConnectionControlRule</code> method.</p></li><li><p>Publish a <code>ConnectionLimitRuleChangeEvent</code> or <code>TpsControlRuleChangeEvent</code> event using <code>NotifyCenter.publishEvent()</code>.</p></li></ol><p>These methods allow you to reload and update the control rules dynamically in your custom plugin implementation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="custom-format-parse-for-control-rules">Custom Format Parse for Control Rules<a href="#custom-format-parse-for-control-rules" class="hash-link" aria-label="Direct link to Custom Format Parse for Control Rules" title="Direct link to Custom Format Parse for Control Rules">​</a></h3><p>By default, Nacos uses the <code>Json</code> format as the text format for control rules. However, plugin developers can use other formats such as <code>Yaml</code> or other custom formats for parsing.</p><p>To use a custom format for rule parsing, you can override the <code>com.alibaba.nacos.plugin.control.connection.ConnectionControlManager#buildConnectionControlRuleParser</code> and <code>com.alibaba.nacos.plugin.control.tps.TpsControlManager#buildTpsControlRuleParser</code> methods. Implement a custom format rule parser by creating a <code>RuleParser</code> that can parse rules in your desired format. Nacos will then use this custom rule parser to parse the rule text.</p><p>Additionally, you can enhance the default custom rules by parsing them into more advanced rules. This can be done in combination with the custom logic of your plugin, allowing for more advanced control.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="1.2"><a href="#1.2" class="hash-link" aria-label="Direct link to 1.2" title="Direct link to 1.2">​</a></h4><h3 class="anchor anchorWithStickyNavbar_LWe7" id="custom-time-windows-for-tps">Custom Time Windows for TPS<a href="#custom-time-windows-for-tps" class="hash-link" aria-label="Direct link to Custom Time Windows for TPS" title="Direct link to Custom Time Windows for TPS">​</a></h3><p>It is well-known that different time window algorithms can lead to significant differences in TPS statistics. Nacos defaults to a simple per-second statistical method, where TPS is counted based on clock seconds. This is sufficient for most scenarios, but for users with higher accuracy requirements, more precise methods such as sliding windows may be needed for TPS statistics.</p><p>In such cases, plugin developers can customize the time window and statistical methods for TPS by inheriting from <code>com.alibaba.nacos.plugin.control.tps.barrier.TpsBarrier</code> and <code>com.alibaba.nacos.plugin.control.tps.barrier.RuleBarrier</code>. Additionally, the <code>com.alibaba.nacos.plugin.control.tps.TpsControlManager#buildTpsBarrierCreator</code> method needs to be overridden. This allows for the generation of the corresponding custom implementation during plugin initialization and dynamic loading of control rules.</p><p>By implementing these customizations, plugin developers can control the time window and statistical methods used for TPS in a way that meets the specific accuracy requirements of their users.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#concepts-in-control-plugin" class="table-of-contents__link toc-highlight">Concepts in Control Plugin</a><ul><li><a href="#control-point" class="table-of-contents__link toc-highlight">Control Point</a></li><li><a href="#control-rule" class="table-of-contents__link toc-highlight">Control Rule</a></li></ul></li><li><a href="#plugin-development" class="table-of-contents__link toc-highlight">Plugin Development</a><ul><li><a href="#load-plugin" class="table-of-contents__link toc-highlight">Load Plugin</a></li></ul></li><li><a href="#use-the-default-nacos-control-plugin" class="table-of-contents__link toc-highlight">Use the default Nacos Control Plugin</a><ul><li><a href="#enable-the-default-nacos-control-plugin" class="table-of-contents__link toc-highlight">Enable the default Nacos Control Plugin</a></li><li><a href="#setting-control-plugin-for-default-nacos-control-plugin" class="table-of-contents__link toc-highlight">Setting control plugin for default Nacos control plugin</a></li><li><a href="#the-storage-dir-of-control-rules" class="table-of-contents__link toc-highlight">The Storage Dir of Control Rules</a></li></ul></li><li><a href="#supported-control-pointnames" class="table-of-contents__link toc-highlight">Supported Control PointNames</a></li><li><a href="#advanced-development" class="table-of-contents__link toc-highlight">Advanced Development</a><ul><li><a href="#external-storage-for-control-rules" class="table-of-contents__link toc-highlight">External Storage for Control Rules</a></li><li><a href="#dynamic-loading-of-control-rules" class="table-of-contents__link toc-highlight">Dynamic Loading of Control Rules</a></li><li><a href="#custom-format-parse-for-control-rules" class="table-of-contents__link toc-highlight">Custom Format Parse for Control Rules</a></li><li><a href="#custom-time-windows-for-tps" class="table-of-contents__link toc-highlight">Custom Time Windows for TPS</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/en/assets/js/runtime~main.2c7479d0.js"></script>
<script src="/en/assets/js/main.ffb142c1.js"></script>
</body>
</html>