{
  "filename": "namespace-endpoint-best-practices.md",
  "__html": "<h1>Namespace, endpoint 最佳实践</h1>\n<p>随着使用 Nacos 的企业越来越多，遇到的最频繁的两个问题就是：如何在我的生产环境正确的来使用 namespace 以及 endpoint。这篇文章主要就是针对这两个问题来聊聊使用 nacos 过程中关于这两个参数配置的最佳实践方式。</p>\n<h2>namespce</h2>\n<p>关于 namespace ，以下主要从 <strong>namespace 的设计背景</strong> 和 <strong>namespace 的最佳实践</strong> 两个方面来讨论。</p>\n<h3>namespace 的设计背景</h3>\n<p>namespace 的设计是 nacos 基于此做多环境以及多租户数据(<strong>配置和服务</strong>)隔离的。即：</p>\n<ul>\n<li>从一个租户(用户)的角度来看，如果有多套不同的环境，那么这个时候可以根据指定的环境来创建不同的 namespce，以此来实现多环境的隔离。例如，你可能有日常，预发和生产三个不同的环境，那么使用一套 nacos 集群可以分别建以下三个不同的 namespace。如下图所示：</li>\n</ul>\n<p><img src=\"http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/pictures/nacos_ingle_tenant_namespace.jpg\" alt=\"\"></p>\n<ul>\n<li>从多个租户(用户)的角度来看，每个租户(用户)可能会有自己的 namespace,每个租户(用户)的配置数据以及注册的服务数据都会归属到自己的 namespace 下，以此来实现多租户间的数据隔离。例如超级管理员分配了三个租户，分别为张三、李四和王五。分配好了之后，各租户用自己的账户名和密码登录后，创建自己的命名空间。如下图所示：</li>\n</ul>\n<p><img src=\"http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/pictures/nacos_multi_tenant_namespace.jpg\" alt=\"\"></p>\n<p><strong>注意:</strong> 该功能还在规划中。</p>\n<h3>namespace 的最佳实践</h3>\n<p>关于 namespace 的最佳实践，这部分主要包含有两个 Action：</p>\n<ul>\n<li>如何来获取 namespace 的值</li>\n<li>namespace 参数初始化方式</li>\n</ul>\n<h3>如何来获取 namespace 的值</h3>\n<p>无论您是基于 Spring Cloud 或者 Dubbo 来使用 nacos，都会涉及到 namespace 的参数输入，那么这个时候 namespace 的值从哪里可以获取呢？</p>\n<ol>\n<li>\n<p>如果您在使用过程中没有感知到这个参数的输入，那么 nacos 统一会使用一个默认的 namespace 作为输入，nacos naming 会使用 <strong>public</strong> 作为默认的参数来初始化，nacos config 会使用一个<strong>空字符串</strong>作为默认的参数来初始化。</p>\n</li>\n<li>\n<p>如果您需要自定义自己的 namespace，那么这个值该怎么来产生？</p>\n<p>可以在 nacos 的控制台左边功能侧看到有一个 <strong>命名空间</strong> 的功能，点击就可以看到 <strong>新建命名空间</strong> 的按钮，那么这个时候就可以创建自己的命名空间了。创建成功之后，会生成一个<strong>命名空间ID</strong>，主要是用来避免<strong>命名空间名称</strong>有可能会出现重名的情况。因此当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间ID</strong>。重要的事情说三遍：</p>\n<ol>\n<li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li>\n<li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li>\n<li>当您在应用中需要配置指定的 namespace 时，<strong>填入的是命名空间 ID</strong></li>\n</ol>\n</li>\n</ol>\n<p>说明: namesace 为 <strong>public</strong> 是 nacos 的一个保留控件，如果您需要创建自己的 namespace，最好不要和 <strong>public</strong> 重名，以一个实际业务场景有具体语义的名字来命名，以免带来字面上不容易区分自己是哪一个 namespace。</p>\n<h3>namespace 参数初始化方式</h3>\n<p>nacos client 对 namespace 的初始化流程如下图所示:</p>\n<p><img src=\"http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/nacos/nacos_namespace.jpg\" alt=\"\"></p>\n<p>nacos client 对 namespace 的初始化，主要包含两部分：</p>\n<ul>\n<li>\n<p>用户态通过 nacos client 构造实例时通过 properties 参数传入的 namespace。</p>\n</li>\n<li>\n<p>在云环境下(<strong>阿里云下的 EDAS</strong>)的 namespace 参数解析。</p>\n<p>可通过 <strong>-Dnacos.use.cloud.namespace.parsing=true/false</strong> 来控制是否需要在云环境自动解析 namespace 参数，默认为 <strong>true</strong>，是会自动解析，其目的就是方便用户上云时可以以零成本的方式平滑上云。如果用户在云上需要用自建的 nacos 下的 namespace，那这个时候只需将 <strong>-Dnacos.use.cloud.namespace.parsing=false</strong> 即可。</p>\n</li>\n</ul>\n<h2>endpoint</h2>\n<p>关于 endpoint ，也主要从 <strong>endpoint 的设计背景</strong> 和 <strong>endpoint 的参数初始化</strong> 两个方面来讨论。</p>\n<h3>endpoint 的设计背景</h3>\n<p>当 nacos server 集群需要扩缩容时，客户端需要有一种能力能够及时感知到集群发生变化。及时感知到集群的变化是通过 endpoint 来实现的。也即客户端会定时的向 endpoint 发送请求来更新客户端内存中的集群列表。</p>\n<h3>endpoint 的参数初始化</h3>\n<p>Nacos Client 提供一种可以对传入的 endpoint 参数规则解析的能力。即当通过构造函数的 <strong>properties</strong> 来初始化 endpoint 时，指定的 endpoint 值可以是一个具体的值，也可以是一个占位符的形式，如下所示:</p>\n<blockquote>\n<p><strong>${endpoint.options:defaultValue}</strong>。</p>\n</blockquote>\n<p>说明：</p>\n<ol>\n<li><strong>endpoint.options</strong> 是一个具体的变量。支持从系统属性，系统环境变量中读取。</li>\n<li><strong>defaultValue</strong> 是给出的一个默认值。当从具体的变量中没有被正确初始化时，会使用给出的默认值来初始化。</li>\n</ol>\n<p>整个 endpoint 的解析规则比较复杂，整体的一个解析流程图如下所示:</p>\n<p><img src=\"http://edas.oss-cn-hangzhou.aliyuncs.com/deshao/nacos/nacos_endpoint.jpg\" alt=\"\"></p>\n<p><strong>注意：</strong> 蓝色特别区分的是支持云环境下(阿里云上的 EDAS)自动从系统环境变量中来读取 endpoint 值，以此来达到用户本地开发或者将应用往云上迁移的时候以零成本的改造方式实现平滑上云。</p>\n<p>说明：</p>\n<ul>\n<li>\n<p>开启 endpoint 参数规则解析</p>\n<ol>\n<li>\n<p>如果在初始化 Nacos Client 的时候，没有通过 properties 来指定 endpoint，这个时候会从系统环境变量中变量名为 <strong>ALIBABA_ALIWARE_ENDPOINT_URL</strong> 指定的值来初始化，如果系统环境变量也没有设置，那么这个时候将会返回一个空字符串。</p>\n</li>\n<li>\n<p>如果设置了 endpoint，</p>\n<ol>\n<li>\n<p>设置的 endpoint 是一个指定具体的值。</p>\n<p>这时会先从系统环境变量中变量名为 <strong>ALIBABA_ALIWARE_ENDPOINT_URL</strong> 指定的值来初始化，如果系统环境变量没有设置，那么这个时候用用户态传入的具体值来初始化 endpoint。</p>\n</li>\n<li>\n<p>以占位符的形式输入。</p>\n<p>这时会解析出具体占位符的值，然后:</p>\n<ol>\n<li>\n<p>依次从系统属性和环境变量中来取值。</p>\n<p>例如，您输入的是 <strong>${nacos.endpoint:defaultValue}</strong>，那么解析出来的占位符是 <strong>nacos.endpoint</strong>。解析出来后，会先读取系统属性中(<strong>即 System.getProperty(&quot;nacos.endpoint&quot;)</strong>)是否设置了 <strong>nacos.endpoint</strong> 变量值，如果没有，则会从系统环境变量中变量名为 <strong>nacos.endpoint</strong> 指定的值来初始化。</p>\n</li>\n<li>\n<p>如果通过解析出来的占位符还没有正确初始化 endpoint，则会从系统环境变量中变量名为 <strong>ALIBABA_ALIWARE_ENDPOINT_URL</strong> 指定的值来初始化。</p>\n</li>\n<li>\n<p>如果经过以上两步还没有被初始化，这时如果您设置了默认值，这个时候就会使用默认值来初始化 endpoint，否则的话以解析出来的占位符返回。</p>\n</li>\n</ol>\n</li>\n</ol>\n</li>\n</ol>\n</li>\n<li>\n<p>关闭 endpoint 参数规则解析</p>\n<p>当关闭了 endpoint 参数规则解析的时候，这个时候就以用户态在构造 Nacos Client 时通过 properties 参数输入的 endpoint 值为主。</p>\n</li>\n</ul>\n<p>默认情况下， Nacos Client 是开启 endpoint 参数规则解析的能力。如果你想关闭该能力，有两种方式可以帮您来实现。</p>\n<ol>\n<li>可在 Nacos Client 初始化的时候在传入的 properties 实例中指定 key 为 <strong>isUseEndpointParsingRule</strong>，值为 <strong>false</strong> 即可关闭。</li>\n<li>如果您的应用是 Java 程序的应用，也可以通过 <strong>-Dnacos.use.endpoint.parsing.rule=false</strong> 来关闭。</li>\n</ol>\n<p><strong>注意</strong>：其中第一种方式的优先级高于第二种方式。</p>\n",
  "link": "/en-us/blog/namespace-endpoint-best-practices.html",
  "meta": {
    "title": "Namespace,endpoint 最佳实践",
    "keywords": "namespace,endpoint,最佳实践",
    "description": "随着使用 Nacos 的企业越来越多，遇到的最频繁的两个问题就是：如何在我的生产环境正确的来使用 namespace 以及 endpoint。"
  }
}