{
  "filename": "use-nacos-with-kubernetes.md",
  "__html": "<h1>Kubernetes Nacos</h1>\n<p>This project contains a Nacos Docker image meant to facilitate the deployment of <a href=\"https://nacos.io\">Nacos</a> on <a href=\"https://kubernetes.io/\">Kubernetes</a> via StatefulSets.</p>\n<h1>Quick Start</h1>\n<ul>\n<li><strong>Clone Project</strong></li>\n</ul>\n<pre><code class=\"language-shell\">git clone https://github.com/nacos-group/nacos-k8s.git\n</code></pre>\n<ul>\n<li><strong>Simple Start</strong></li>\n</ul>\n<blockquote>\n<p>If you want to start Nacos without NFS, but <strong>emptyDirs will possibly result in a loss of data</strong>. as follows:</p>\n</blockquote>\n<pre><code class=\"language-shell\">cd nacos-k8s\nchmod +x quick-startup.sh\n./quick-startup.sh\n</code></pre>\n<ul>\n<li>\n<p><strong>Testing</strong></p>\n<ul>\n<li><strong>Service registration</strong></li>\n</ul>\n<pre><code class=\"language-powershell\">curl <span class=\"hljs-literal\">-X</span> PUT <span class=\"hljs-string\">'http://cluster-ip:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span>\n</code></pre>\n<ul>\n<li><strong>Service discovery</strong></li>\n</ul>\n<pre><code class=\"language-powershell\">curl <span class=\"hljs-literal\">-X</span> GET <span class=\"hljs-string\">'http://cluster-ip:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName'</span>\n</code></pre>\n<ul>\n<li><strong>Publish config</strong></li>\n</ul>\n<pre><code class=\"language-powershell\">curl <span class=\"hljs-literal\">-X</span> POST <span class=\"hljs-string\">\"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld\"</span>\n</code></pre>\n<ul>\n<li><strong>Get config</strong></li>\n</ul>\n<pre><code class=\"language-powershell\">curl <span class=\"hljs-literal\">-X</span> GET <span class=\"hljs-string\">\"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test\"</span>\n</code></pre>\n</li>\n</ul>\n<h1>Advanced</h1>\n<blockquote>\n<p>In advanced use, the cluster is automatically scaled and data is persisted, but <a href=\"https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims\">PersistentVolumeClaims</a> must be deployed. In this example, NFS is used.</p>\n</blockquote>\n<h2>Deploy NFS</h2>\n<ul>\n<li>Create Role</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/rbac.yaml\n</code></pre>\n<blockquote>\n<p>If your K8S namespace is not default, execute the following script before creating RBAC</p>\n</blockquote>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">#</span><span class=\"bash\"> Set the subject of the RBAC objects to the current namespace <span class=\"hljs-built_in\">where</span> the provisioner is being deployed</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> NS=$(kubectl config get-contexts|grep -e <span class=\"hljs-string\">\"^\\*\"</span> |awk <span class=\"hljs-string\">'{print $5}'</span>)</span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> NAMESPACE=<span class=\"hljs-variable\">${NS:-default}</span></span>\n<span class=\"hljs-meta\">$</span><span class=\"bash\"> sed -i<span class=\"hljs-string\">''</span> <span class=\"hljs-string\">\"s/namespace:.*/namespace: <span class=\"hljs-variable\">$NAMESPACE</span>/g\"</span> ./deploy/nfs/rbac.yaml</span>\n\n</code></pre>\n<ul>\n<li>Create <code>ServiceAccount</code> And deploy <code>NFS-Client Provisioner</code></li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/deployment.yaml\n</code></pre>\n<ul>\n<li>Create NFS StorageClass</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f deploy/nfs/class.yaml\n</code></pre>\n<ul>\n<li>Verify that NFS is working</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl get pod -l app=nfs-client-provisioner\n</code></pre>\n<h2>Deploy database</h2>\n<ul>\n<li>Deploy master</li>\n</ul>\n<pre><code class=\"language-shell\">\ncd nacos-k8s\n\nkubectl create -f deploy/mysql/mysql-master-nfs.yaml\n</code></pre>\n<ul>\n<li>Deploy slave</li>\n</ul>\n<pre><code class=\"language-shell\">\ncd nacos-k8s \n\nkubectl create -f deploy/mysql/mysql-slave-nfs.yaml\n</code></pre>\n<ul>\n<li>Verify that Database is working</li>\n</ul>\n<pre><code class=\"language-shell\"><span class=\"hljs-meta\">#</span><span class=\"bash\"> master</span>\nkubectl get pod \nNAME                         READY   STATUS    RESTARTS   AGE\nmysql-master-gf2vd                        1/1     Running   0          111m\n<span class=\"hljs-meta\">\n#</span><span class=\"bash\"> slave</span>\nkubectl get pod \nmysql-slave-kf9cb                         1/1     Running   0          110m\n</code></pre>\n<h2>Deploy Nacos</h2>\n<ul>\n<li>Modify  <strong>deploy/nacos/nacos-pvc-nfs.yaml</strong></li>\n</ul>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">data:</span>\n  <span class=\"hljs-attr\">mysql.master.db.name:</span> <span class=\"hljs-string\">\"db name\"</span>\n  <span class=\"hljs-attr\">mysql.master.port:</span> <span class=\"hljs-string\">\"master db port\"</span>\n  <span class=\"hljs-attr\">mysql.slave.port:</span> <span class=\"hljs-string\">\"slave db port\"</span>\n  <span class=\"hljs-attr\">mysql.master.user:</span> <span class=\"hljs-string\">\"master db username\"</span>\n  <span class=\"hljs-attr\">mysql.master.password:</span> <span class=\"hljs-string\">\"master db password\"</span>\n</code></pre>\n<ul>\n<li>Create Nacos</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl create -f nacos-k8s/deploy/nacos/nacos-pvc-nfs.yaml\n</code></pre>\n<ul>\n<li>Verify that Nacos is working</li>\n</ul>\n<pre><code class=\"language-shell\">kubectl get pod -l app=nacos\n\n\nNAME      READY   STATUS    RESTARTS   AGE\nnacos-0   1/1     Running   0          19h\nnacos-1   1/1     Running   0          19h\nnacos-2   1/1     Running   0          19h\n</code></pre>\n<h2>Scale Testing</h2>\n<ul>\n<li>Use <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a> to get the cluster config of the Pods in the <code>nacos</code> StatefulSet.</li>\n</ul>\n<pre><code class=\"language-powershell\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-number\">0</span> <span class=\"hljs-number\">1</span>; <span class=\"hljs-keyword\">do</span> echo nacos-<span class=\"hljs-variable\">$i</span>; kubectl exec nacos-<span class=\"hljs-variable\">$i</span> cat conf/cluster.conf; done\n</code></pre>\n<p>The StatefulSet controller provides each Pod with a unique hostname based on its ordinal index. The hostnames take the form of <code>&lt;statefulset name&gt;-&lt;ordinal index&gt;</code>. Because the <code>replicas</code> field of the <code>nacos</code> StatefulSet is set to <code>2</code>, In the cluster file only two nacos address</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2019/gif/338441/1562846123635-e361d2b5-4bbe-4347-acad-8f11f75e6d38.gif\" alt=\"k8s\"></p>\n<ul>\n<li>Use kubectl to scale StatefulSets</li>\n</ul>\n<pre><code class=\"language-bash\">kubectl scale sts nacos --replicas=3\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2019/gif/338441/1562846139093-7a79b709-9afa-448a-b7d6-f57571d3a902.gif\" alt=\"scale\"></p>\n<ul>\n<li>Use <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a> to get the cluster config of the Pods in the <code>nacos</code> StatefulSet after scale StatefulSets</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> 0 1 2; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> nacos-<span class=\"hljs-variable\">$i</span>; kubectl <span class=\"hljs-built_in\">exec</span> nacos-<span class=\"hljs-variable\">$i</span> cat conf/cluster.conf; <span class=\"hljs-keyword\">done</span>\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2019/gif/338441/1562846177553-c1c7f379-1b41-4026-9f0b-23e15dde02a8.gif\" alt=\"get_cluster_after\"></p>\n<ul>\n<li>Use <a href=\"https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec\"><code>kubectl exec</code></a> to get the <strong>state</strong> of the Pods in the <code>nacos</code> StatefulSet after scale StatefulSets</li>\n</ul>\n<pre><code class=\"language-bash\"><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> 0 1 2; <span class=\"hljs-keyword\">do</span> <span class=\"hljs-built_in\">echo</span> nacos-<span class=\"hljs-variable\">$i</span>; kubectl <span class=\"hljs-built_in\">exec</span> nacos-<span class=\"hljs-variable\">$i</span> curl -X GET <span class=\"hljs-string\">\"http://localhost:8848/nacos/v1/ns/raft/state\"</span>; <span class=\"hljs-keyword\">done</span>\n</code></pre>\n<p>You can find that the new node has joined the cluster</p>\n<h1>Prerequisites</h1>\n<ul>\n<li>Kubernetes Node configuration(for reference only)</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Network IP</th>\n<th>Hostname</th>\n<th>Configuration</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>172.17.79.3</td>\n<td>k8s-master</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n<tr>\n<td>172.17.79.4</td>\n<td>node01</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n<tr>\n<td>172.17.79.5</td>\n<td>node02</td>\n<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>Kubernetes version：<strong>1.12.2+</strong></li>\n<li>NFS version：<strong>4.1+</strong></li>\n</ul>\n<h1>Limitations</h1>\n<ul>\n<li>Persistent Volumes must be used. emptyDirs will possibly result in a loss of data</li>\n</ul>\n<h1>Project directory</h1>\n<table>\n<thead>\n<tr>\n<th>Directory Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>plugin</code></td>\n<td>Help Nacos cluster achieve automatic scaling in K8s</td>\n</tr>\n<tr>\n<td><code>deploy</code></td>\n<td>Deploy the required files</td>\n</tr>\n</tbody>\n</table>\n<h1>Configuration properties</h1>\n<ul>\n<li>nacos-pvc-nfs.yaml or nacos-quick-start.yaml</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Required</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>mysql.master.db.name</code></td>\n<td>Y</td>\n<td>Master database name</td>\n</tr>\n<tr>\n<td><code>mysql.master.port</code></td>\n<td>N</td>\n<td>Master database port</td>\n</tr>\n<tr>\n<td><code>mysql.slave.port</code></td>\n<td>N</td>\n<td>Slave database port</td>\n</tr>\n<tr>\n<td><code>mysql.master.user</code></td>\n<td>Y</td>\n<td>Master database username</td>\n</tr>\n<tr>\n<td><code>mysql.master.password</code></td>\n<td>Y</td>\n<td>Master database password</td>\n</tr>\n<tr>\n<td><code>NACOS_REPLICAS</code></td>\n<td>Y</td>\n<td>The number of clusters must be consistent with the value of the replicas attribute</td>\n</tr>\n<tr>\n<td><code>NACOS_SERVER_PORT</code></td>\n<td>N</td>\n<td>Nacos port,default:8848</td>\n</tr>\n<tr>\n<td><code>PREFER_HOST_MODE</code></td>\n<td>Y</td>\n<td>Enable Nacos cluster node domain name support</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>nfs</strong> deployment.yaml</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Required</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>NFS_SERVER</code></td>\n<td>Y</td>\n<td>NFS server address</td>\n</tr>\n<tr>\n<td><code>NFS_PATH</code></td>\n<td>Y</td>\n<td>NFS server shared directory</td>\n</tr>\n<tr>\n<td><code>server</code></td>\n<td>Y</td>\n<td>NFS server address</td>\n</tr>\n<tr>\n<td><code>path</code></td>\n<td>Y</td>\n<td>NFS server shared directory</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>mysql yaml</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Required</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>MYSQL_ROOT_PASSWORD</code></td>\n<td>N</td>\n<td>Root password</td>\n</tr>\n<tr>\n<td><code>MYSQL_DATABASE</code></td>\n<td>Y</td>\n<td>Database Name</td>\n</tr>\n<tr>\n<td><code>MYSQL_USER</code></td>\n<td>Y</td>\n<td>Database Username</td>\n</tr>\n<tr>\n<td><code>MYSQL_PASSWORD</code></td>\n<td>Y</td>\n<td>Database Password</td>\n</tr>\n<tr>\n<td><code>MYSQL_REPLICATION_USER</code></td>\n<td>Y</td>\n<td>Master-slave replication username</td>\n</tr>\n<tr>\n<td><code>MYSQL_REPLICATION_PASSWORD</code></td>\n<td>Y</td>\n<td>Master-slave replication password</td>\n</tr>\n<tr>\n<td><code>Nfs:server</code></td>\n<td>Y</td>\n<td>NFS server address</td>\n</tr>\n<tr>\n<td><code>Nfs:path</code></td>\n<td>Y</td>\n<td>NFS server shared path</td>\n</tr>\n</tbody>\n</table>\n",
  "link": "/en-us/docs/use-nacos-with-kubernetes.html",
  "meta": {
    "title": "Kubernetes Nacos",
    "keywords": "nacos,kubernetes",
    "description": "This project contains a Nacos Docker image meant to facilitate the deployment of Nacos on Kubernetes via StatefulSets."
  }
}