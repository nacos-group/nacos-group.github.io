<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="use-nacos-with-kubernetes" />
	<meta name="description" content="use-nacos-with-kubernetes" />
	<!-- 网页标签标题 -->
	<title>use-nacos-with-kubernetes</title>
	<link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/en-us/index.html"><img class="logo" src="/img/nacos_colorful.png"/></a><span class="language-switch language-switch-normal">中</span><div class="header-menu"><img class="header-menu-toggle" src="/img/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/en-us/index.html">HOME</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/en-us/docs/quick-start.html">DOCS</a></li><li class="menu-item menu-item-normal"><a href="/en-us/docs/nacos-dev.html">TEAM</a></li><li class="menu-item menu-item-normal"><a href="/en-us/blog">BLOG</a></li><li class="menu-item menu-item-normal"><a href="/en-us/community">COMMUNITY</a></li><li class="menu-item menu-item-normal"><a href="https://mp.weixin.qq.com/s/KH0dEC6cNckoq1M-siiCmg">CAMPUS</a></li><li class="menu-item menu-item-normal"><a href="http://console.nacos.io/nacos/index.html">DEMO-CONSOLE</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/docs.png" class="front-img"/><div class="bar-title"><span>Documentation</span><div class="bone bone-light"></div></div><img src="/img/docs.png" class="back-img"/></div></div><section class="content-section"><div class="content-body"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>Nacos </span><ul><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>What is Nacos<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/what-is-nacos.html" target="_self">What is Nacos</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/concepts.html" target="_self">Concepts</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/architecture.html" target="_self">Architecure</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/faq.html" target="_self">FAQ</a></li></ul></li><li style="height:324px;overflow:hidden" class="menu-item menu-item-level-2"><span>Quick Start<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/quick-start.html" target="_self">Nacos</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/quick-start-spring.html" target="_self">Nacos Spring</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/quick-start-spring-boot.html" target="_self">Nacos Spring Boot</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/quick-start-spring-cloud.html" target="_self">Nacos Spring Cloud</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/quick-start-docker.html" target="_self">Nacos Docker</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/use-nacos-with-dubbo.html" target="_self">Nacos with Dubbo</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/use-nacos-with-kubernetes.html" target="_self">Nacos with K8s</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/nacos-sync.html" target="_self">Nacos Sync</a></li></ul></li><li style="height:252px;overflow:hidden" class="menu-item menu-item-level-2"><span>User Guide<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/sdk.html" target="_self">Java SDK</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/other-language.html" target="_self">Other Language</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/open-api.html" target="_self">Open-API</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/nacos-spring.html" target="_self">Nacos Spring</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/namespace-endpoint-best-practices.html" target="_self">namespace, endpoint best practices</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/system-configurations.html" target="_self">Nacos System Configurations</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Admin Guide<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/deployment.html" target="_self">Deployment Guide</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/cluster-mode-quick-start.html" target="_self">Cluster Mode Deployment</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/management-api.html" target="_self">Management OpenAPI</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/console-guide.html" target="_self">Admin Console Guide</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/monitor-guide.html" target="_self">Nacos Monitor Guide</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/nacos-config-benchmark.html" target="_self">Nacos Config Benchmark</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/nacos-naming-benchmark.html" target="_self">Nacos Naming Benchmark</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/nacos-sync-use.html" target="_self">Data Migration to Nacos</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Contributor Guide<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/contributing.html" target="_self">Contribute to Nacos</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/activity.html" target="_self">Nacos Activity</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/pull-request.html" target="_self">Pull Request Template</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/how-to-reporting-bugs.html" target="_self">How to reporting bugs</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/roadmap.html" target="_self">Nacos RoadMap</a></li><li class="menu-item menu-item-level-3"><a href="/en-us/docs/use-nacos-with-istio.html" target="_self">Nacos with Istio</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Community<img style="transform:rotate(-90deg)" class="menu-toggle" src="/img/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/en-us/docs/community.html" target="_self">Community</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>Kubernetes Nacos</h1>
<p>本项目包含一个可构建的Nacos Docker Image,旨在利用StatefulSets在<a href="https://kubernetes.io/">Kubernetes</a>上部署<a href="https://nacos.io">Nacos</a></p>
<p><a href="https://github.com/nacos-group/nacos-k8s/blob/master/README.md">English Document</a></p>
<h1>快速开始</h1>
<ul>
<li><strong>Clone 项目</strong></li>
</ul>
<pre><code class="language-shell">git clone https://github.com/nacos-group/nacos-k8s.git
</code></pre>
<ul>
<li><strong>简单例子</strong></li>
</ul>
<blockquote>
<p>如果你使用简单方式快速启动,请注意这是没有使用持久化卷的,可能存在数据丢失风险:</p>
</blockquote>
<pre><code class="language-shell">cd nacos-k8s
chmod +x quick-startup.sh
./quick-startup.sh
</code></pre>
<ul>
<li>
<p><strong>测试</strong></p>
<ul>
<li><strong>服务注册</strong></li>
</ul>
<pre><code class="language-bash">curl -X PUT <span class="hljs-string">'http://cluster-ip:8848/nacos/v1/ns/instance?serviceName=nacos.naming.serviceName&amp;ip=20.18.7.10&amp;port=8080'</span>
</code></pre>
<ul>
<li><strong>服务发现</strong></li>
</ul>
<pre><code class="language-bash">curl -X GET <span class="hljs-string">'http://cluster-ip:8848/nacos/v1/ns/instances?serviceName=nacos.naming.serviceName'</span>
</code></pre>
<ul>
<li><strong>发布配置</strong></li>
</ul>
<pre><code class="language-bash">curl -X POST <span class="hljs-string">"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test&amp;content=helloWorld"</span>
</code></pre>
<ul>
<li><strong>获取配置</strong></li>
</ul>
<pre><code class="language-bash">curl -X GET <span class="hljs-string">"http://cluster-ip:8848/nacos/v1/cs/configs?dataId=nacos.cfg.dataId&amp;group=test"</span>
</code></pre>
</li>
</ul>
<h1>高级使用</h1>
<blockquote>
<p>在高级使用中,Nacos在K8S拥有自动扩容缩容和数据持久特性,请注意如果需要使用这部分功能请使用PVC持久卷,Nacos的自动扩容缩容需要依赖持久卷,以及数据持久化也是一样,本例中使用的是NFS来使用PVC.</p>
</blockquote>
<h2>部署 NFS</h2>
<ul>
<li>创建角色</li>
</ul>
<pre><code class="language-shell">kubectl create -f deploy/nfs/rbac.yaml
</code></pre>
<blockquote>
<p>如果的K8S命名空间不是<strong>default</strong>,请在部署RBAC之前执行以下脚本:</p>
</blockquote>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> Set the subject of the RBAC objects to the current namespace <span class="hljs-built_in">where</span> the provisioner is being deployed</span>
<span class="hljs-meta">$</span><span class="bash"> NS=$(kubectl config get-contexts|grep -e <span class="hljs-string">"^\*"</span> |awk <span class="hljs-string">'{print $5}'</span>)</span>
<span class="hljs-meta">$</span><span class="bash"> NAMESPACE=<span class="hljs-variable">${NS:-default}</span></span>
<span class="hljs-meta">$</span><span class="bash"> sed -i<span class="hljs-string">''</span> <span class="hljs-string">"s/namespace:.*/namespace: <span class="hljs-variable">$NAMESPACE</span>/g"</span> ./deploy/nfs/rbac.yaml</span>

</code></pre>
<ul>
<li>创建 <code>ServiceAccount</code> 和部署 <code>NFS-Client Provisioner</code></li>
</ul>
<pre><code class="language-shell">kubectl create -f deploy/nfs/deployment.yaml
</code></pre>
<ul>
<li>创建 NFS StorageClass</li>
</ul>
<pre><code class="language-shell">kubectl create -f deploy/nfs/class.yaml
</code></pre>
<ul>
<li>验证NFS部署成功</li>
</ul>
<pre><code class="language-shell">kubectl get pod -l app=nfs-client-provisioner
</code></pre>
<h2>部署数据库</h2>
<ul>
<li>部署主库</li>
</ul>
<pre><code class="language-shell">
cd nacos-k8s

kubectl create -f deploy/mysql/mysql-master-nfs.yaml
</code></pre>
<ul>
<li>部署从库</li>
</ul>
<pre><code class="language-shell">
cd nacos-k8s 

kubectl create -f deploy/mysql/mysql-slave-nfs.yaml
</code></pre>
<ul>
<li>验证数据库是否正常工作</li>
</ul>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> master</span>
kubectl get pod 
NAME                         READY   STATUS    RESTARTS   AGE
mysql-master-gf2vd                        1/1     Running   0          111m
<span class="hljs-meta">
#</span><span class="bash"> slave</span>
kubectl get pod 
mysql-slave-kf9cb                         1/1     Running   0          110m
</code></pre>
<h2>部署Nacos</h2>
<ul>
<li>修改  <strong>depoly/nacos/nacos-pvc-nfs.yaml</strong></li>
</ul>
<pre><code class="language-yaml"><span class="hljs-attr">data:</span>
  <span class="hljs-string">mysql.master.db.name:</span> <span class="hljs-string">"主库名称"</span>
  <span class="hljs-string">mysql.master.port:</span> <span class="hljs-string">"主库端口"</span>
  <span class="hljs-string">mysql.slave.port:</span> <span class="hljs-string">"从库端口"</span>
  <span class="hljs-string">mysql.master.user:</span> <span class="hljs-string">"主库用户名"</span>
  <span class="hljs-string">mysql.master.password:</span> <span class="hljs-string">"主库密码"</span>
</code></pre>
<ul>
<li>创建 Nacos</li>
</ul>
<pre><code class="language-shell">kubectl create -f nacos-k8s/deploy/nacos/nacos-pvc-nfs.yaml
</code></pre>
<ul>
<li>验证Nacos节点启动成功</li>
</ul>
<pre><code class="language-shell">kubectl get pod -l app=nacos


NAME      READY   STATUS    RESTARTS   AGE
nacos-0   1/1     Running   0          19h
nacos-1   1/1     Running   0          19h
nacos-2   1/1     Running   0          19h
</code></pre>
<h2>扩容测试</h2>
<ul>
<li>在扩容前,使用 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a>获取在pod中的Nacos集群配置文件信息</li>
</ul>
<pre><code class="language-powershell"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span>; <span class="hljs-keyword">do</span> echo nacos-<span class="hljs-variable">$i</span>; kubectl exec nacos-<span class="hljs-variable">$i</span> cat conf/cluster.conf; done
</code></pre>
<p>StatefulSet控制器根据其序数索引为每个Pod提供唯一的主机名。 主机名采用<statefulset name>  -  <ordinal index>的形式。 因为nacos StatefulSet的副本字段设置为2，所以当前集群文件中只有两个Nacos节点地址</p>
<p><img src="/images/k8s.gif" alt="k8s"></p>
<ul>
<li>使用kubectl scale 对Nacos动态扩容</li>
</ul>
<pre><code class="language-bash">kubectl scale sts nacos --replicas=3
</code></pre>
<p><img src="/images/scale.gif" alt="scale"></p>
<ul>
<li>在扩容后,使用 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a>获取在pod中的Nacos集群配置文件信息</li>
</ul>
<pre><code class="language-bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 0 1 2; <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> nacos-<span class="hljs-variable">$i</span>; kubectl <span class="hljs-built_in">exec</span> nacos-<span class="hljs-variable">$i</span> cat conf/cluster.conf; <span class="hljs-keyword">done</span>
</code></pre>
<p><img src="/images/get_cluster_after.gif" alt="get_cluster_after"></p>
<ul>
<li>使用 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#exec"><code>kubectl exec</code></a>执行Nacos API 在每台节点上获取当前<strong>Leader</strong>是否一致</li>
</ul>
<pre><code class="language-bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 0 1 2; <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> nacos-<span class="hljs-variable">$i</span>; kubectl <span class="hljs-built_in">exec</span> nacos-<span class="hljs-variable">$i</span> curl GET <span class="hljs-string">"http://localhost:8848/nacos/v1/ns/raft/state"</span>; <span class="hljs-keyword">done</span>
</code></pre>
<p>到这里你可以发现新节点已经正常加入Nacos集群当中</p>
<h1>例子部署环境</h1>
<ul>
<li>机器配置</li>
</ul>
<table>
<thead>
<tr>
<th>内网IP</th>
<th>主机名</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.17.79.3</td>
<td>k8s-master</td>
<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>
</tr>
<tr>
<td>172.17.79.4</td>
<td>node01</td>
<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>
</tr>
<tr>
<td>172.17.79.5</td>
<td>node02</td>
<td>CentOS Linux release 7.4.1708 (Core) Single-core processor Mem 4G Cloud disk 40G</td>
</tr>
</tbody>
</table>
<ul>
<li>Kubernetes 版本：<strong>1.12.2</strong> （如果你和我一样只使用了三台机器,那么记得开启master节点的部署功能）</li>
<li>NFS 版本：<strong>4.1</strong> 在k8s-master进行安装Server端,并且指定共享目录,本项目指定的**/data/nfs-share**</li>
<li>Git</li>
</ul>
<h1>限制</h1>
<ul>
<li>必须要使用持久卷,否则会出现数据丢失的情况</li>
</ul>
<h1>项目目录</h1>
<table>
<thead>
<tr>
<th>目录</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>plugin</td>
<td>帮助Nacos集群进行动态扩容的插件Docker镜像源码</td>
</tr>
<tr>
<td>deploy</td>
<td>K8s 部署文件</td>
</tr>
</tbody>
</table>
<h1>配置属性</h1>
<ul>
<li>nacos-pvc-nfs.yaml or nacos-quick-start.yaml</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>必要</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://mysql.master.db.name">mysql.master.db.name</a></td>
<td>Y</td>
<td>主库名称</td>
</tr>
<tr>
<td>mysql.master.port</td>
<td>N</td>
<td>主库端口</td>
</tr>
<tr>
<td>mysql.slave.port</td>
<td>N</td>
<td>从库端口</td>
</tr>
<tr>
<td>mysql.master.user</td>
<td>Y</td>
<td>主库用户名</td>
</tr>
<tr>
<td>mysql.master.password</td>
<td>Y</td>
<td>主库密码</td>
</tr>
<tr>
<td>NACOS_REPLICAS</td>
<td>N</td>
<td>确定执行Nacos启动节点数量,如果不适用动态扩容插件,就必须配置这个属性，否则使用扩容插件后不会生效</td>
</tr>
<tr>
<td>NACOS_SERVER_PORT</td>
<td>N</td>
<td>Nacos 端口</td>
</tr>
<tr>
<td>PREFER_HOST_MODE</td>
<td>Y</td>
<td>启动Nacos集群按域名解析</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>nfs</strong> deployment.yaml</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>必要</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>NFS_SERVER</td>
<td>Y</td>
<td>NFS 服务端地址</td>
</tr>
<tr>
<td>NFS_PATH</td>
<td>Y</td>
<td>NFS 共享目录</td>
</tr>
<tr>
<td>server</td>
<td>Y</td>
<td>NFS 服务端地址</td>
</tr>
<tr>
<td>path</td>
<td>Y</td>
<td>NFS 共享目录</td>
</tr>
</tbody>
</table>
<ul>
<li>mysql</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>必要</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>MYSQL_ROOT_PASSWORD</td>
<td>N</td>
<td>ROOT 密码</td>
</tr>
<tr>
<td>MYSQL_DATABASE</td>
<td>Y</td>
<td>数据库名称</td>
</tr>
<tr>
<td>MYSQL_USER</td>
<td>Y</td>
<td>数据库用户名</td>
</tr>
<tr>
<td>MYSQL_PASSWORD</td>
<td>Y</td>
<td>数据库密码</td>
</tr>
<tr>
<td>MYSQL_REPLICATION_USER</td>
<td>Y</td>
<td>数据库复制用户</td>
</tr>
<tr>
<td>MYSQL_REPLICATION_PASSWORD</td>
<td>Y</td>
<td>数据库复制用户密码</td>
</tr>
<tr>
<td>Nfs:server</td>
<td>N</td>
<td>NFS 服务端地址，如果使用本地部署不需要配置</td>
</tr>
<tr>
<td>Nfs:path</td>
<td>N</td>
<td>NFS 共享目录，如果使用本地部署不需要配置</td>
</tr>
</tbody>
</table>
</div></div></section><footer class="footer-container"><div class="footer-body"><img src="/img/nacos_gray.png"/><div class="cols-container"><div class="col col-12"><h3>Vision</h3><p>By providing an easy-to-use service infrastructure such as dynamic service discovery, service configuration, service sharing and management and etc., Nacos help users better construct, deliver and manage their own service platform, reuse and composite business service faster and deliver value of business innovation more quickly so as to win market for users in the era of cloud native and in all cloud environments, such as private, mixed, or public clouds.</p></div><div class="col col-6"><dl><dt>Documentation</dt><dd><a href="/en-us/docs/what-is-nacos.html" target="_self">Overview</a></dd><dd><a href="/en-us/docs/quick-start.html" target="_self">Quick start</a></dd><dd><a href="/en-us/docs/contributing.html" target="_self">Developer guide</a></dd></dl></div><div class="col col-6"><dl><dt>Resources</dt><dd><a href="/en-us/community/index.html" target="_self">Community</a></dd><dd><a href="https://www.aliyun.com/product/acm?source_type=nacos_pc_20181219" target="_self">Cloud Service ACM</a></dd><dd><a href="https://www.aliyun.com/product/edas?source_type=nacos_pc_20181219" target="_self">Cloud Service EDAS</a></dd><dd><a href="https://www.aliyun.com/product/ahas?source_type=nacos_pc_20190225" target="_self">Cloud Service AHAS</a></dd></dl></div></div><div class="copyright"><span>@ 2018 The Nacos Authors | An Alibaba Middleware (Aliware) Project</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>