{
  "filename": "nacos-sync-use.md",
  "__html": "<h1>NacosSync迁移用户手册</h1>\n<p><a name=\"4a481d2c\"></a></p>\n<h2>手册目标</h2>\n<ul>\n<li>启动NacosSync服务</li>\n<li>通过一个简单的例子,演示如何将注册到Zookeeper的Dubbo客户端迁移到Nacos\n<a name=\"8dff94cf\"></a></li>\n</ul>\n<h2>系统需要</h2>\n<p>启动服务之前,你需要安装下面的服务:</p>\n<ul>\n<li>64bit OS: Linux/Unix/Mac/Windows supported, Linux/Unix/Mac recommended.</li>\n<li>64bit JDK 1.8+: <a href=\"http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html\">downloads</a>, <a href=\"https://docs.oracle.com/cd/E19182-01/820-7851/inst_cli_jdk_javahome_t/\">JAVA_HOME settings</a>.</li>\n<li>Maven 3.2.x+: <a href=\"https://maven.apache.org/download.cgi\">downloads</a>, <a href=\"https://maven.apache.org/settings.html\">settings</a>.</li>\n<li>MySql 5.6.+\n<a name=\"0aaf7364\"></a></li>\n</ul>\n<h2>获取安装包</h2>\n<p>有2种方式可以获得NacosSync的安装包:</p>\n<ul>\n<li>直接下载NacosSync的二进制安装包（下载最新的版本 <a href=\"https://github.com/nacos-group/nacos-sync/releases%EF%BC%89\">https://github.com/nacos-group/nacos-sync/releases）</a></li>\n</ul>\n<p><a href=\"https://github.com/nacos-group/nacos-sync/releases\">nacosSync.${version}.zip</a></p>\n<ul>\n<li>从GitHub上下载NacosSync的源码进行构建</li>\n</ul>\n<p>Package:</p>\n<pre><code class=\"language-basic\">cd nacosSync/\nmvn clean package -U\n</code></pre>\n<p>目标文件的路径:</p>\n<pre><code class=\"language-basic\">nacos-sync/nacossync-distribution/target/nacosSync.${version}.zip\n</code></pre>\n<p>解压安装包之后,工程的文件目录结构:</p>\n<pre><code class=\"language-basic\">nacosSync\n├── LICENSE\n├── NOTICE\n├── bin\n│   ├── nacosSync.sql\n│   ├── shutdown.sh\n│   └── startup.sh\n├── conf\n│   ├── application.properties\n│   └── logback-spring.xml\n├── logs\n└── nacosSync-server.${version}.jar\n</code></pre>\n<p><a name=\"d41d8cd9\"></a></p>\n<h3></h3>\n<p><a name=\"2e8b6989\"></a></p>\n<h2>初始化DB</h2>\n<p>系统默认配置的数据库是MySql,也能支持其他的关系型数据库</p>\n<ol>\n<li>建库,缺省的数据库名字为“nacos_Sync”</li>\n<li>数据库表不需要单独创建,默认使用了hibernate的自动建表功能</li>\n<li>如果你的环境不支持自动建表,可以使用系统自带的sql脚本建表,脚本放在bin目录下</li>\n</ol>\n<p><a name=\"fad227bc\"></a></p>\n<h2>DB配置</h2>\n<p>DB的配置文件放在conf/application.properties中:</p>\n<pre><code class=\"language-basic\">spring.datasource.url=jdbc:mysql://127.0.0.1:3306/nacos_sync?characterEncoding=utf8\nspring.datasource.username=root\nspring.datasource.password=root\n</code></pre>\n<p><a name=\"8b7a5bf9\"></a></p>\n<h2>启动服务器</h2>\n<pre><code class=\"language-bash\">$ nacosSync/bin:\nsh startup.sh  restart\n</code></pre>\n<p><a name=\"24d69918\"></a></p>\n<h2>检查系统状态</h2>\n<p>1.系统日志检查<br />日志的路径在 nacosSync/logs/nacosSync.log,检查是否有异常信息<br />2.检查系统端口(缺省的系统端口是8081,你可以自己定义在application.properties中)</p>\n<pre><code class=\"language-bash\"><span class=\"hljs-variable\">$netstat</span> -ano|grep 8081\ntcp        0      0 0.0.0.0:8081                0.0.0.0:*                   LISTEN      off (0.00/0/0)\n</code></pre>\n<p><a name=\"b5c37706\"></a></p>\n<h2>控制台</h2>\n<p>访问路径:</p>\n<pre><code>http://127.0.0.1:8081/#/serviceSync\n</code></pre>\n<p><img src=\"https://img.alicdn.com/tfs/TB1EKbkJ3HqK1RjSZFEXXcGMXXa-2866-606.png\" alt=\"image.png\"></p>\n<p>如果检查没有问题,NacosSync已经正常启动了,NacosSync的部署结构:<br /><img src=\"https://img.alicdn.com/tfs/TB107nfJ9zqK1RjSZFjXXblCFXa-1412-342.png\" alt=\"image.png\"></p>\n<p><a name=\"a9686100\"></a></p>\n<h2>开始迁移</h2>\n<p><a name=\"f7389286\"></a></p>\n<h3>迁移信息</h3>\n<p>Dubbo服务的部署信息:<br /><img src=\"https://img.alicdn.com/tfs/TB1Ci_eJ4TpK1RjSZR0XXbEwXXa-938-700.png\" alt=\"image.png\"></p>\n<p>迁移的服务:</p>\n<table>\n<thead>\n<tr>\n<th>Service Name</th>\n<th>Version</th>\n<th>Group Name</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>com.alibaba.nacos.api.DemoService</td>\n<td>1.0.0</td>\n<td>zk</td>\n</tr>\n</tbody>\n</table>\n<p><a name=\"30f7edcb\"></a></p>\n<h3>添加注册中心集群信息</h3>\n<p>1.点击左侧导航栏中的“集群配置”按钮,新增加一个集群,先增加一个Zookeeper集群,选择集群类型为ZK<br />\n<img src=\"https://img.alicdn.com/tfs/TB1oJDnJ7voK1RjSZFwXXciCFXa-2870-1130.png\" alt=\"image.png\"></p>\n<blockquote>\n<p>注意:集群名字可以自定义,但是一旦确认,不能被修改,否则基于此集群增加的任务,在NacosSync重启后,将不会恢复成功</p>\n</blockquote>\n<p>2.同样的步骤,增加NacosSync集群<br />\n<img src=\"https://img.alicdn.com/tfs/TB1HQPhJVzqK1RjSZFCXXbbxVXa-2846-1042.png\" alt=\"image.png\"></p>\n<p>添加完成后,可以在列表中查询到<br />\n<img src=\"https://img.alicdn.com/tfs/TB1AX6fJVYqK1RjSZLeXXbXppXa-2864-824.png\" alt=\"image.png\"></p>\n<p><a name=\"da01623b\"></a></p>\n<h3>添加同步任务</h3>\n<p>1.增加一个同步任务,从Zookeeper集群同步到Nacos集群,同步的粒度是服务,Zookeeper集群则称为源集群,Nacos集群称为目标集群<br />\n<img src=\"https://img.alicdn.com/tfs/TB1tF_fJVYqK1RjSZLeXXbXppXa-2838-1138.png\" alt=\"imagesd.png\"></p>\n<p>添加完成之后,可以在服务同步列表中,查看已添加的同步任务:<br />\n<img src=\"https://img.alicdn.com/tfs/TB1l6uJJ9zqK1RjSZPcXXbTepXa-2824-570.png\" alt=\"image.png\"></p>\n<p>2.同步完成之后,检查下数据是否同步成功到Nacos集群,可以通过Nacos的控制台进行查询<br />\n<img src=\"https://img.alicdn.com/tfs/TB1tPneJ4TpK1RjSZR0XXbEwXXa-2872-828.png\" alt=\"image.png\"></p>\n<p>此刻,数据已经成功从Zookeeper集群同步到了Nacos集群,部署结构如下:</p>\n<p><img src=\"https://img.alicdn.com/tfs/TB14kriJ6TpK1RjSZKPXXa3UpXa-1724-772.png\" alt=\"image.png\">\n<a name=\"a881af49\"></a></p>\n<h3>让Dubbo客户端连接到Nacos注册中心</h3>\n<p><a name=\"ebc99b4c\"></a></p>\n<h4>Dubbo Consumer客户端迁移</h4>\n<p>Dubbo 已经支持Nacos注册中心,支持的版本为2.5+,需要增加一个Nacos注册中心的Dubbo扩展插件依赖:</p>\n<pre><code class=\"language-basic\">&lt;dependency&gt;\n      &lt;groupId&gt;com.alibaba&lt;/groupId&gt;\n      &lt;artifactId&gt;dubbo-registry-nacos&lt;/artifactId&gt;\n\t\t\t&lt;version&gt;0.0.2&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p><br /><br />增加Nacos客户端的依赖:</p>\n<pre><code class=\"language-basic\">&lt;dependency&gt;\n        &lt;groupId&gt;com.alibaba.nacos&lt;/groupId&gt;\n        &lt;artifactId&gt;nacos-client&lt;/artifactId&gt;\n        &lt;version&gt;0.6.2&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>配置Dubbo Consumer的Dubbo配置文件,让客户端能够找到Nacos集群<br />consumer.yaml</p>\n<pre><code class=\"language-basic\">spring:\n  application:\nname: dubbo-consumer\ndemo:\n  service:\n    version: 1.0.0\n    group: zk\ndubbo:\n  registry:\n    address: nacos://127.0.0.1:8848\n</code></pre>\n<p>不需要修改代码,配置更新完毕之后 ,你就可以重启你的应用,使之生效了.</p>\n<p>Consumer发布完成之后,目前的部署结构如下:<br />\n<img src=\"https://img.alicdn.com/tfs/TB181fkJ3HqK1RjSZFEXXcGMXXa-1734-878.png\" alt=\"image.png\">\n<a name=\"dbe2c2d1\"></a></p>\n<h4>Dubbo Provider迁移</h4>\n<p>在升级Provider之前,你需要确保该Provider发布的服务,都已经配置在NacosSync中,同步的方式为从Nacos同步到Zookeeper,因为Provider升级连接到Nacos之后,需要确保老的Dubbo Consumer客户端能够在Zookeeper上订阅到该Provider的地址,现在,我们增加一个同步任务:<br />\n<img src=\"https://img.alicdn.com/tfs/TB1pdDnJ7voK1RjSZFwXXciCFXa-2872-1060.png\" alt=\"image.png\">\n<br />\n<img src=\"https://img.alicdn.com/tfs/TB19Ey_J6DpK1RjSZFrXXa78VXa-2842-660.png\" alt=\"image.png\"></p>\n<blockquote>\n<p>注意:Nacos服务同步到Zookeeper,不需要填写版本号,你在选择源集群的时候,版本号的输入框会自动隐藏掉</p>\n</blockquote>\n<p>同步任务完成后,你就可以升级Provider了,升级Provider的方法,参考升级Consumer的步骤.\n<a name=\"35707fdc\"></a></p>\n<h3>新的部署结构</h3>\n<ul>\n<li>在升级的过程中,会有新老版本的客户端同时存在,部署结构如下:</li>\n</ul>\n<p><img src=\"https://img.alicdn.com/tfs/TB14Y_iJ3HqK1RjSZFPXXcwapXa-1728-838.png\" alt=\"image.png\"></p>\n<ul>\n<li>在所有的客户端迁移完成之后,部署结构如下:</li>\n</ul>\n<p><img src=\"https://img.alicdn.com/tfs/TB1Cg2dJYvpK1RjSZPiXXbmwXXa-1466-864.png\" alt=\"image.png\"></p>\n<p>现在,Zookeeper集群,NacosSync集群就可以下线了.</p>\n<p><a name=\"1bbbb204\"></a></p>\n<h3>注意事项</h3>\n<ul>\n<li>同步任务添加之后,需要确保下服务是否成功同步到目标集群,可以通过目标集群的控制台进行查询</li>\n<li>NacosSync支持高可用集群模式部署,你只需要把数据库配置成同一个即可</li>\n<li>如果梳理不清楚订阅和发布的服务,建议可以把服务都做双向同步</li>\n<li>Dubbo客户端目前不支持Nacos的权重功能,如果你用到了权重功能,需要重新考虑一下方案是否合适</li>\n</ul>\n"
}