{
  "filename": "apisix.md",
  "__html": "<h1>Background information</h1>\n<h2>Apache APISIX Introduction</h2>\n<p><strong>Apache APISIX</strong> is a dynamic, real-time, high-performance API gateway.</p>\n<p>APISIX provides rich traffic management features such as load balancing, dynamic upstream, canary release, circuit breaking, authentication, observability, and more. Apache APISIX not only has many practical plug-ins, but also supports plugin dynamic change and Hot-loading.</p>\n<h2>Nacos Introduction</h2>\n<p>Nacos is an easy-to-use, open source platform for dynamic service discovery, service configuration and service management.  It provides a set of simple and useful features enabling you to realize dynamic service discovery, service configuration, service metadata and traffic management. Nacos makes it easier and faster to construct, deliver and manage your microservices platform. It is the infrastructure that supports a service-centered modern application architecture with a microservices or cloud-native approach.</p>\n<h1>Service Registry</h1>\n<p>Service Registry is the core component of service management, similar to the role of directory service, and one of the most basic facilities in the microservices architecture. It is mainly used to store service information, such as service provider URL, routing information, and so on. The service registry is implemented by mapping complex service-side information to simple and understandable information for the client.</p>\n<p>The core functions of the Service Registry are as follows:</p>\n<ul>\n<li>\n<p>Service registration: Service providers register with the Service Registration Center.</p>\n</li>\n<li>\n<p>Service discovery: Service consumers can find the call routing information of service providers through the registry.</p>\n</li>\n<li>\n<p>Health check: Ensure that service nodes registered with the service registry can be invoked normally, and avoid the waste of call resources caused by invalid nodes.</p>\n</li>\n</ul>\n<h2>Why do you need a service registry?</h2>\n<p>The registry is essentially to decouple service providers and service consumers. In the microservice system, each business service will call each other frequently, and the IP, port and other routing information of each service need to be managed uniformly. But how do you manage it? You can provide information about existing services to a unified service registry for management through the Service Registration function of the Service Registry.</p>\n<p>From the above description, you can know that the registry can help users quickly find services and service addresses through mapping. As business updates iterate, services change frequently. Clients can still pull a list of services through the service discovery function of the registry after registering new services or service downtime on the service side. If the service node of the registry changes, the registry sends a request to notify the client to pull again.</p>\n<p>If the service on the server side suddenly goes down and there is no feedback to the service registry, the client can show the service side its service status by actively reporting the heartbeat at regular intervals through the health check function of the service registry. If the service status is abnormal, the service registry will be notified, and the service registry can remove the down service nodes in time to avoid waste of resources.If the service on the server side suddenly goes down and there is no feedback to the service registry, the client can show the service side its service status by actively reporting the heartbeat at regular intervals through the health check function of the service registry. If the service status is abnormal, the service registry will be notified, and the service registry can remove the down service nodes in time to avoid waste of resources.</p>\n<h2>What application scenarios does Apache APISIX + Nacos provide for users?</h2>\n<p>Apache APISIX + Nacos can centralize business-independent control of each microservice node into Apache APISIX for unified management, that is, the ability to proxy and route forwarding interface services through Apache APISIX. After each microservice is registered on Nacos, Apache APISIX can obtain a list of services through Nacos's service discovery function and find the corresponding service address to implement dynamic proxy.</p>\n<p><img src=\"/img/blog/apisix_en.png\" alt=\"img\"></p>\n<h1>Apache APISIX realizes service discovery based on Nacos</h1>\n<h2>Prerequisites</h2>\n<p>This article is based on the following environments.</p>\n<ul>\n<li>OS: Centos 7.9.</li>\n<li>Apache APISIX 12.1.0, please refer to: <a href=\"https://apisix.apache.org/docs/apisix/how-to-build\">Apache APISIX how-to-bulid</a>.</li>\n<li>Nacos 2.0.4, please refer to: <a href=\"https://nacos.io/en-us/docs/quick-start.html\">Nacos quick start</a></li>\n<li>Node.js, please refer to: <a href=\"https://github.com/nodejs/help/wiki/Installation\">node.js Installation</a></li>\n</ul>\n<h2>Step 1: Service Register</h2>\n<ol>\n<li>Use Node.js's Koa framework starts a simple test service on port 3005 as <a href=\"https://apisix.apache.org/docs/apisix/admin-api#upstream\">upstream</a>.</li>\n</ol>\n<pre><code class=\"language-JavaScript\"><span class=\"hljs-keyword\">const</span> Koa = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">'koa'</span>);\n<span class=\"hljs-keyword\">const</span> app = <span class=\"hljs-keyword\">new</span> Koa();\n\napp.use(<span class=\"hljs-keyword\">async</span> ctx =&gt; {\n  ctx.body = <span class=\"hljs-string\">'Hello World'</span>;\n});\n\napp.listen(<span class=\"hljs-number\">3005</span>);\n</code></pre>\n<ol start=\"2\">\n<li>Register the service on the command line by requesting the Nacos Open API.</li>\n</ol>\n<pre><code class=\"language-Bash\">curl -X POST <span class=\"hljs-string\">'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=APISIX-NACOS&amp;ip=127.0.0.1&amp;port=3005&amp;ephemeral=false'</span>\n</code></pre>\n<ol start=\"3\">\n<li>After service registration, use the following command to query the current service.</li>\n</ol>\n<pre><code class=\"language-Bash\">curl -X GET <span class=\"hljs-string\">'http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=APISIX-NACOS'</span>\n</code></pre>\n<p>Examples of correct returned results are as follows:</p>\n<pre><code class=\"language-JSON\">{\n  <span class=\"hljs-attr\">\"name\"</span>: <span class=\"hljs-string\">\"DEFAULT_GROUP@@APISIX-NACOS\"</span>,\n  <span class=\"hljs-attr\">\"groupName\"</span>: <span class=\"hljs-string\">\"DEFAULT_GROUP\"</span>,\n  <span class=\"hljs-attr\">\"clusters\"</span>: <span class=\"hljs-string\">\"\"</span>,\n  <span class=\"hljs-attr\">\"cacheMillis\"</span>: <span class=\"hljs-number\">10000</span>,\n  <span class=\"hljs-attr\">\"hosts\"</span>: [\n    {\n      <span class=\"hljs-attr\">\"instanceId\"</span>: <span class=\"hljs-string\">\"127.0.0.1#3005#DEFAULT#DEFAULT_GROUP@@APISIX-NACOS\"</span>,\n      <span class=\"hljs-attr\">\"ip\"</span>: <span class=\"hljs-string\">\"127.0.0.1\"</span>,\n      <span class=\"hljs-attr\">\"port\"</span>: <span class=\"hljs-number\">3005</span>,\n      <span class=\"hljs-attr\">\"weight\"</span>: <span class=\"hljs-number\">1.0</span>,\n      <span class=\"hljs-attr\">\"healthy\"</span>: <span class=\"hljs-literal\">true</span>,\n      <span class=\"hljs-attr\">\"enabled\"</span>: <span class=\"hljs-literal\">true</span>,\n      <span class=\"hljs-attr\">\"ephemeral\"</span>: <span class=\"hljs-literal\">true</span>,\n      <span class=\"hljs-attr\">\"clusterName\"</span>: <span class=\"hljs-string\">\"DEFAULT\"</span>,\n      <span class=\"hljs-attr\">\"serviceName\"</span>: <span class=\"hljs-string\">\"DEFAULT_GROUP@@APISIX-NACOS\"</span>,\n      <span class=\"hljs-attr\">\"metadata\"</span>: {},\n      <span class=\"hljs-attr\">\"instanceHeartBeatInterval\"</span>: <span class=\"hljs-number\">5000</span>,\n      <span class=\"hljs-attr\">\"instanceHeartBeatTimeOut\"</span>: <span class=\"hljs-number\">15000</span>,\n      <span class=\"hljs-attr\">\"ipDeleteTimeout\"</span>: <span class=\"hljs-number\">30000</span>,\n      <span class=\"hljs-attr\">\"instanceIdGenerator\"</span>: <span class=\"hljs-string\">\"simple\"</span>\n    }\n  ],\n  <span class=\"hljs-attr\">\"lastRefTime\"</span>: <span class=\"hljs-number\">1643191399694</span>,\n  <span class=\"hljs-attr\">\"checksum\"</span>: <span class=\"hljs-string\">\"\"</span>,\n  <span class=\"hljs-attr\">\"allIPs\"</span>: <span class=\"hljs-literal\">false</span>,\n  <span class=\"hljs-attr\">\"reachProtectionThreshold\"</span>: <span class=\"hljs-literal\">false</span>,\n  <span class=\"hljs-attr\">\"valid\"</span>: <span class=\"hljs-literal\">true</span>\n}\n</code></pre>\n<h2>Step 2:Added Nacos Route</h2>\n<p>Create a new route using the Admin API provided by Apache APISIX. APISIX selects the service discovery type to use through the <code>upstream.discovery_type</code> field. <code>upstream.service_name</code>  needs to be associated with the corresponding service name of the registry. Therefore, when creating a route, specify the service discovery type as Nacos.</p>\n<pre><code class=\"language-Shell\">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -i -d '\n{\n    \"uri\": \"/nacos/*\",\n    \"upstream\": {\n        \"service_name\": \"APISIX-NACOS\",\n        \"type\": \"roundrobin\",\n        \"discovery_type\": \"nacos\"\n    }\n}'\n</code></pre>\n<p>In the above command, the request header <code>X-API-KEY</code> is the access token of the admin API, which can be viewed under <code>apisix.admin_key.key</code> in the<code>conf/config.yaml</code> file.</p>\n<p>After successful addition, examples of correct returned results are as follows:</p>\n<pre><code class=\"language-JSON\">{\n  <span class=\"hljs-attr\">\"action\"</span>: <span class=\"hljs-string\">\"set\"</span>,\n  <span class=\"hljs-attr\">\"node\"</span>: {\n    <span class=\"hljs-attr\">\"key\"</span>: <span class=\"hljs-string\">\"\\/apisix\\/routes\\/1\"</span>,\n    <span class=\"hljs-attr\">\"value\"</span>: {\n      <span class=\"hljs-attr\">\"update_time\"</span>: <span class=\"hljs-number\">1643191044</span>,\n      <span class=\"hljs-attr\">\"create_time\"</span>: <span class=\"hljs-number\">1643176603</span>,\n      <span class=\"hljs-attr\">\"priority\"</span>: <span class=\"hljs-number\">0</span>,\n      <span class=\"hljs-attr\">\"uri\"</span>: <span class=\"hljs-string\">\"\\/nacos\\/*\"</span>,\n      <span class=\"hljs-attr\">\"upstream\"</span>: {\n        <span class=\"hljs-attr\">\"hash_on\"</span>: <span class=\"hljs-string\">\"vars\"</span>,\n        <span class=\"hljs-attr\">\"discovery_type\"</span>: <span class=\"hljs-string\">\"nacos\"</span>,\n        <span class=\"hljs-attr\">\"scheme\"</span>: <span class=\"hljs-string\">\"http\"</span>,\n        <span class=\"hljs-attr\">\"pass_host\"</span>: <span class=\"hljs-string\">\"pass\"</span>,\n        <span class=\"hljs-attr\">\"type\"</span>: <span class=\"hljs-string\">\"roundrobin\"</span>,\n        <span class=\"hljs-attr\">\"service_name\"</span>: <span class=\"hljs-string\">\"APISIX-NACOS\"</span>\n      },\n      <span class=\"hljs-attr\">\"id\"</span>: <span class=\"hljs-string\">\"1\"</span>,\n      <span class=\"hljs-attr\">\"status\"</span>: <span class=\"hljs-number\">1</span>\n    }\n  }\n}\n</code></pre>\n<p>In addition, you can also pass other service related parameters in <code>upstream.discovery_args</code>   to specify the namespace or group where the service is located. For details, please refer to the following table:</p>\n<table>\n<thead>\n<tr>\n<th><strong>Name</strong></th>\n<th><strong>Type</strong></th>\n<th><strong>Requirement</strong></th>\n<th><strong>Default</strong></th>\n<th><strong>Valid</strong></th>\n<th><strong>Description</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>namespace_id</td>\n<td>string</td>\n<td>optional</td>\n<td>public</td>\n<td></td>\n<td>This parameter is used to specify the namespace of the corresponding service</td>\n</tr>\n<tr>\n<td>group_name</td>\n<td>string</td>\n<td>optional</td>\n<td>DEFAULT_GROUP</td>\n<td></td>\n<td>This parameter is used to specify the group of the corresponding service</td>\n</tr>\n</tbody>\n</table>\n<h2>Step 3: Verify configuration results</h2>\n<p>Use the following command to send the request to the route to be configured.</p>\n<pre><code class=\"language-Shell\">curl -i http://127.0.0.1:9080/nacos/\n</code></pre>\n<p>Examples of correct returned results are as follows:</p>\n<pre><code class=\"language-Apache\"><span class=\"hljs-attribute\">HTTP</span>/1.1 200 OK\n<span class=\"hljs-attribute\">Content</span>-Type: text/plain; charset=utf-8\n<span class=\"hljs-attribute\">Content</span>-Length: 11\n<span class=\"hljs-attribute\">Connection</span>: keep-alive\n<span class=\"hljs-attribute\">Date</span>: Thu, 27 Jan 2022 00:48:26 GMT\n<span class=\"hljs-attribute\">Server</span>: APISIX/2.12.0\n\n<span class=\"hljs-attribute\">Hello</span> World\n</code></pre>\n<p>It can be seen from the example that the new route in Apache APISIX can find the correct service address through Nacos service discovery and respond normally.</p>\n<h1>Summary</h1>\n<p>This article introduces the concept of registry and how Apache APISIX cooperates with Nacos to implement routing proxy based on service discovery. How to use Apache APISIX with Nacos in actual scenarios depends on the specific business requirements and past technical architecture.</p>\n<p>To get more information about the <code>nacos</code> plugin description and full configuration list, you can refer to the <a href=\"https://apisix.apache.org/zh/docs/apisix/discovery/nacos\">official documentation</a>.</p>\n",
  "link": "/en-us/blog/apisix.html",
  "meta": {
    "title": "Apache APISIX Realizes Service Discovery Based on Nacos",
    "keywords": "Apache APISIX",
    "description": "This article introduces the basic concepts of Apache APISIX and Nacos and Service Registry, and shows you the specific operation of Apache APISIX to realize service discovery based on Nacos."
  }
}