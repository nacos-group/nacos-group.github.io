<!DOCTYPE html><html lang="zh-cn" data-theme="light"> <head><meta charset="utf-8"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"> <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Nacos Blog | Nacos</title><link rel="canonical" href="https://nacos-group.github.io/blog/article-nacos130-design/"/><link rel="alternate" hreflang="zh-CN" href="https://nacos-group.github.io/blog/article-nacos130-design/"/><link rel="alternate" hreflang="en" href="https://nacos-group.github.io/en/blog/article-nacos130-design/"/><link rel="sitemap" href="/sitemap-index.xml"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><meta name="aplus-core" content="aplus.js"/><meta property="og:title" content="Nacos Blog"/><meta property="og:type" content="article"/><meta property="og:url" content="https://nacos-group.github.io/blog/article-nacos130-design/"/><meta property="og:locale"/><meta property="og:site_name" content="Nacos"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Nacos Blog"/><meta name="twitter:description"/><meta name="baidu-site-verification" content="code-wzq5sw7io3"/><meta property="keywords" content="动态服务发现,配置管理,服务管理"/> <!--初始化SDK-->   <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-0YDFJ7LX7F"></script> <meta name="generator" content="Astro v4.1.2"><meta name="robots" content="index, follow"><title>Nacos Blog</title><link data-rh="true" rel="icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"><style>.sl-markdown-content :not(a,strong,em,del,span,input,code)+:not(a,strong,em,del,span,input,code,:where(.not-content *)){margin-top:1.5rem}.sl-markdown-content :not(h1,h2,h3,h4,h5,h6)+:is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){margin-top:2.5rem;scroll-margin-top:4rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6){margin-bottom:1rem}.sl-markdown-content p{margin-bottom:.5rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6)+:is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){scroll-margin-top:4rem}.sl-markdown-content li+li:not(:where(.not-content *)),.sl-markdown-content dt+dt:not(:where(.not-content *)),.sl-markdown-content dt+dd:not(:where(.not-content *)),.sl-markdown-content dd+dd:not(:where(.not-content *)){margin-top:.25rem}.sl-markdown-content li>:last-child:not(li,ul,ol):not(a,strong,em,del,span,input,:where(.not-content *)){margin-bottom:1.25rem}.sl-markdown-content dt:not(:where(.not-content *)){font-weight:700}.sl-markdown-content dd:not(:where(.not-content *)){padding-inline-start:1rem}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6):not(:where(.not-content *)){color:var(--sl-color-white);line-height:var(--sl-line-height-headings);font-weight:600}.sl-markdown-content :is(img,picture,video,canvas,svg,iframe):not(:where(.not-content *)){display:block;max-width:100%;height:auto}.sl-markdown-content h1:not(:where(.not-content *)){font-size:var(--sl-text-h1)}.sl-markdown-content h2:not(:where(.not-content *)){font-size:var(--sl-text-h2)}.sl-markdown-content h3:not(:where(.not-content *)){font-size:var(--sl-text-h3)}.sl-markdown-content h4:not(:where(.not-content *)){font-size:var(--sl-text-h4)}.sl-markdown-content h5:not(:where(.not-content *)){font-size:var(--sl-text-h5)}.sl-markdown-content h6:not(:where(.not-content *)){font-size:var(--sl-text-h6)}.sl-markdown-content a:not(:where(.not-content *)){color:var(--sl-color-text-accent)}.sl-markdown-content a:hover:not(:where(.not-content *)){color:var(--sl-color-white)}.sl-markdown-content code:not(:where(.not-content *)){background-color:var(--sl-color-bg-inline-code);margin-block:-.125rem;padding:.125rem .375rem;font-size:var(--sl-text-code-sm)}.sl-markdown-content :is(h1,h2,h3,h4,h5,h6) code{font-size:inherit}.sl-markdown-content pre:not(:where(.not-content *)){border:1px solid var(--sl-color-gray-5);padding:.75rem 1rem;font-size:var(--sl-text-code);-moz-tab-size:2;-o-tab-size:2;tab-size:2}.sl-markdown-content pre code:not(:where(.not-content *)){all:unset;font-family:var(--__sl-font-mono)}.sl-markdown-content blockquote:not(:where(.not-content *)){border-inline-start:1.5px solid var(--sl-color-gray-5);padding-inline-start:1rem;background-color:#f4f4f6}.sl-markdown-content table:not(:where(.not-content *)){display:block;overflow:auto;border-collapse:collapse}.sl-markdown-content tr:nth-child(2n):not(:where(.not-content *)){background-color:var(--sl-color-gray-7, var(--sl-color-gray-6))}.sl-markdown-content :is(th,td):not(:where(.not-content *)){border:1px solid var(--sl-color-hairline-light);padding:.375rem .8125rem}.sl-markdown-content hr:not(:where(.not-content *)){border:0;border-bottom:1px solid var(--sl-color-hairline)}.sl-markdown-content h2{line-height:3.5rem}main:where(.astro-xvyu6ype){width:calc(100% - 2em);max-width:100%;margin:0}.hero-image:where(.astro-xvyu6ype){width:100%}.hero-image:where(.astro-xvyu6ype) img:where(.astro-xvyu6ype){display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.nacos-prose:where(.astro-xvyu6ype){width:100%;padding:1.5rem;color:rgb(var(--gray-dark))}.title:where(.astro-xvyu6ype){margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title:where(.astro-xvyu6ype) h1:where(.astro-xvyu6ype){margin:0 0 .5em}.date:where(.astro-xvyu6ype){margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on:where(.astro-xvyu6ype){font-style:italic}
ul:where(.astro-oshslw7j){padding:0;list-style:none}a:where(.astro-oshslw7j){--pad-inline: .5rem;display:block;border-radius:.25rem;padding-block:.25rem;padding-inline:calc(1rem * var(--depth) + var(--pad-inline)) var(--pad-inline);line-height:1.25}a:where(.astro-oshslw7j)[aria-current=true],a:where(.astro-oshslw7j)[aria-current=true]:hover,a:where(.astro-oshslw7j)[aria-current=true]:focus{color:#121316!important;background-color:#ebecef!important;border-left-style:solid;border-left-width:3px;border-left-color:#121316;padding-left:.625rem!important;font-weight:400!important;border-radius:0!important}.isMobile:where(.astro-oshslw7j) a:where(.astro-oshslw7j){--pad-inline: 1rem;display:flex;justify-content:space-between;gap:var(--pad-inline);border-top:1px solid var(--sl-color-gray-6);border-radius:0;padding-block:.5rem;color:var(--sl-color-text);font-size:var(--sl-text-sm);text-decoration:none;outline-offset:var(--sl-outline-offset-inside)}.isMobile:where(.astro-oshslw7j):first-child>li:where(.astro-oshslw7j):first-child>a:where(.astro-oshslw7j){border-top:0}.isMobile:where(.astro-oshslw7j) a:where(.astro-oshslw7j)[aria-current=true],.isMobile:where(.astro-oshslw7j) a:where(.astro-oshslw7j)[aria-current=true]:hover,.isMobile:where(.astro-oshslw7j) a:where(.astro-oshslw7j)[aria-current=true]:focus{color:var(--sl-color-white);background-color:unset}.isMobile:where(.astro-oshslw7j) a:where(.astro-oshslw7j)[aria-current=true]:after{content:"";width:1rem;background-color:var(--sl-color-text-accent);-webkit-mask-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxNCAxNCc+PHBhdGggZD0nTTEwLjkxNCA0LjIwNmEuNTgzLjU4MyAwIDAgMC0uODI4IDBMNS43NCA4LjU1NyAzLjkxNCA2LjcyNmEuNTk2LjU5NiAwIDAgMC0uODI4Ljg1N2wyLjI0IDIuMjRhLjU4My41ODMgMCAwIDAgLjgyOCAwbDQuNzYtNC43NmEuNTgzLjU4MyAwIDAgMCAwLS44NTdaJy8+PC9zdmc+Cg==);mask-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxNCAxNCc+PHBhdGggZD0nTTEwLjkxNCA0LjIwNmEuNTgzLjU4MyAwIDAgMC0uODI4IDBMNS43NCA4LjU1NyAzLjkxNCA2LjcyNmEuNTk2LjU5NiAwIDAgMC0uODI4Ljg1N2wyLjI0IDIuMjRhLjU4My41ODMgMCAwIDAgLjgyOCAwbDQuNzYtNC43NmEuNTgzLjU4MyAwIDAgMCAwLS44NTdaJy8+PC9zdmc+Cg==);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;flex-shrink:0}
.starlight__on-this-page ul{padding:0;list-style:none}.starlight__on-this-page a{--pad-inline: .5rem;display:block;border-radius:.25rem;padding-block:.25rem;padding-inline:calc(1rem * var(--depth) + var(--pad-inline)) var(--pad-inline);line-height:1.25}.starlight__on-this-page a[aria-current=true],.starlight__on-this-page a[aria-current=true]:hover,.starlight__on-this-page a[aria-current=true]:focus{font-weight:600;color:var(--sl-color-text-invert);background-color:var(--sl-color-text-accent)}.starlight__on-this-page .isMobile a{--pad-inline: 1rem;display:flex;justify-content:space-between;gap:var(--pad-inline);border-top:1px solid var(--sl-color-gray-6);border-radius:0;padding-block:.5rem;color:var(--sl-color-text);font-size:var(--sl-text-sm);text-decoration:none;outline-offset:var(--sl-outline-offset-inside)}.starlight__on-this-page .isMobile:first-child>li:first-child>a{border-top:0}.starlight__on-this-page .isMobile a[aria-current=true],.starlight__on-this-page .isMobile a[aria-current=true]:hover,.starlight__on-this-page .isMobile a[aria-current=true]:focus{color:var(--sl-color-white);background-color:unset}.starlight__on-this-page .isMobile a[aria-current=true]:after{content:"";width:1rem;background-color:var(--sl-color-text-accent);-webkit-mask-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxNCAxNCc+PHBhdGggZD0nTTEwLjkxNCA0LjIwNmEuNTgzLjU4MyAwIDAgMC0uODI4IDBMNS43NCA4LjU1NyAzLjkxNCA2LjcyNmEuNTk2LjU5NiAwIDAgMC0uODI4Ljg1N2wyLjI0IDIuMjRhLjU4My41ODMgMCAwIDAgLjgyOCAwbDQuNzYtNC43NmEuNTgzLjU4MyAwIDAgMCAwLS44NTdaJy8+PC9zdmc+Cg==);mask-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxNCAxNCc+PHBhdGggZD0nTTEwLjkxNCA0LjIwNmEuNTgzLjU4MyAwIDAgMC0uODI4IDBMNS43NCA4LjU1NyAzLjkxNCA2LjcyNmEuNTk2LjU5NiAwIDAgMC0uODI4Ljg1N2wyLjI0IDIuMjRhLjU4My41ODMgMCAwIDAgLjgyOCAwbDQuNzYtNC43NmEuNTgzLjU4MyAwIDAgMCAwLS44NTdaJy8+PC9zdmc+Cg==);-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat;flex-shrink:0}ul:where(.astro-koteama4){padding:0;list-style:none}a:where(.astro-koteama4){--pad-inline: .5rem;display:block;border-radius:.25rem;padding-block:.25rem;padding-inline:calc(1rem * var(--depth) + var(--pad-inline)) var(--pad-inline);line-height:1.25}a:where(.astro-koteama4)[aria-current=true],a:where(.astro-koteama4)[aria-current=true]:hover,a:where(.astro-koteama4)[aria-current=true]:focus{color:#121316!important;background-color:#ebecef!important;border-left-style:solid;border-left-width:3px;border-left-color:#121316;padding-left:.625rem!important;font-weight:400!important;border-radius:0!important}
</style>
<link rel="stylesheet" href="/_astro/index.TWzvL8nf.css" />
<link rel="stylesheet" href="/_astro/global.mNr9wIw9.css" />
<style>@font-face{font-family:Roboto;font-style:normal;font-weight:400;src:url(/fonts/Roboto-Regular.ttf) format("truetype")}@font-face{font-family:Roboto;font-style:normal;font-weight:700;src:url(/fonts/Roboto-Bold.ttf) format("truetype")}@font-face{font-family:Roboto;font-style:italic;font-weight:700;src:url(/fonts/Roboto-BoldItalic.ttf) format("truetype")}@font-face{font-family:Roboto;font-style:normal;font-weight:500;src:url(/fonts/Roboto-Medium.ttf) format("truetype")}@font-face{font-family:Roboto;font-style:italic;font-weight:500;src:url(/fonts/Roboto-MediumItalic.ttf) format("truetype")}@font-face{font-family:SourceHanSans;font-style:normal;font-weight:400;src:url(/fonts/SourceHanSansSC-Normal-Min.ttf) format("truetype")}@font-face{font-family:SourceHanSans;font-style:normal;font-weight:500;src:url(/fonts/SourceHanSansSC-Medium-Min.ttf) format("truetype")}@font-face{font-family:SourceHanSans;font-style:normal;font-weight:700;src:url(/fonts/SourceHanSansSC-Bold-Min.ttf) format("truetype")}
.sidebar-content:where(.astro-7jjqptxk){height:100%;padding:1rem var(--sl-sidebar-pad-x) 0;flex-direction:column;gap:1rem}.right-sidebar-panel:where(.astro-7jjqptxk){flex-direction:column;justify-content:space-between;height:100%;padding:1rem var(--sl-sidebar-pad-x)}.right-sidebar-panel:where(.astro-7jjqptxk) h2{color:var(--sl-color-white);font-size:var(--sl-text-h5);font-weight:600;line-height:var(--sl-line-height-headings);margin-bottom:.5rem}.right-sidebar-panel:where(.astro-7jjqptxk) a{display:block;font-size:var(--sl-text-xs);text-decoration:none;color:var(--sl-color-gray-3);overflow-wrap:anywhere}.right-sidebar-panel:where(.astro-7jjqptxk) a:hover{color:var(--sl-color-white)}
</style>
<link rel="stylesheet" href="/_astro/index.jwCWbkjC.css" />
<link rel="stylesheet" href="/_astro/index.YwPQN7Es.css" />
<style>button:where(.astro-bweis6se){--button-bg-color: #F4F4F6;--button-hover-color: #EBECEF;--button-text-color: #1E1F24;--primary-bg-color: #1E1F24;--primary-hover-color: #2E3038;--primary-text-color: #A3A6B3;--button-rounded: .5rem;--button-font-size: .875rem;--button-small-height: 1.5rem;--button-medium-height: 2rem;--button-large-height: 3rem;--button-small-xpadding: .75rem;--button-medium-xpadding: 1rem;--button-large-xpadding: 2.25rem}.button:where(.astro-bweis6se){cursor:pointer;font-weight:400;font-size:var(--button-font-size);color:var(--button-text-color)}.button-primary:where(.astro-bweis6se){color:var(--primary-text-color);background-color:var(--primary-bg-color)}.button-primary:where(.astro-bweis6se):hover{background-color:var(--primary-hover-color)}.button-normal:where(.astro-bweis6se){color:var(--button-text-color);background-color:var(--button-bg-color)}.button-normal:where(.astro-bweis6se):hover{background-color:var(--button-hover-color)}.button-normal:where(.astro-bweis6se) .icon:where(.astro-bweis6se),.button-primary:where(.astro-bweis6se) .icon:where(.astro-bweis6se){opacity:0;width:0;margin-left:0;transition:transform .5s ease,width .3s ease,opacity .3s ease,margin-left .3s ease}.button-normal:where(.astro-bweis6se):hover .icon:where(.astro-bweis6se),.button-primary:where(.astro-bweis6se):hover .icon:where(.astro-bweis6se){transform:translate(3px);opacity:1;width:8px;margin-left:.5rem}.xp-small:where(.astro-bweis6se){padding:0 var(--button-small-xpadding)}.xp-medium:where(.astro-bweis6se){padding:0 var(--button-medium-xpadding)}.xp-large:where(.astro-bweis6se){padding:0 var(--button-large-xpadding)}.h-small:where(.astro-bweis6se){height:var(--button-small-height)}.h-medium:where(.astro-bweis6se){height:var(--button-medium-height)}.h-large:where(.astro-bweis6se){height:var(--button-large-height)}
</style><script type="module" src="/_astro/hoisted.H8JodsK3.js"></script>
<script type="module" src="/_astro/page.Jay7wAFe.js"></script></head> <body> <!-- <HomeHeader align="home" position={position} lang={Astro.props.lang} {...Astro.props} /> --> <my-layout style="position: sticky; height: 3.5rem; --width: 100%;--height: 3.5rem;--xpadding: 1.5rem;" class=" backdrop-blur-md top-0 z-[10000] bg-gray-14 flex justify-center astro-4xcajfft"> <!-- 方便控制header宽度 --> <div class="header-content flex items-center justify-between astro-4xcajfft" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"> <div class="left-content h-full flex items-center astro-4xcajfft" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"> <a class="no-underline astro-4xcajfft" href="/" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"> <img class="logo astro-4xcajfft" src="https://img.alicdn.com/imgextra/i4/O1CN01rW3vAB1FDWKSOiFf0_!!6000000000453-2-tps-204-40.png" alt="nacos-log" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"> </a> <div class="mobile-navbar mobile-navbar h-full ml-4 astro-4xcajfft astro-qqnrwf7b" style="--top: 3.5rem;"> <mobile-menu-button class="astro-qqnrwf7b" style="--top: 3.5rem;"> <button aria-expanded="false" aria-label="mobile-menu-button" class="astro-qqnrwf7b" style="--top: 3.5rem;"> <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6304" width="28" height="28" class="astro-qqnrwf7b" style="--top: 3.5rem;"> <path d="M192.037 287.953h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32zM832.161 479.169H438.553c-17.673 0-32 14.327-32 32s14.327 32 32 32h393.608c17.673 0 32-14.327 32-32s-14.327-32-32-32zM832.161 735.802H192.037c-17.673 0-32 14.327-32 32s14.327 32 32 32h640.124c17.673 0 32-14.327 32-32s-14.327-32-32-32zM319.028 351.594l-160 160 160 160z" fill="#f4f4f6" p-id="6305" class="astro-qqnrwf7b" style="--top: 3.5rem;"></path> </svg> </button> </mobile-menu-button> <div class="navbar-panel bg-gray-14 astro-qqnrwf7b" style="--top: 3.5rem;"> <div class="navbar-content flex astro-qqnrwf7b" style="--top: 3.5rem;"> <ul class="top-level astro-5cocwzqt"> <li class="astro-5cocwzqt"> <details class="astro-5cocwzqt"> <summary class="astro-5cocwzqt"> <div class="group-label astro-5cocwzqt"> <span class="large undefined astro-5cocwzqt">文档</span> </div> <svg aria-hidden="true" class="caret astro-5cocwzqt astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-color: #818598;--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-5cocwzqt"> <li class="astro-5cocwzqt"> <a href="/docs/latest/what-is-nacos/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">最新版（Latest）</span> </a> </li><li class="astro-5cocwzqt"> <a href="/docs/next/what-is-nacos/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">预览版（Next）</span> </a> </li><li class="astro-5cocwzqt"> <a href="/docs/v2/what-is-nacos/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">2.x</span> </a> </li><li class="astro-5cocwzqt"> <a href="/docs/v1/what-is-nacos/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">1.x</span> </a> </li> </ul>  </details> </li><li class="astro-5cocwzqt"> <a href="/cloud/" class="large flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">企业版 NACOS</span> </a> </li><li class="astro-5cocwzqt"> <details class="astro-5cocwzqt"> <summary class="astro-5cocwzqt"> <div class="group-label astro-5cocwzqt"> <span class="large undefined astro-5cocwzqt">社区</span> </div> <svg aria-hidden="true" class="caret astro-5cocwzqt astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-color: #818598;--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-5cocwzqt"> <li class="astro-5cocwzqt"> <details open class="astro-5cocwzqt"> <summary class="astro-5cocwzqt"> <div class="group-label astro-5cocwzqt"> <span class="large large-weight text-13px astro-5cocwzqt">社区</span> </div> <svg aria-hidden="true" class="caret astro-5cocwzqt astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-color: #818598;--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-5cocwzqt"> <li class="astro-5cocwzqt"> <a href="https://github.com/nacos-group/nacos-group.github.io/issues" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">报告文档问题</span> </a> </li><li class="astro-5cocwzqt"> <a href="https://github.com/alibaba/nacos/pulls" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">贡献社区</span> </a> </li><li class="astro-5cocwzqt"> <a href="https://github.com/alibaba/nacos/graphs/contributors" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">贡献者</span> </a> </li> </ul>  </details> </li><li class="astro-5cocwzqt"> <details open class="astro-5cocwzqt"> <summary class="astro-5cocwzqt"> <div class="group-label astro-5cocwzqt"> <span class="large large-weight text-13px astro-5cocwzqt">事件</span> </div> <svg aria-hidden="true" class="caret astro-5cocwzqt astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-color: #818598;--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-5cocwzqt"> <li class="astro-5cocwzqt"> <a href="/news/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">新闻</span> </a> </li><li class="astro-5cocwzqt"> <a href="/activity/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">活动</span> </a> </li> </ul>  </details> </li><li class="astro-5cocwzqt"> <details open class="astro-5cocwzqt"> <summary class="astro-5cocwzqt"> <div class="group-label astro-5cocwzqt"> <span class="large large-weight text-13px astro-5cocwzqt">资源</span> </div> <svg aria-hidden="true" class="caret astro-5cocwzqt astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-color: #818598;--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-5cocwzqt"> <li class="astro-5cocwzqt"> <a href="/blog/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">博客</span> </a> </li><li class="astro-5cocwzqt"> <a href="/docs/ebook/kbyo6n/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">电子书</span> </a> </li><li class="astro-5cocwzqt"> <a href="/download/nacos-server/" class="flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">版本下载</span> </a> </li> </ul>  </details> </li> </ul>  </details> </li><li class="astro-5cocwzqt"> <a href="http://console.nacos.io/nacos/index.html" class="large flex items-center astro-5cocwzqt"> <span class="astro-5cocwzqt">控制台样例</span> </a> </li> </ul>  </div> </div> </div>   </div> <div class="center-content h-full astro-4xcajfft" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"> <navbar-component class="navbar-component h-full astro-353qvbhl"> <div class="pc-navbar pc-navbar h-full astro-4xcajfft astro-353qvbhl"> <toggle-component data-trigger="hover" class="toggle-component h-full astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;"> <div class="toggle-trigger cursor-pointer flex items-center h-full item  astro-353qvbhl astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;">  <div class="toggle-text flex items-center justify-center h-full  astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;">文档</div>  <svg width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg" data-updown class="ml-2 astro-bjnabz2w"> <path d="M8.05264 2L5.05264 5.00649L2.05264 2" stroke="#a3a6b3" stroke-width="1.25" stroke-linecap="square"></path> </svg> </div> <div class="toggle-dropdown w-fit inset-x-0 astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;">  <docs-menu class="dropdown-docs block bg-gray-13 rounded-lg"> <ul class="w-[9.25rem] list-none m-0 p-2"> <li class="no-underline cursor-pointer my-1 rounded-lg  hover:bg-gray-12"> <a href="/docs/latest/what-is-nacos/" class="inline-block w-full p-2 no-underline text-inherit text-gray-02"> 最新版（Latest） </a> </li><li class="no-underline cursor-pointer my-1 rounded-lg  hover:bg-gray-12"> <a href="/docs/next/what-is-nacos/" class="inline-block w-full p-2 no-underline text-inherit text-gray-02"> 预览版（Next） </a> </li><li class="no-underline cursor-pointer my-1 rounded-lg  hover:bg-gray-12"> <a href="/docs/v2/what-is-nacos/" class="inline-block w-full p-2 no-underline text-inherit text-gray-02"> 2.x </a> </li><li class="no-underline cursor-pointer my-1 rounded-lg  hover:bg-gray-12"> <a href="/docs/v1/what-is-nacos/" class="inline-block w-full p-2 no-underline text-inherit text-gray-02"> 1.x </a> </li> </ul> </docs-menu>   </div> </toggle-component>  <toggle-component data-trigger="click" class="toggle-component h-full astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;"> <div class="toggle-trigger cursor-pointer flex items-center h-full item  astro-353qvbhl astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;">  <a href="/cloud/" target="_self" class="toggle-text flex items-center justify-center no-underline h-full  astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;"> 企业版 NACOS </a>   </div>  </toggle-component>  <toggle-component data-trigger="hover" class="toggle-component h-full astro-bjnabz2w" style="--position: fixed;--top: 3.5rem;"> <div class="toggle-trigger cursor-pointer flex items-center h-full item  astro-353qvbhl astro-bjnabz2w" style="--position: fixed;--top: 3.5rem;">  <div class="toggle-text flex items-center justify-center h-full toggle-text-active astro-bjnabz2w" style="--position: fixed;--top: 3.5rem;">社区</div>  <svg width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg" data-updown class="ml-2 astro-bjnabz2w"> <path d="M8.05264 2L5.05264 5.00649L2.05264 2" stroke="#a3a6b3" stroke-width="1.25" stroke-linecap="square"></path> </svg> </div> <div class="toggle-dropdown w-fit inset-x-0 astro-bjnabz2w" style="--position: fixed;--top: 3.5rem;">  <community-menu class="dropdown-docs w-screen h-screen flex flex-col justify-start items-center astro-flqstbf2"> <div class="bg-gray-14 p-10 w-full flex justify-center astro-flqstbf2"> <div class="w-fit astro-flqstbf2"> <div class="flex justify-between mb-[3.5rem] astro-flqstbf2"> <div class="flex astro-flqstbf2"> <!-- 社区label --> <div class="border-l border-gray-12 flex flex-col px-7 min-w-[12rem] astro-flqstbf2"> <span class="text-xs text-gray-10 mb-2 astro-flqstbf2">社区</span> <a href="https://github.com/nacos-group/nacos-group.github.io/issues" target="_blank" class="link-text cursor-pointer no-underline flex items-center w-fit text-sm text-gray-02 mt-3 astro-flqstbf2 astro-2wthaofy"> 报告文档问题  <svg fill="none" version="1.1" width="8" height="8" viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="link-icon  ml-2 astro-2wthaofy"> <g transform="matrix(-1,0,0,1,16,0)" class="astro-2wthaofy"><path d="M9.27237,2.16302L9.27237,6.99801Q9.27237,7.26839,9.08915,7.45161Q8.905925,7.63483,8.636183,7.6342Q8.365805,7.6342,8.183221,7.45097Q8.000636137,7.26775,8,6.99801L8,0.636183Q8,0.365805,8.183221,0.183221Q8.366441,0.000636364,8.636183,0L14.99801,0Q15.26839,0,15.451609999999999,0.183221Q15.634830000000001,0.366441,15.63419,0.636183Q15.63419,0.906561,15.45097,1.08978Q15.26775,1.273,14.99801,1.27237L10.16302,1.27237L15.825050000000001,6.93439Q16,7.10935,16,7.37972Q16,7.6501,15.825050000000001,7.82505Q15.6501,8,15.379719999999999,8Q15.10935,8,14.93439,7.82505L9.27237,2.16302Z" fill="#EBECEF" fill-opacity="1" class="astro-2wthaofy"></path></g> </svg>  </a> <a href="https://github.com/alibaba/nacos/pulls" target="_blank" class="link-text cursor-pointer no-underline flex items-center w-fit text-sm text-gray-02 mt-3 astro-flqstbf2 astro-2wthaofy"> 贡献社区  <svg fill="none" version="1.1" width="8" height="8" viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="link-icon  ml-2 astro-2wthaofy"> <g transform="matrix(-1,0,0,1,16,0)" class="astro-2wthaofy"><path d="M9.27237,2.16302L9.27237,6.99801Q9.27237,7.26839,9.08915,7.45161Q8.905925,7.63483,8.636183,7.6342Q8.365805,7.6342,8.183221,7.45097Q8.000636137,7.26775,8,6.99801L8,0.636183Q8,0.365805,8.183221,0.183221Q8.366441,0.000636364,8.636183,0L14.99801,0Q15.26839,0,15.451609999999999,0.183221Q15.634830000000001,0.366441,15.63419,0.636183Q15.63419,0.906561,15.45097,1.08978Q15.26775,1.273,14.99801,1.27237L10.16302,1.27237L15.825050000000001,6.93439Q16,7.10935,16,7.37972Q16,7.6501,15.825050000000001,7.82505Q15.6501,8,15.379719999999999,8Q15.10935,8,14.93439,7.82505L9.27237,2.16302Z" fill="#EBECEF" fill-opacity="1" class="astro-2wthaofy"></path></g> </svg>  </a> <a href="https://github.com/alibaba/nacos/graphs/contributors" target="_blank" class="link-text cursor-pointer no-underline flex items-center w-fit text-sm text-gray-02 mt-3 astro-flqstbf2 astro-2wthaofy"> 贡献者  <svg fill="none" version="1.1" width="8" height="8" viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="link-icon  ml-2 astro-2wthaofy"> <g transform="matrix(-1,0,0,1,16,0)" class="astro-2wthaofy"><path d="M9.27237,2.16302L9.27237,6.99801Q9.27237,7.26839,9.08915,7.45161Q8.905925,7.63483,8.636183,7.6342Q8.365805,7.6342,8.183221,7.45097Q8.000636137,7.26775,8,6.99801L8,0.636183Q8,0.365805,8.183221,0.183221Q8.366441,0.000636364,8.636183,0L14.99801,0Q15.26839,0,15.451609999999999,0.183221Q15.634830000000001,0.366441,15.63419,0.636183Q15.63419,0.906561,15.45097,1.08978Q15.26775,1.273,14.99801,1.27237L10.16302,1.27237L15.825050000000001,6.93439Q16,7.10935,16,7.37972Q16,7.6501,15.825050000000001,7.82505Q15.6501,8,15.379719999999999,8Q15.10935,8,14.93439,7.82505L9.27237,2.16302Z" fill="#EBECEF" fill-opacity="1" class="astro-2wthaofy"></path></g> </svg>  </a>  </div> <!-- 事件、资源label --> <div class="border-l border-gray-12 flex flex-col px-7 mr-10 astro-flqstbf2"> <span class="text-xs text-gray-10 mb-2 astro-flqstbf2">事件</span> <a href="/news/" target="_self" class="link-text cursor-pointer no-underline flex items-center w-fit text-sm text-gray-02 mt-3 astro-flqstbf2 astro-2wthaofy"> 新闻  <svg fill="none" version="1.1" width="8" height="8" viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="link-icon  ml-2 astro-2wthaofy"> <g transform="matrix(-1,0,0,1,16,0)" class="astro-2wthaofy"><path d="M9.27237,2.16302L9.27237,6.99801Q9.27237,7.26839,9.08915,7.45161Q8.905925,7.63483,8.636183,7.6342Q8.365805,7.6342,8.183221,7.45097Q8.000636137,7.26775,8,6.99801L8,0.636183Q8,0.365805,8.183221,0.183221Q8.366441,0.000636364,8.636183,0L14.99801,0Q15.26839,0,15.451609999999999,0.183221Q15.634830000000001,0.366441,15.63419,0.636183Q15.63419,0.906561,15.45097,1.08978Q15.26775,1.273,14.99801,1.27237L10.16302,1.27237L15.825050000000001,6.93439Q16,7.10935,16,7.37972Q16,7.6501,15.825050000000001,7.82505Q15.6501,8,15.379719999999999,8Q15.10935,8,14.93439,7.82505L9.27237,2.16302Z" fill="#EBECEF" fill-opacity="1" class="astro-2wthaofy"></path></g> </svg>  </a> <a href="/activity/" target="_self" class="link-text cursor-pointer no-underline flex items-center w-fit text-sm text-gray-02 mt-3 astro-flqstbf2 astro-2wthaofy"> 活动  <svg fill="none" version="1.1" width="8" height="8" viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="link-icon  ml-2 astro-2wthaofy"> <g transform="matrix(-1,0,0,1,16,0)" class="astro-2wthaofy"><path d="M9.27237,2.16302L9.27237,6.99801Q9.27237,7.26839,9.08915,7.45161Q8.905925,7.63483,8.636183,7.6342Q8.365805,7.6342,8.183221,7.45097Q8.000636137,7.26775,8,6.99801L8,0.636183Q8,0.365805,8.183221,0.183221Q8.366441,0.000636364,8.636183,0L14.99801,0Q15.26839,0,15.451609999999999,0.183221Q15.634830000000001,0.366441,15.63419,0.636183Q15.63419,0.906561,15.45097,1.08978Q15.26775,1.273,14.99801,1.27237L10.16302,1.27237L15.825050000000001,6.93439Q16,7.10935,16,7.37972Q16,7.6501,15.825050000000001,7.82505Q15.6501,8,15.379719999999999,8Q15.10935,8,14.93439,7.82505L9.27237,2.16302Z" fill="#EBECEF" fill-opacity="1" class="astro-2wthaofy"></path></g> </svg>  </a>  <span class="text-xs text-gray-10 mb-2 mt-10 astro-flqstbf2">资源</span> <a href="/blog/" target="_self" class="link-text cursor-pointer no-underline flex items-center w-fit text-sm text-gray-02 mt-3 astro-flqstbf2 astro-2wthaofy"> 博客  <svg fill="none" version="1.1" width="8" height="8" viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="link-icon  ml-2 astro-2wthaofy"> <g transform="matrix(-1,0,0,1,16,0)" class="astro-2wthaofy"><path d="M9.27237,2.16302L9.27237,6.99801Q9.27237,7.26839,9.08915,7.45161Q8.905925,7.63483,8.636183,7.6342Q8.365805,7.6342,8.183221,7.45097Q8.000636137,7.26775,8,6.99801L8,0.636183Q8,0.365805,8.183221,0.183221Q8.366441,0.000636364,8.636183,0L14.99801,0Q15.26839,0,15.451609999999999,0.183221Q15.634830000000001,0.366441,15.63419,0.636183Q15.63419,0.906561,15.45097,1.08978Q15.26775,1.273,14.99801,1.27237L10.16302,1.27237L15.825050000000001,6.93439Q16,7.10935,16,7.37972Q16,7.6501,15.825050000000001,7.82505Q15.6501,8,15.379719999999999,8Q15.10935,8,14.93439,7.82505L9.27237,2.16302Z" fill="#EBECEF" fill-opacity="1" class="astro-2wthaofy"></path></g> </svg>  </a> <a href="/docs/ebook/kbyo6n/" target="_self" class="link-text cursor-pointer no-underline flex items-center w-fit text-sm text-gray-02 mt-3 astro-flqstbf2 astro-2wthaofy"> 电子书  <svg fill="none" version="1.1" width="8" height="8" viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="link-icon  ml-2 astro-2wthaofy"> <g transform="matrix(-1,0,0,1,16,0)" class="astro-2wthaofy"><path d="M9.27237,2.16302L9.27237,6.99801Q9.27237,7.26839,9.08915,7.45161Q8.905925,7.63483,8.636183,7.6342Q8.365805,7.6342,8.183221,7.45097Q8.000636137,7.26775,8,6.99801L8,0.636183Q8,0.365805,8.183221,0.183221Q8.366441,0.000636364,8.636183,0L14.99801,0Q15.26839,0,15.451609999999999,0.183221Q15.634830000000001,0.366441,15.63419,0.636183Q15.63419,0.906561,15.45097,1.08978Q15.26775,1.273,14.99801,1.27237L10.16302,1.27237L15.825050000000001,6.93439Q16,7.10935,16,7.37972Q16,7.6501,15.825050000000001,7.82505Q15.6501,8,15.379719999999999,8Q15.10935,8,14.93439,7.82505L9.27237,2.16302Z" fill="#EBECEF" fill-opacity="1" class="astro-2wthaofy"></path></g> </svg>  </a> <a href="/download/nacos-server/" target="_self" class="link-text cursor-pointer no-underline flex items-center w-fit text-sm text-gray-02 mt-3 astro-flqstbf2 astro-2wthaofy"> 版本下载  <svg fill="none" version="1.1" width="8" height="8" viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="link-icon  ml-2 astro-2wthaofy"> <g transform="matrix(-1,0,0,1,16,0)" class="astro-2wthaofy"><path d="M9.27237,2.16302L9.27237,6.99801Q9.27237,7.26839,9.08915,7.45161Q8.905925,7.63483,8.636183,7.6342Q8.365805,7.6342,8.183221,7.45097Q8.000636137,7.26775,8,6.99801L8,0.636183Q8,0.365805,8.183221,0.183221Q8.366441,0.000636364,8.636183,0L14.99801,0Q15.26839,0,15.451609999999999,0.183221Q15.634830000000001,0.366441,15.63419,0.636183Q15.63419,0.906561,15.45097,1.08978Q15.26775,1.273,14.99801,1.27237L10.16302,1.27237L15.825050000000001,6.93439Q16,7.10935,16,7.37972Q16,7.6501,15.825050000000001,7.82505Q15.6501,8,15.379719999999999,8Q15.10935,8,14.93439,7.82505L9.27237,2.16302Z" fill="#EBECEF" fill-opacity="1" class="astro-2wthaofy"></path></g> </svg>  </a>  </div> </div> <!-- 卡片 --> <div class="flex astro-flqstbf2"> <div class="relative w-[16.875] h-[22.5rem] bg-gray-13 rounded-2xl p-2 flex flex-col ml-4 astro-flqstbf2"> <img src="https://img.alicdn.com/imgextra/i4/O1CN01bGnAVW1pFeLFnlaQL_!!6000000005331-2-tps-508-370.png" alt="case nacos" class="rounded-lg astro-flqstbf2" width="254" height="185" loading="lazy" decoding="async"> <p class="w-[15.875rem] text-lg line-clamp-2 mt-3 text-blue-01 astro-flqstbf2"> Nacos Controller 项目开源，支持与Kubernetes互通配置 </p> <a class="flex justify-center items-center w-[8.5rem] h-[2.5rem] absolute bottom-2 text-xs bg-gray-12 text-gray-01 border-0 rounded-3xl no-underline astro-flqstbf2" href="/blog/ecosystem-nacos-controller-opensource/?source=blog_ecosystem"> 阅读文章 </a> </div><div class="relative w-[16.875] h-[22.5rem] bg-gray-13 rounded-2xl p-2 flex flex-col ml-4 astro-flqstbf2"> <img src="https://img.alicdn.com/imgextra/i4/O1CN01zfayJW1Lhe4kliPv9_!!6000000001331-2-tps-508-370.png" alt="case nacos" class="rounded-lg astro-flqstbf2" width="254" height="185" loading="lazy" decoding="async"> <p class="w-[15.875rem] text-lg line-clamp-2 mt-3 text-blue-01 astro-flqstbf2"> Nacos社区2023年底斩获三项开源大奖 </p> <a class="flex justify-center items-center w-[8.5rem] h-[2.5rem] absolute bottom-2 text-xs bg-gray-12 text-gray-01 border-0 rounded-3xl no-underline astro-flqstbf2" href="/blog/announcement-2023-award/?source=news_announcement"> 阅读文章 </a> </div> </div> </div> <!-- 联系我们 --> <div class="w-[70rem] bg-gray-13 flex items-center justify-between rounded-2xl h-9 pl-10 pr-[8.5rem] astro-flqstbf2"> <span class="text-gray-07 text-xs leading-9 tracking-[0.15em] astro-flqstbf2"> 联系我们 </span> <div class="flex items-center cursor-pointer astro-flqstbf2"> <a target="_blank" href="https://github.com/alibaba/nacos" class="mr-16 text-gray-02 flex items-center no-underline astro-flqstbf2"> <svg class="icon astro-flqstbf2" viewBox="0 0 1024 800" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3233" width="16" height="16"> <path d="M20.48 503.72608c0 214.4256 137.4208 396.73856 328.94976 463.6672 25.8048 6.5536 21.87264-11.8784 21.87264-24.33024v-85.07392c-148.93056 17.44896-154.86976-81.1008-164.94592-97.52576-20.23424-34.52928-67.91168-43.33568-53.69856-59.76064 33.91488-17.44896 68.48512 4.42368 108.46208 63.61088 28.95872 42.88512 85.44256 35.6352 114.15552 28.4672a138.8544 138.8544 0 0 1 38.0928-66.7648c-154.25536-27.60704-218.60352-121.77408-218.60352-233.79968 0-54.31296 17.94048-104.2432 53.0432-144.54784-22.36416-66.43712 2.08896-123.24864 5.3248-131.6864 63.81568-5.7344 130.00704 45.6704 135.168 49.68448 36.2496-9.78944 77.57824-14.9504 123.82208-14.9504 46.4896 0 88.064 5.3248 124.5184 15.23712 12.288-9.4208 73.80992-53.53472 133.12-48.128 3.15392 8.43776 27.0336 63.93856 6.02112 129.4336 35.59424 40.38656 53.69856 90.76736 53.69856 145.24416 0 112.18944-64.7168 206.4384-219.42272 233.71776a140.0832 140.0832 0 0 1 41.7792 99.9424v123.4944c0.86016 9.87136 0 19.6608 16.50688 19.6608 194.31424-65.49504 334.2336-249.15968 334.2336-465.5104C1002.57792 232.48896 782.66368 12.77952 511.5904 12.77952 240.18944 12.65664 20.48 232.40704 20.48 503.72608z" fill="#567BE1" opacity=".65" p-id="3234" class="astro-flqstbf2"></path> </svg> <span class="ml-2 mt-1 text-sm text-gray-02 astro-flqstbf2">GitHub</span> </a> <div class="mr-16 hoverable relative astro-flqstbf2"> <img class="tooltip hidden w-40 absolute bottom-9 astro-flqstbf2" src="https://img.alicdn.com/imgextra/i4/O1CN01ivNLl61l6i93SDfcz_!!6000000004770-0-tps-854-1102.jpg" alt=""> <span class="text-gray-02 flex items-center astro-flqstbf2"> <svg class="icon astro-flqstbf2" viewBox="0 0 1024 800" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4747" width="16" height="16"> <path d="M0 0h1024v1024H0z" fill="#567BE1" fill-opacity="0" p-id="4748" class="astro-flqstbf2"></path><path d="M786.978133 481.6896c-153.770667-117.5552-327.133867-273.237333-517.188266-440.183467-14.984533-13.141333-28.2624-7.953067-34.952534 9.5232-42.8032 111.957333-1.297067 211.421867 65.774934 268.731734 67.345067 57.582933 167.492267 110.592 228.829866 138.683733 2.389333 1.092267 0.3072 4.573867-2.116266 3.515733-112.674133-49.152-191.044267-84.650667-297.3696-165.819733-11.434667-8.738133-23.04-5.3248-24.405334 11.707733-8.704 107.042133 60.484267 191.146667 137.728 219.5456 47.786667 17.6128 100.0448 27.3408 148.548267 33.109334 2.525867 0.341333 1.9456 4.027733-0.580267 4.027733-62.498133 0.2048-138.001067-14.609067-203.332266-39.458133-13.789867-5.256533-18.5344 5.632-16.418134 14.267733 11.1616 45.226667 67.652267 114.346667 157.5936 128.887467 16.827733 2.730667 34.747733 3.072 50.722134 2.628266 3.7888-0.136533 4.7104 1.9456 3.4816 4.846934 0 0-61.098667 103.6288-63.761067 108.066133-2.082133 3.447467-0.8192 6.212267 3.515733 6.212267h80.622934c3.754667 0 6.0416 2.389333 4.096 5.5296-1.877333 3.140267-107.656533 176.7424-112.64 185.0368-4.369067 7.202133 0.785067 12.731733 8.942933 6.826666 8.192-5.9392 346.180267-250.88 355.805867-257.911466 4.437333-3.208533 3.413333-7.5776-2.833067-7.5776h-72.2944c-4.744533 0-5.768533-3.140267-2.56-6.314667 3.242667-3.1744 82.090667-80.964267 110.08-110.08 29.184-30.378667 44.100267-86.050133-5.290667-123.8016" fill="#567BE1" p-id="4749" class="astro-flqstbf2"></path> </svg> <span class="ml-2 mt-1 text-sm text-gray-02 astro-flqstbf2">钉钉</span> </span> </div> <a href="mailto:nacos_dev@linux.alibaba.com" class="text-gray-02 flex items-center no-underline astro-flqstbf2"> <svg class="icon astro-flqstbf2" viewBox="0 0 1024 800" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5876" width="16" height="16"> <path d="M953.344 190.4l-409.6 326.528a53.376 53.376 0 0 1-63.488 0l-409.6-326.528c14.976-12.8 33.984-19.84 53.696-19.712h775.296c20.608 0 39.36 7.424 53.696 19.712z m27.968 82.112v500.672c0 44.288-36.48 80.128-81.664 80.128H124.352c-45.12 0-81.664-35.84-81.664-80.128V272.512l405.76 323.52c35.072 27.968 92.096 27.904 127.104 0l405.76-323.52z" fill="#567BE1" p-id="5877" class="astro-flqstbf2"></path> </svg> <span class="ml-2 mt-1 text-sm text-gray-02 astro-flqstbf2">电子邮箱</span> </a> </div> </div> </div> </div> <div class="dropdown-overlay w-full flex-1 bg-gray-14/[0.4] backdrop-blur-md astro-flqstbf2"></div> </community-menu>    </div> </toggle-component>  <toggle-component data-trigger="click" class="toggle-component h-full astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;"> <div class="toggle-trigger cursor-pointer flex items-center h-full item item-last-child astro-353qvbhl astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;">  <a href="http://console.nacos.io/nacos/index.html" target="_blank" class="toggle-text flex items-center justify-center no-underline h-full  astro-bjnabz2w" style="--position: absolute;--top: 3.5rem;"> 控制台样例 </a>   </div>  </toggle-component>   </div> </navbar-component>   </div> <div class="right-content flex items-center astro-4xcajfft" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"> <!-- <button> 可以设置默认样式 --><button class="button w-fit p-0 bg-transparent astro-bweis6se"> <a href="https://github.com/alibaba/nacos" target="_blank" class="button-primary flex items-center justify-center no-underline  xp-medium h-medium  code-toggle rounded-3xl mr-3 astro-4xcajfft astro-bweis6se">  <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="none" version="1.1" width="15" height="15" viewBox="0 0 15 15" class="astro-4xcajfft" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"><g class="astro-4xcajfft" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"><path d="M7.50084,6.72409e-7C3.35661,-0.0017207,0,3.44446,0,7.69796C0,11.0615,2.09977,13.9207,5.02402,14.9707C5.41783,15.0723,5.3575,14.7848,5.3575,14.5886L5.3575,13.2545C3.08345,13.5282,2.99129,11.9824,2.83879,11.7242C2.53044,11.1837,1.80147,11.046,2.01933,10.7878C2.53715,10.5141,3.06502,10.8567,3.67668,11.7845C4.11909,12.4575,4.98212,12.3439,5.41951,12.232C5.51503,11.8275,5.71947,11.466,6.00101,11.1854C3.64484,10.7517,2.66283,9.27473,2.66283,7.51894C2.66283,6.66686,2.93598,5.88364,3.47224,5.25189C3.13038,4.21047,3.50408,3.3188,3.55435,3.18625C4.52799,3.09674,5.54016,3.90234,5.61892,3.96603C6.17194,3.81283,6.80371,3.73193,7.51089,3.73193C8.22143,3.73193,8.85488,3.81627,9.41291,3.9712C9.60228,3.82316,10.5407,3.13117,11.4456,3.21552C11.4942,3.34806,11.8596,4.21907,11.5378,5.24673C12.0808,5.88019,12.3573,6.6703,12.3573,7.5241C12.3573,9.28334,11.3686,10.762,9.0057,11.1889C9.39951,11.5882,9.64417,12.1425,9.64417,12.7553L9.64417,14.6919C9.65758,14.8468,9.64417,15,9.89554,15C12.8634,13.9723,15,11.0925,15,7.69968C15,3.44446,11.6417,6.72409e-7,7.50084,6.72409e-7Z" fill="#C7C9D1" fill-opacity="1" class="astro-4xcajfft" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;"></path></g></svg> <span class="text-xs ml-2 astro-4xcajfft" style="--width: 100%;--height: 3.5rem;--xpadding: 1.5rem;">前往 GitHub</span>   </a> </button>  <div class="astro-vx7jrovw" style="--size: small;"> <toggle-content class="switch float-left relative m-0 rounded-[2rem] max-md:hidden astro-vx7jrovw" style="--size: small;"> <input data-switch class="switch-checkbox hidden astro-vx7jrovw" id="pc-toggle-switch" type="checkbox" style="--size: small;"> <label class="switch-label block overflow-hidden cursor-pointer rounded-[2rem] astro-vx7jrovw" for="pc-toggle-switch" style="--size: small;"> <span class="switch-inner block astro-vx7jrovw" data-on="中文" data-off="EN" style="--size: small;"></span> <span class="switch-switch absolute float-right mx-1 astro-vx7jrovw" style="--size: small;"></span> </label> </toggle-content> <div data-switch class="w-[3.5rem] h-[1.5rem] leading-[1.5rem] text-xs text-center rounded-2xl bg-gray-12 text-white max-md:inline-block md:hidden astro-vx7jrovw" id="pc-toggle-switch" style="--size: small;"> 中文 </div> </div>   </div> </div> </my-layout>    <div class="astro-7jjqptxk"> <div class="w-[20%] sidebar-content fixed overflow-auto h-full hidden 2xl:inline-block xl:inline-block lg:inline-block md:inline-block astro-7jjqptxk"> <blog-theme> <ul class="top-level astro-6srjw6so"> <li class="astro-6srjw6so"> <details open class="astro-6srjw6so"> <summary class="astro-6srjw6so"> <div class="group-label astro-6srjw6so"> <span class="large astro-6srjw6so">技术文章</span>  </div> <svg aria-hidden="true" class="caret astro-6srjw6so astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.25rem;"><path d="m14.83 11.29-4.24-4.24a1 1 0 1 0-1.42 1.41L12.71 12l-3.54 3.54a1 1 0 0 0 0 1.41 1 1 0 0 0 .71.29 1 1 0 0 0 .71-.29l4.24-4.24a1.002 1.002 0 0 0 0-1.42Z"/></svg>  </summary> <ul class="astro-6srjw6so"> <li class="astro-6srjw6so"> <a href="/blog/article-nacos-reigster-mechanism/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos 的一条注册请求会经历什么？</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-nacos30-is-coming/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">我们总结了3大使用建议，并首次公开 Nacos3.0 规划图 | Nacos 开源4周年</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-up-to-2w-star/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">双十一献礼 | Nacos Star破两万的回顾与展望</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-performance-compare/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos 2.0 升级前后性能对比压测</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-nacos-distro-mechanism/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos 的 Distro 一致性协议</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-feeling-of-asoc-2019/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">参与开源，Offer拿到手软 -- 来自一名2019阿里巴巴编程之夏同学的亲述</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-nacos120-guide/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos 1.2.0权限控制介绍和使用</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-nacos130-design/" aria-current="page" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos 1.3.0 全新内核构建过程</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-pilot-mcp/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Pilot MCP协议介绍</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-nacos-roadmap/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos GA后的整体规划</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-5w1h-where/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos 有哪些典型的应用场景？—— 配置管理篇</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-5w1h-what/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos 帮我们解决什么问题？—— 配置管理篇</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-discovery-console/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">Nacos服务发现控制台预览</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-nacos-is-coming/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">支持Dubbo生态发展，阿里巴巴启动新的开源项目 Nacos</span>   </a> </li><li class="astro-6srjw6so"> <a href="/blog/article-alibaba-configserver/" class="flex items-center astro-6srjw6so"> <span class="astro-6srjw6so">阿里巴巴服务注册中心产品ConfigServer 10年技术发展回顾</span>   </a> </li> </ul>  </details> </li> </ul>  </blog-theme>  </div> <div class=" w-full 2xl:ml-[20%] xl:ml-[20%] lg:ml-[20%] md:ml-[20%] 2xl:w-[50%] xl:w-[50%] lg:w-[50%] md:w-[50%] inline-block astro-7jjqptxk"> <div id="back-btn" class="pt-4 pl-6 astro-7jjqptxk"> <!-- <button> 可以设置默认样式 --><button class="button w-fit p-0 bg-transparent astro-bweis6se"> <a target="_self" class="button-normal flex items-center justify-center no-underline  xp-medium h-medium  rounded-3xl astro-7jjqptxk astro-bweis6se">  <svg aria-hidden="true" class="text-lg align-middle astro-7jjqptxk astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1em;"><path d="M17 11H9.41l3.3-3.29a1.004 1.004 0 1 0-1.42-1.42l-5 5a1 1 0 0 0-.21.33 1 1 0 0 0 0 .76 1 1 0 0 0 .21.33l5 5a1.002 1.002 0 0 0 1.639-.325 1 1 0 0 0-.219-1.095L9.41 13H17a1 1 0 0 0 0-2Z"/></svg>  <span class="ml-1 astro-7jjqptxk">BACK</span>   </a> </button>  </div> <div class="sl-markdown-content astro-xvyu6ype"> <div class="hero-image astro-xvyu6ype">  </div> <main class="astro-xvyu6ype"> <div class="nacos-prose mx-auto astro-xvyu6ype"> <div class="title astro-xvyu6ype"> <h1 id="_top" class="astro-xvyu6ype">Nacos 1.3.0 全新内核构建过程</h1> <div class="date astro-xvyu6ype"> <time datetime="2020-02-12T00:00:00.000Z"> 2020年2月12日 </time>  </div> <hr class="astro-xvyu6ype"> </div>  <h1 id="nacos-130-特性以及功能使用文档">Nacos 1.3.0 特性以及功能使用文档</h1>
<p><a name="0YIG0"></a></p>
<h2 id="概述">概述</h2>
<p>本次1.3.0的改动程度很大，涉及两大模块的修改以及新增一个核心模块</p>
<ol>
<li>nacos-core模块修改
<ol>
<li>nacos集群节点成员寻址模式的统一管理</li>
<li>nacos内部事件机制</li>
<li>nacos一致性协议层</li>
</ol>
</li>
<li>nacos-config模块修改
<ol>
<li>新增内嵌分布式数据存储组件</li>
<li>内嵌存储与外置存储细分</li>
<li>内嵌存储简单运维</li>
</ol>
</li>
<li>nacos-consistency模块新增
<ol>
<li>对于AP协议以及CP协议的统一抽象</li>
</ol>
</li>
</ol>
<br>
<p><a name="rnkDY"></a></p>
<h2 id="系统参数变化">系统参数变化</h2>
<p><a name="1Gmg9"></a></p>
<h3 id="新增">新增</h3>



































<table><thead><tr><th align="center"><strong>core模块</strong></th><th>nacos.watch-file.max-dirs</th><th>JVM参数</th><th>最大可监听目录数量</th></tr></thead><tbody><tr><td align="center"></td><td>nacos.core.notify.ring-buffer-size</td><td>JVM参数</td><td>快速通知队列的最大长度</td></tr><tr><td align="center"></td><td>nacos.core.notify.share-buffer-size</td><td>JVM参数</td><td>慢速通知队列的最大长度</td></tr><tr><td align="center"></td><td>nacos.core.member.fail-access-cnt</td><td>JVM参数、application.properties配置</td><td>集群成员节点最大失败访问次数</td></tr><tr><td align="center"></td><td>nacos.core.address-server.retry</td><td>JVM参数、application.properties配置</td><td>地址服务器寻址模式，首次启动请求重试次数</td></tr></tbody></table>
<br>
<p><a name="kxo8O"></a></p>
<h2 id="nacos的未来整体逻辑架构及其组件">Nacos的未来整体逻辑架构及其组件</h2>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587129046320-5a286f38-8db4-4e76-9b42-8bd859f51a60.png#align=left&#x26;display=inline&#x26;height=1184&#x26;margin=%5Bobject%20Object%5D&#x26;name=1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png&#x26;originHeight=1184&#x26;originWidth=1608&#x26;size=279074&#x26;status=done&#x26;style=none&#x26;width=1608" alt="1561217775318-6e408805-18bb-4242-b4e9-83c5b929b469.png" referrerpolicy="no-referrer"></p>
<p><a name="Hyc6u"></a></p>
<h2 id="nacos集群成员节点寻址模式">Nacos集群成员节点寻址模式</h2>
<p><br>在1.3.0之前，nacos的naming模块以及config模块存在各自的集群成员节点列表管理任务。为了统一nacos集群下成员列表的寻址模式，将集群节点管理的实现从naming模块以及config模块剥离出来，统一下沉到了core模块的寻址模，同时新增命令行参数 **-Dnacos.member.list **进行设置nacos集群节点列表，该参数可以看作是cluster.conf文件的一个替代。目前nacos的寻址模式类别如下</p>
<ol>
<li>单机模式下：StandaloneMemberLookup</li>
<li>集群模式
<ol>
<li>cluster.conf文件存在：FileConfigMemberLookup</li>
<li>cluster.conf文件不存在或者 -Dnacos.member.list没有设置：AddressServerMemberLookup</li>
</ol>
</li>
</ol>
<p>如果说想指定某一种寻址模式，则设置此参数：<strong>nacos.core.member.lookup.type=[file,address-server]</strong></p>
<p>逻辑图如下
<img src="https://cdn.nlark.com/yuque/__puml/e209a677aa8b5ffce23589e987ee5129.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJMb29rdXBGYWN0b3J5LmluaXQoKVwiXG5cbmlmIFwic3RhbmRhbG9uZSBtb2RlXCIgdGhlblxuICAtLT5bdHJ1ZV0gXCJyZXR1cm4gU3RhbmRhbG9uZU1lbWJlckxvb2t1cFwiXG4gIC0tPiBMb29rdXAucnVuKClcbmVsc2VcbiBpZiBcImNsdXN0ZXIuY29uZiBleGlzdHNcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIEZpbGVDb25maWdNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbHNlXG4gICAgLT5bZmFsc2VdIFwicmV0dXJuIEFkZHJlc3NTZXJ2ZXJNZW1iZXJMb29rdXBcIlxuICAgIC0tPiBMb29rdXAucnVuKClcbiBlbmRpZlxuZW5kaWZcblxuLS0-ICgqKVxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJpZCI6IlplWGtkIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9lMjA5YTY3N2FhOGI1ZmZjZTIzNTg5ZTk4N2VlNTEyOS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt="" referrerpolicy="no-referrer"></p>
<p><a name="wqkMp"></a></p>
<h3 id="寻址模式详细">寻址模式详细</h3>
<p>接下来介绍除了单机模式下的寻址模式的其他两种寻址模式<br></p>
<p><a name="egl3H"></a></p>
<h4 id="fileconfigmemberlookup">FileConfigMemberLookup</h4>
<p>该寻址模式是基于cluster.conf文件进行管理的，每个节点会读取各自${nacos.home}/conf下的cluster.conf文件内的成员节点列表，然后组成一个集群。并且在首次读取完${nacos.home}/conf下的cluster.conf文件后，会自动向操作系统的_<strong>inotify</strong>_机制注册一个目录监听器，监听${nacos.home}/conf目录下的所有文件变动（注意，这里只会监听文件，对于子目录下的文件变动无法监听）<br>当需要进行集群节点扩缩容时，需要手动去修改每个节点各自${nacos.home}/conf下的cluster.conf的成员节点列表内容。</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.rfn4o.css"><script type="module" src="/_astro/ec.sgewm.js"></script><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> FileWatcher watcher </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">FileWatcher</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    @</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">onChange</span><span style="--0:#E1E4E8">(FileChangeEvent </span><span style="--0:#FFAB70">event</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#B392F0">readClusterConfFromDisk</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    @</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">interest</span><span style="--0:#E1E4E8">(String </span><span style="--0:#FFAB70">context</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> StringUtils.</span><span style="--0:#B392F0">contains</span><span style="--0:#E1E4E8">(context, </span><span style="--0:#9ECBFF">"cluster.conf"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">};</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">@</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">start</span><span style="--0:#E1E4E8">() throws NacosException {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#B392F0">readClusterConfFromDisk</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (memberManager.</span><span style="--0:#B392F0">getServerList</span><span style="--0:#E1E4E8">().</span><span style="--0:#B392F0">isEmpty</span><span style="--0:#E1E4E8">()) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">throw</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">NacosException</span><span style="--0:#E1E4E8">(NacosException.SERVER_ERROR,</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#9ECBFF">"Failed to initialize the member node, is empty"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// Use the inotify mechanism to monitor file changes and automatically</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// trigger the reading of cluster.conf</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">try</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    WatchFileCenter.</span><span style="--0:#B392F0">registerWatcher</span><span style="--0:#E1E4E8">(ApplicationUtils.</span><span style="--0:#B392F0">getConfFilePath</span><span style="--0:#E1E4E8">(), watcher);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">catch</span><span style="--0:#E1E4E8"> (Throwable </span><span style="--0:#FFAB70">e</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Loggers.CLUSTER.</span><span style="--0:#B392F0">error</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"An exception occurred in the launch file monitor : {}"</span><span style="--0:#E1E4E8">, e);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private FileWatcher watcher = new FileWatcher() {    @Override    public void onChange(FileChangeEvent event) {      readClusterConfFromDisk();    }    @Override    public boolean interest(String context) {      return StringUtils.contains(context, &#x22;cluster.conf&#x22;);    }};@Overridepublic void start() throws NacosException {  readClusterConfFromDisk();  if (memberManager.getServerList().isEmpty()) {    throw new NacosException(NacosException.SERVER_ERROR,          &#x22;Failed to initialize the member node, is empty&#x22;);  }  // Use the inotify mechanism to monitor file changes and automatically  // trigger the reading of cluster.conf  try {    WatchFileCenter.registerWatcher(ApplicationUtils.getConfFilePath(), watcher);  }  catch (Throwable e) {    Loggers.CLUSTER.error(&#x22;An exception occurred in the launch file monitor : {}&#x22;, e);  }}"><div></div></button></div></figure></div>
<p>首次启动时直接读取cluster.conf文件内的节点列表信息，然后向WatchFileCenter注册一个目录监听器，当cluster.conf文件发生变动时自动触发_<strong>readClusterConfFromDisk()</strong>_重新读取cluster.conf文件<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014354207-49c1e934-2aa5-465a-8a2b-0b09902814f8.png#align=left&#x26;display=inline&#x26;height=531&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=531&#x26;originWidth=1169&#x26;size=105696&#x26;status=done&#x26;style=none&#x26;width=1169" alt="image.png" referrerpolicy="no-referrer"></p>
<p><a name="yFTCl"></a></p>
<h4 id="addressservermemberlookup">AddressServerMemberLookup</h4>
<p>该寻址模式是基于一个额外的web服务器来管理cluster.conf，每个节点定期向该web服务器请求cluster.conf的文件内容，然后实现集群节点间的寻址，以及扩缩容。<br>当需要进行集群扩缩容时，只需要修改cluster.conf文件即可，然后每个节点向地址服务器请求时会自动的得到最新的cluster.conf文件内容。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">@</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">start</span><span style="--0:#E1E4E8">() throws NacosException {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (start.</span><span style="--0:#B392F0">compareAndSet</span><span style="--0:#E1E4E8">(</span><span style="--0:#79B8FF">false</span><span style="--0:#E1E4E8">, </span><span style="--0:#79B8FF">true</span><span style="--0:#E1E4E8">)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.maxFailCount </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> Integer.</span><span style="--0:#B392F0">parseInt</span><span style="--0:#E1E4E8">(ApplicationUtils.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"maxHealthCheckFailCount"</span><span style="--0:#E1E4E8">, </span><span style="--0:#9ECBFF">"12"</span><span style="--0:#E1E4E8">));</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">initAddressSys</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">run</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">initAddressSys</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  String envDomainName </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getenv</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address_server_domain"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (StringUtils.</span><span style="--0:#B392F0">isBlank</span><span style="--0:#E1E4E8">(envDomainName)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    domainName </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address.server.domain"</span><span style="--0:#E1E4E8">, </span><span style="--0:#9ECBFF">"jmenv.tbsite.net"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  } </span><span style="--0:#F97583">else</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    domainName </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> envDomainName;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  String envAddressPort </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getenv</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address_server_port"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (StringUtils.</span><span style="--0:#B392F0">isBlank</span><span style="--0:#E1E4E8">(envAddressPort)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    addressPort </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address.server.port"</span><span style="--0:#E1E4E8">, </span><span style="--0:#9ECBFF">"8080"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  } </span><span style="--0:#F97583">else</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    addressPort </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> envAddressPort;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  addressUrl </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> System.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"address.server.url"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">        ApplicationUtils.</span><span style="--0:#B392F0">getContextPath</span><span style="--0:#E1E4E8">() </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"/"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"serverlist"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  addressServerUrl </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"http://"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> domainName </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">":"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressPort </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressUrl;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  envIdUrl </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"http://"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> domainName </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">":"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressPort </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"/env"</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  Loggers.CORE.</span><span style="--0:#B392F0">info</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"ServerListService address-server port:"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressPort);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  Loggers.CORE.</span><span style="--0:#B392F0">info</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"ADDRESS_SERVER_URL:"</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> addressServerUrl);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">@</span><span style="--0:#F97583">SuppressWarnings</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"PMD.UndefineMagicConstantRule"</span><span style="--0:#E1E4E8">)</span></div><div class="ec-line"><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">run</span><span style="--0:#E1E4E8">() throws NacosException {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// With the address server, you need to perform a synchronous member node pull at startup</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// Repeat three times, successfully jump out</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> success </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">false</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  Throwable ex </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> maxRetry </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> ApplicationUtils.</span><span style="--0:#B392F0">getProperty</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"nacos.core.address-server.retry"</span><span style="--0:#E1E4E8">, Integer.class, </span><span style="--0:#79B8FF">5</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">for</span><span style="--0:#E1E4E8"> (</span><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> i </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">0</span><span style="--0:#E1E4E8">; i </span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8"> maxRetry; i </span><span style="--0:#F97583">++</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">try</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#B392F0">syncFromAddressUrl</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">      success </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">true</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">break</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    } </span><span style="--0:#F97583">catch</span><span style="--0:#E1E4E8"> (Throwable </span><span style="--0:#FFAB70">e</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      ex </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> e;</span></div><div class="ec-line"><span style="--0:#E1E4E8">      Loggers.CLUSTER.</span><span style="--0:#B392F0">error</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"[serverlist] exception, error : {}"</span><span style="--0:#E1E4E8">, ExceptionUtil.</span><span style="--0:#B392F0">getAllExceptionMsg</span><span style="--0:#E1E4E8">(ex));</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (</span><span style="--0:#F97583">!</span><span style="--0:#E1E4E8">success) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">throw</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">NacosException</span><span style="--0:#E1E4E8">(NacosException.SERVER_ERROR, ex);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  GlobalExecutor.</span><span style="--0:#B392F0">scheduleByCommon</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">AddressServerSyncTask</span><span style="--0:#E1E4E8">(), </span><span style="--0:#79B8FF">5_000L</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Overridepublic void start() throws NacosException {  if (start.compareAndSet(false, true)) {    this.maxFailCount = Integer.parseInt(ApplicationUtils.getProperty(&#x22;maxHealthCheckFailCount&#x22;, &#x22;12&#x22;));    initAddressSys();    run();  }}private void initAddressSys() {  String envDomainName = System.getenv(&#x22;address_server_domain&#x22;);  if (StringUtils.isBlank(envDomainName)) {    domainName = System.getProperty(&#x22;address.server.domain&#x22;, &#x22;jmenv.tbsite.net&#x22;);  } else {    domainName = envDomainName;  }  String envAddressPort = System.getenv(&#x22;address_server_port&#x22;);  if (StringUtils.isBlank(envAddressPort)) {    addressPort = System.getProperty(&#x22;address.server.port&#x22;, &#x22;8080&#x22;);  } else {    addressPort = envAddressPort;  }  addressUrl = System.getProperty(&#x22;address.server.url&#x22;,        ApplicationUtils.getContextPath() + &#x22;/&#x22; + &#x22;serverlist&#x22;);  addressServerUrl = &#x22;http://&#x22; + domainName + &#x22;:&#x22; + addressPort + addressUrl;  envIdUrl = &#x22;http://&#x22; + domainName + &#x22;:&#x22; + addressPort + &#x22;/env&#x22;;  Loggers.CORE.info(&#x22;ServerListService address-server port:&#x22; + addressPort);  Loggers.CORE.info(&#x22;ADDRESS_SERVER_URL:&#x22; + addressServerUrl);}@SuppressWarnings(&#x22;PMD.UndefineMagicConstantRule&#x22;)private void run() throws NacosException {  // With the address server, you need to perform a synchronous member node pull at startup  // Repeat three times, successfully jump out  boolean success = false;  Throwable ex = null;  int maxRetry = ApplicationUtils.getProperty(&#x22;nacos.core.address-server.retry&#x22;, Integer.class, 5);  for (int i = 0; i < maxRetry; i ++) {    try {      syncFromAddressUrl();      success = true;      break;    } catch (Throwable e) {      ex = e;      Loggers.CLUSTER.error(&#x22;[serverlist] exception, error : {}&#x22;, ExceptionUtil.getAllExceptionMsg(ex));    }  }  if (!success) {    throw new NacosException(NacosException.SERVER_ERROR, ex);  }  GlobalExecutor.scheduleByCommon(new AddressServerSyncTask(), 5_000L);}"><div></div></button></div></figure></div>
<p>在初始化时，会主动去向地址服务器同步当前的集群成员列表信息，如果失败则进行重试，其最大重试次数可通过设置_<strong>nacos.core.address-server.retry</strong>_来控制，默认是5次，然后成功之后，将创建定时任务去向地址服务器同步集群成员节点信息<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014362972-004f5338-af0d-4d0d-b769-4f3d5118c08a.png#align=left&#x26;display=inline&#x26;height=846&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=846&#x26;originWidth=1149&#x26;size=188886&#x26;status=done&#x26;style=none&#x26;width=1149" alt="image.png" referrerpolicy="no-referrer"></p>
<p><a name="sgOTI"></a></p>
<h3 id="节点管理和寻址模式如何结合的">节点管理和寻址模式如何结合的</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591014400580-39b83aa0-c548-4241-a49e-0d72abda2a95.png#align=left&#x26;display=inline&#x26;height=715&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=715&#x26;originWidth=1189&#x26;size=131826&#x26;status=done&#x26;style=none&#x26;width=1189" alt="image.png" referrerpolicy="no-referrer"><br>MemberLookup在启动之后，会根据不同的寻址模式，执行寻址任务，将收集到集群节点列表信息，调用memberChange，触发集群节点变动，然后发布节点变更事件</p>
<p><a name="idHpC"></a></p>
<h2 id="nacos一致性协议协议层抽象">Nacos一致性协议协议层抽象</h2>
<p>从nacos的未来的整体架构图可以看出，一致性协议层将是作为nacos的最为核心的模块，将服务于构建在core模块之上的各个功能模块，或者服务与core模块本身。而一致性协议因为分区容错性的存在，需要在可用性与一致性之间做选择，因此就存在两大类一致性：最终一致性和强一致性。在nacos中，这两类一致性协议都是可能用到的，比如naming模块，对于服务实例的数据管理分别用到了AP以及CP，而对于config模块，将会涉及使用CP。同时还有如下几个功能需求点</p>
<ol>
<li>目前持久化服务使用用了变种版本的raft，并且业务和raft协议耦合，因此需要抽离解耦，同时是选择一个标准的Java版Raft实现</li>
<li>对于中小用户，配置基本其实不会超级多，独立一个mysql，相对重一些，需要一个轻量化的存储方案，并且支持2.0不依赖mysql和3.0依赖mysql可配置能力</li>
<li>由于CP或者AP，其存在多种实现，如何对一致性协议层做一次很好的抽象，以便将来可以快速的实现底层一致性协议具体实现的替换，比如Raft协议，目前nacos的选型是JRaft，不排除将来nacos会自己实现一个标准raft协议或者实现Paxos协议</li>
<li>由于Nacos存在多个独立工作的功能模块，每个功能模块之间不能出现影响，比如A模块处理请求过慢或者出现异常时，不能影响B模块的正常工作，即每个功能模块在使用一致性协议时，如何将每个模块的数据处理进行隔离？</li>
</ol>
<p>根据一致协议以及上述功能需求点，本次做了一个抽象的一致协议层以及相关的接口
<a name="3w8xM"></a></p>
<h3 id="一致协议抽象">一致协议抽象</h3>
<p><a name="p7zRo"></a></p>
<h4 id="consistencyprotocol">ConsistencyProtocol</h4>
<p>所谓一致性，即多个副本之间是否能够保持一致性的特性，而副本的本质就是数据，对数据的操作，不是获取就是修改。同时，一致协议其实是针对分布式情况的，而这必然涉及多个节点，因此，需要有相应的接口能够调整一致性协议的协同工作节点。如果我们要观察一致性协议运行的情况，该怎么办？比如Raft协议，我们希望得知当前集群中的Leader是谁，任期的情况，当前集群中的成员节点有谁？因此，还需要提供一个一致性协议元数据获取。<br>综上所述，ConsistencyProtcol的大致设计可以出来了</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">interface</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">ConsistencyProtocol</span><span style="--0:#E1E4E8">&#x3C;</span><span style="--0:#F97583">T</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Config</span><span style="--0:#E1E4E8">, </span><span style="--0:#F97583">P</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">LogProcessor</span><span style="--0:#E1E4E8">> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">CommandOperations</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Consistency protocol initialization: perform initialization operations based on the incoming Config</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 一致性协议初始化，根据 Config 实现类</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">config</span><span style="--0:#99A0A6"> {@link Config}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">init</span><span style="--0:#E1E4E8">(T </span><span style="--0:#FFAB70">config</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Add a log handler</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">processors</span><span style="--0:#99A0A6"> {@link LogProcessor}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addLogProcessors</span><span style="--0:#E1E4E8">(Collection&#x3C;</span><span style="--0:#F97583">P</span><span style="--0:#E1E4E8">> </span><span style="--0:#FFAB70">processors</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Copy of metadata information for this consensus protocol</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 该一致性协议的元数据信息</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> metaData {@link ProtocolMetaData}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    ProtocolMetaData </span><span style="--0:#B392F0">protocolMetaData</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Obtain data according to the request</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">request</span><span style="--0:#99A0A6"> request</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> data {@link Response}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@throws</span><span style="--0:#99A0A6"> </span><span style="--0:#B392F0">Exception</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Response </span><span style="--0:#B392F0">getData</span><span style="--0:#E1E4E8">(GetRequest </span><span style="--0:#FFAB70">request</span><span style="--0:#E1E4E8">) </span><span style="--0:#F97583">throws</span><span style="--0:#E1E4E8"> Exception;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Get data asynchronously</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">request</span><span style="--0:#99A0A6"> request</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> data {@link CompletableFuture&#x3C;Response>}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    CompletableFuture&#x3C;</span><span style="--0:#F97583">Response</span><span style="--0:#E1E4E8">> </span><span style="--0:#B392F0">aGetData</span><span style="--0:#E1E4E8">(GetRequest </span><span style="--0:#FFAB70">request</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Data operation, returning submission results synchronously</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 同步数据提交，在 Datum 中已携带相应的数据操作信息</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">data</span><span style="--0:#99A0A6"> {@link Log}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> submit operation result {@link Response}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@throws</span><span style="--0:#99A0A6"> </span><span style="--0:#B392F0">Exception</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Response </span><span style="--0:#B392F0">submit</span><span style="--0:#E1E4E8">(Log </span><span style="--0:#FFAB70">data</span><span style="--0:#E1E4E8">) </span><span style="--0:#F97583">throws</span><span style="--0:#E1E4E8"> Exception;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Data submission operation, returning submission results asynchronously</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 异步数据提交，在 Datum 中已携带相应的数据操作信息，返回一个Future，自行操作，提交发生的异常会在CompleteFuture中</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">data</span><span style="--0:#99A0A6"> {@link Log}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> {@link CompletableFuture&#x3C;Response>} submit result</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@throws</span><span style="--0:#99A0A6"> </span><span style="--0:#B392F0">Exception</span><span style="--0:#99A0A6"> when submit throw Exception</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    CompletableFuture&#x3C;</span><span style="--0:#F97583">Response</span><span style="--0:#E1E4E8">> </span><span style="--0:#B392F0">submitAsync</span><span style="--0:#E1E4E8">(Log </span><span style="--0:#FFAB70">data</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * New member list</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 新的成员节点列表，一致性协议自行处理相应的成员节点是加入还是离开</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">addresses</span><span style="--0:#99A0A6"> [ip:port, ip:port, ...]</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">memberChange</span><span style="--0:#E1E4E8">(Set&#x3C;</span><span style="--0:#F97583">String</span><span style="--0:#E1E4E8">> </span><span style="--0:#FFAB70">addresses</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Consistency agreement service shut down</span></div><div class="ec-line"><span style="--0:#99A0A6">     * 一致性协议服务关闭</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">shutdown</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public interface ConsistencyProtocol<T extends Config, P extends LogProcessor> extends CommandOperations {    /**     * Consistency protocol initialization: perform initialization operations based on the incoming Config     * 一致性协议初始化，根据 Config 实现类     *     * @param config {@link Config}     */    void init(T config);    /**     * Add a log handler     *     * @param processors {@link LogProcessor}     */    void addLogProcessors(Collection<P> processors);    /**     * Copy of metadata information for this consensus protocol     * 该一致性协议的元数据信息     *     * @return metaData {@link ProtocolMetaData}     */    ProtocolMetaData protocolMetaData();    /**     * Obtain data according to the request     *     * @param request request     * @return data {@link Response}     * @throws Exception     */    Response getData(GetRequest request) throws Exception;    /**     * Get data asynchronously     *     * @param request request     * @return data {@link CompletableFuture<Response>}     */    CompletableFuture<Response> aGetData(GetRequest request);    /**     * Data operation, returning submission results synchronously     * 同步数据提交，在 Datum 中已携带相应的数据操作信息     *     * @param data {@link Log}     * @return submit operation result {@link Response}     * @throws Exception     */    Response submit(Log data) throws Exception;    /**     * Data submission operation, returning submission results asynchronously     * 异步数据提交，在 Datum 中已携带相应的数据操作信息，返回一个Future，自行操作，提交发生的异常会在CompleteFuture中     *     * @param data {@link Log}     * @return {@link CompletableFuture<Response>} submit result     * @throws Exception when submit throw Exception     */    CompletableFuture<Response> submitAsync(Log data);    /**     * New member list     * 新的成员节点列表，一致性协议自行处理相应的成员节点是加入还是离开     *     * @param addresses [ip:port, ip:port, ...]     */    void memberChange(Set<String> addresses);    /**     * Consistency agreement service shut down     * 一致性协议服务关闭     */    void shutdown();}"><div></div></button></div></figure></div>
<p>而针对CP协议，由于存在Leader的概念，因此需要提供一个方法用于获取CP协议当前的Leader是谁</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">interface</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">CPProtocol</span><span style="--0:#E1E4E8">&#x3C;</span><span style="--0:#F97583">C</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Config</span><span style="--0:#E1E4E8">> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">ConsistencyProtocol</span><span style="--0:#E1E4E8">&#x3C;</span><span style="--0:#F97583">C</span><span style="--0:#E1E4E8">> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">  /**</span></div><div class="ec-line"><span style="--0:#99A0A6">   * Returns whether this node is a leader node</span></div><div class="ec-line"><span style="--0:#99A0A6">   *</span></div><div class="ec-line"><span style="--0:#99A0A6">   * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">group</span><span style="--0:#99A0A6"> business module info</span></div><div class="ec-line"><span style="--0:#99A0A6">   * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> is leader</span></div><div class="ec-line"><span style="--0:#99A0A6">   * </span><span style="--0:#F97583">@throws</span><span style="--0:#99A0A6"> </span><span style="--0:#B392F0">Exception</span></div><div class="ec-line"><span style="--0:#99A0A6">   */</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">isLeader</span><span style="--0:#E1E4E8">(String </span><span style="--0:#FFAB70">group</span><span style="--0:#E1E4E8">) </span><span style="--0:#F97583">throws</span><span style="--0:#E1E4E8"> Exception;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public interface CPProtocol<C extends Config> extends ConsistencyProtocol<C> {  /**   * Returns whether this node is a leader node   *   * @param group business module info   * @return is leader   * @throws Exception   */  boolean isLeader(String group) throws Exception;}"><div></div></button></div></figure></div>
<p><a name="oJFpB"></a></p>
<h4 id="数据操作请求提交对象loggetrequest">数据操作请求提交对象：Log、GetRequest</h4>
<p>上面说到，一致性协议其实是对于数据操作而言的，数据操作基本分为两大类：数据查询以及数据修改，同时还要满足不同功能模块之间的数据进行隔离。因此这里针对数据修改操作以及数据查询操作分别阐述。</p>
<ol>
<li>数据修改
<ol>
<li>数据修改操作，一定要知道本次请求是属于哪一个功能模块的</li>
<li>数据修改操作，首先一定要知道这个数据的修改操作具体是哪一种修改操作，方便功能模块针对真正的数据修改操作进行相应的逻辑操作</li>
<li>数据修改操作，一定要知道修改的数据是什么，即请求体，为了使得一致性协议层更为通用，这里对于请求体的数据结构，选择了byte[]数组</li>
<li>数据的类型，由于我们将真正的数据序列化为了byte[]数组，为了能够正常序列化，我们可能还需要记录这个数据的类型是什么</li>
<li>本次请求的信息摘要或者标识信息</li>
<li>本次请求的额外信息，用于将来扩展需要传输的数据</li>
</ol>
</li>
</ol>
<p>综上，可以得出Log对象的设计如下</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">message Log {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// 功能模块分组信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string group </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">1</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 摘要或者标识</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string key </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 具体请求数据</span></div><div class="ec-line"><span style="--0:#E1E4E8">    bytes data </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">3</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 数据类型</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string type </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">4</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 更为具体的数据操作</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string operation </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">5</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 额外信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">    map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">string, string</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> extendInfo </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">6</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="message Log {  // 功能模块分组信息    string group = 1;    // 摘要或者标识    string key = 2;    // 具体请求数据    bytes data = 3;    // 数据类型    string type = 4;    // 更为具体的数据操作    string operation = 5;    // 额外信息    map<string, string> extendInfo = 6;}"><div></div></button></div></figure></div>
<ol start="2">
<li>数据查询
<ol>
<li>数据查询操作，一定要知道本次请求是由哪一个功能模块发起的</li>
<li>数据查询的条件是什么，为了兼容各种存储结构的数据查询操作，这里用byte[]进行存储</li>
<li>本次请求的额外信息，用于将来扩展需要传输的数据</li>
</ol>
</li>
</ol>
<p>综上，可以得出GetRequest对象的设计如下</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">message GetRequest {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// 功能模块分组信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">    string group </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">1</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 具体请求数据</span></div><div class="ec-line"><span style="--0:#E1E4E8">    bytes data </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 额外信息</span></div><div class="ec-line"><span style="--0:#E1E4E8">    map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">string, string</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> extendInfo </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">3</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="message GetRequest {  // 功能模块分组信息    string group = 1;    // 具体请求数据    bytes data = 2;    // 额外信息    map<string, string> extendInfo = 3;}"><div></div></button></div></figure></div>
<p><a name="vBig4"></a></p>
<h4 id="功能模块使用一致性协议logprocessor">功能模块使用一致性协议：LogProcessor</h4>
<p>当数据操作通过一致性协议进行submit之后，每个节点需要去处理这个Log或者GetRequest对象，因此，我们需要抽象出一个Log、GetRequest对象的Processor，不同的功能模块通过实现该处理器，ConsistencyProtocol内部会根据Log、GetRequest的group属性，将Log、GetRequest对象路由到具体的Processor，当然，Processor也需要表明自己是属于哪一个功能模块的。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">LogProcessor</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * get data by key</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">request</span><span style="--0:#99A0A6"> request {@link GetRequest}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> target type data</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> Response </span><span style="--0:#B392F0">onRequest</span><span style="--0:#E1E4E8">(GetRequest </span><span style="--0:#FFAB70">request</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Process Submitted Log</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">log</span><span style="--0:#99A0A6"> {@link Log}</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> {@link boolean}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> Response </span><span style="--0:#B392F0">onApply</span><span style="--0:#E1E4E8">(Log </span><span style="--0:#FFAB70">log</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Irremediable errors that need to trigger business price cuts</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@param</span><span style="--0:#99A0A6"> </span><span style="--0:#FFAB70">error</span><span style="--0:#99A0A6"> {@link Throwable}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">onError</span><span style="--0:#E1E4E8">(Throwable </span><span style="--0:#FFAB70">error</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * In order for the state machine that handles the transaction to be able to route</span></div><div class="ec-line"><span style="--0:#99A0A6">     * the Log to the correct LogProcessor, the LogProcessor needs to have an identity</span></div><div class="ec-line"><span style="--0:#99A0A6">     * information</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> Business unique identification name</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> String </span><span style="--0:#B392F0">group</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public abstract class LogProcessor {    /**     * get data by key     *     * @param request request {@link GetRequest}     * @return target type data     */    public abstract Response onRequest(GetRequest request);    /**     * Process Submitted Log     *     * @param log {@link Log}     * @return {@link boolean}     */    public abstract Response onApply(Log log);    /**     * Irremediable errors that need to trigger business price cuts     *     * @param error {@link Throwable}     */    public void onError(Throwable error) {    }    /**     * In order for the state machine that handles the transaction to be able to route     * the Log to the correct LogProcessor, the LogProcessor needs to have an identity     * information     *     * @return Business unique identification name     */    public abstract String group();}"><div></div></button></div></figure></div>
<p>针对CP协议，比如Raft协议，存在快照的设计，因此我们需要针对CP协议单独扩展出一个方法</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">abstract</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">LogProcessor4CP</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">extends</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">LogProcessor</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">    /**</span></div><div class="ec-line"><span style="--0:#99A0A6">     * Discovery snapshot handler</span></div><div class="ec-line"><span style="--0:#99A0A6">     * It is up to LogProcessor to decide which SnapshotOperate should be loaded and saved by itself</span></div><div class="ec-line"><span style="--0:#99A0A6">     *</span></div><div class="ec-line"><span style="--0:#99A0A6">     * </span><span style="--0:#F97583">@return</span><span style="--0:#99A0A6"> {@link List &#x3C;SnapshotOperate>}</span></div><div class="ec-line"><span style="--0:#99A0A6">     */</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> List&#x3C;</span><span style="--0:#F97583">SnapshotOperation</span><span style="--0:#E1E4E8">> </span><span style="--0:#B392F0">loadSnapshotOperate</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> Collections.</span><span style="--0:#B392F0">emptyList</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public abstract class LogProcessor4CP extends LogProcessor {    /**     * Discovery snapshot handler     * It is up to LogProcessor to decide which SnapshotOperate should be loaded and saved by itself     *     * @return {@link List <SnapshotOperate>}     */    public List<SnapshotOperation> loadSnapshotOperate() {        return Collections.emptyList();    }}"><div></div></button></div></figure></div>
<p><a name="zbsAE"></a></p>
<h4 id="综述">综述</h4>
<p>从上面这几点可以看出来，ConsistencyProtocol是对上层功能模块暴露出来的使用接口，每个ConsistencyProtocol后面有具体的一致性协议实现的Backend，由于Backend无法很好的兼容nacos现有的架构设计，因此额外设计的LogProcessor就是为了解决这个问题。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015048030-8a4bff4a-20ed-46dd-a7f7-98655b22946f.png#align=left&#x26;display=inline&#x26;height=591&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=591&#x26;originWidth=886&#x26;size=93327&#x26;status=done&#x26;style=none&#x26;width=886" alt="image.png" referrerpolicy="no-referrer"><br>同时，由于在一致性协议层内部的Backend中需要实现对不同业务模块的数据进行隔离处理，而这个一块逻辑由请求对象和LogProcessor的group属性来实现<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015155835-a897262e-8e57-409c-bf94-d57bf765c80b.png#align=left&#x26;display=inline&#x26;height=591&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=591&#x26;originWidth=910&#x26;size=118083&#x26;status=done&#x26;style=none&#x26;width=910" alt="image.png" referrerpolicy="no-referrer"></p>
<p><a name="C1yU6"></a></p>
<h3 id="一致性协议层工作流程">一致性协议层工作流程</h3>
<p>我们可以通过一个时序图看看，一致性协议层的大致工作流程
<img src="https://cdn.nlark.com/yuque/__puml/30b7e270e7aef8bb63136aaffbe5bfbf.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbnBhcnRpY2lwYW50IFwiTWVtYmVyTWFuYWdlclwiIGFzIE5hY29zQ2x1c3RlclxucGFydGljaXBhbnQgXCJCdXNpbmVzc01vZHVsZVwiIGFzIEJpelxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiQ0FQQmFja2VuZFwiIGFzIEJhY2tlbmRcbnBhcnRpY2lwYW50IFwiQ29uZmlnXCIgYXMgQ29uZmlnXG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJMb2dcIiBhcyBMb2dcblxuYWN0aXZhdGUgTmFjb3NDbHVzdGVyXG5OYWNvc0NsdXN0ZXIgLT4gTmFjb3NDbHVzdGVyOiBpbml0KCkg5Yid5aeL5YyWTmFjb3Ppm4bnvqRcblxuTmFjb3NDbHVzdGVyIC0-IENvbmZpZzog6I635Y-WQ29uZmln5a-56LGhXG5hY3RpdmF0ZSBDb25maWdcbkNvbmZpZyAtPiBDb25maWc6IOaUtumbhkxvZ1Byb2Nlc3NvcueahOS_oeaBr1xuQ29uZmlnIC0-IE5hY29zQ2x1c3RlclxuZGVhY3RpdmF0ZSBDb25maWdcblxuXG5OYWNvc0NsdXN0ZXIgLT4gUHJvdG9jb2w6IOiOt-WPluaJgOaciUNvbnNpc3RlbmN5UHJvdG9jb2zlrp7njrBcbmFjdGl2YXRlIFByb3RvY29sXG5cbk5hY29zQ2x1c3RlciAtPiBQcm90b2NvbDogaW5pdChDb25maWcpIOaWueazleaJp-ihjFxuXG5kZWFjdGl2YXRlIFByb3RvY29sXG5kZWFjdGl2YXRlIE5hY29zQ2x1c3RlclxuXG5cbkJpeiAtPiBMb2c6IOWIm-W7uuS4gOS4quS6i-WKoeWvueixoVxuYWN0aXZhdGUgQml6XG5hY3RpdmF0ZSBMb2dcblxuXG5Mb2cgLT4gTG9nOiDorr7nva5kYXRhXG5Mb2cgLT4gTG9nOiDorr7nva5rZXlcbkxvZyAtPiBMb2c6IOiuvue9rmNsYXNzTmFtZVxuTG9nIC0-IExvZzog6K6-572uZXh0ZW5kSW5mb1xuTG9nIC0-IEJpelxuZGVhY3RpdmF0ZSBMb2dcblxuQml6IC0-IFByb3RvY29sOiBzdWJtaXQoTG9nKSDosIPnlKjkuIDoh7TmgKfljY_orq7ov5vooYzkuovliqHmj5DkuqRcbmFjdGl2YXRlIFByb3RvY29sXG5cblByb3RvY29sIC0-IEJhY2tlbmQ6IOWGhemDqOS4gOiHtOaAp-WNj-iuruW3peS9nFxuYWN0aXZhdGUgQmFja2VuZFxuXG5CYWNrZW5kIC0-IFByb3RvY29sOiDov5Tlm57lt6XkvZzlpITnkIbnu5PmnpxcbmRlYWN0aXZhdGUgQmFja2VuZFxuXG5Qcm90b2NvbCAtPiBQcm9jZXNzb3I6IOWwhkxvZ-WIhuWPkeWIsOWvueW6lOeahFByb2Nlc3Nvcu-8jOiwg-eUqCBvbkFwcGx5IOaWueazlVxuYWN0aXZhdGUgUHJvdG9jb2xcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuUHJvY2Vzc29yIC0-IEJpejog5LqL5Yqh5o-Q5Lqk57uT5p6cXG5cbmRlYWN0aXZhdGUgUHJvY2Vzc29yXG5kZWFjdGl2YXRlIEJpelxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiNFZpMkwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzMwYjdlMjcwZTdhZWY4YmI2MzEzNmFhZmZiZTViZmJmLnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" alt="" referrerpolicy="no-referrer"></p>
<p><a name="xtBNU"></a></p>
<h3 id="nacos一致性协议层之cp协议的实现选择jraft">Nacos一致性协议层之CP协议的实现选择——JRaft</h3>
<p>一致性协议层抽象好之后，剩下就是具体一致性协议实现的选择了，这里我们选择了蚂蚁金服开源的JRaft，那么我们如何将JRaft作为CP协议的一个Backend呢？下面的简单流程图描述了当JRaft作为CP协议的一个Backend时的初始化流程</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">/**</span></div><div class="ec-line"><span style="--0:#99A0A6"> * A concrete implementation of CP protocol: JRaft</span></div><div class="ec-line"><span style="--0:#99A0A6"> *</span></div><div class="ec-line"><span style="--0:#99A0A6"> * &#x3C;pre></span></div><div class="ec-line"><span style="--0:#99A0A6"> *                                           ┌──────────────────────┐</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                                           │                      │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *            ┌──────────────────────┐       │                      ▼</span></div><div class="ec-line"><span style="--0:#99A0A6"> *            │   ProtocolManager    │       │        ┌───────────────────────────┐</span></div><div class="ec-line"><span style="--0:#99A0A6"> *            └──────────────────────┘       │        │for p in [LogProcessor4CP] │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │        └───────────────────────────┘</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │                      │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *      ┌──────────────────────────────────┐ │                      ▼</span></div><div class="ec-line"><span style="--0:#99A0A6"> *      │    discovery LogProcessor4CP     │ │             ┌─────────────────┐</span></div><div class="ec-line"><span style="--0:#99A0A6"> *      └──────────────────────────────────┘ │             │  get p.group()  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │             └─────────────────┘</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │                      │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                 ┌─────────────┐           │                      │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                 │ RaftConfig  │           │                      ▼</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                 └─────────────┘           │      ┌──────────────────────────────┐</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │      │  create raft group service   │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │      └──────────────────────────────┘</span></div><div class="ec-line"><span style="--0:#99A0A6"> *              ┌──────────────────┐         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *              │  JRaftProtocol   │         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *              └──────────────────┘         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                     init()                │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *               ┌─────────────────┐         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *               │   JRaftServer   │         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *               └─────────────────┘         │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        ▼                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *             ┌────────────────────┐        │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *             │JRaftServer.start() │        │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *             └────────────────────┘        │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        │                  │</span></div><div class="ec-line"><span style="--0:#99A0A6"> *                        └──────────────────┘</span></div><div class="ec-line"><span style="--0:#99A0A6"> * &#x3C;/pre></span></div><div class="ec-line"><span style="--0:#99A0A6"> *</span></div><div class="ec-line"><span style="--0:#99A0A6"> * </span><span style="--0:#F97583">@author</span><span style="--0:#99A0A6"> &#x3C;a href="mailto:liaochuntao@live.com">liaochuntao&#x3C;/a></span></div><div class="ec-line"><span style="--0:#99A0A6"> */</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * A concrete implementation of CP protocol: JRaft * * <pre> *                                           ┌──────────────────────┐ *                                           │                      │ *            ┌──────────────────────┐       │                      ▼ *            │   ProtocolManager    │       │        ┌───────────────────────────┐ *            └──────────────────────┘       │        │for p in [LogProcessor4CP] │ *                        │                  │        └───────────────────────────┘ *                        ▼                  │                      │ *      ┌──────────────────────────────────┐ │                      ▼ *      │    discovery LogProcessor4CP     │ │             ┌─────────────────┐ *      └──────────────────────────────────┘ │             │  get p.group()  │ *                        │                  │             └─────────────────┘ *                        ▼                  │                      │ *                 ┌─────────────┐           │                      │ *                 │ RaftConfig  │           │                      ▼ *                 └─────────────┘           │      ┌──────────────────────────────┐ *                        │                  │      │  create raft group service   │ *                        ▼                  │      └──────────────────────────────┘ *              ┌──────────────────┐         │ *              │  JRaftProtocol   │         │ *              └──────────────────┘         │ *                        │                  │ *                     init()                │ *                        │                  │ *                        ▼                  │ *               ┌─────────────────┐         │ *               │   JRaftServer   │         │ *               └─────────────────┘         │ *                        │                  │ *                        │                  │ *                        ▼                  │ *             ┌────────────────────┐        │ *             │JRaftServer.start() │        │ *             └────────────────────┘        │ *                        │                  │ *                        └──────────────────┘ * </pre> * * @author <a href=&#x22;mailto:liaochuntao@live.com&#x22;>liaochuntao</a> */"><div></div></button></div></figure></div>
<p>JRaftProtocol是当JRaft作为CP协议的Backend时的一个ConsistencyProtocol的具体实现，其内部有一个JRaftServer成员属性，JRaftServer分装了JRaft的各种API操作，比如数据操作的提交，数据的查询，成员节点的变更，Leader节点的查询等等。</p>
<p><em><strong>注意事项：JRaft运行期间产生的数据在${nacos.home}/data/protocol/raft文件目录下。不同的业务模块有不同的文件分组，如果当节点出现crash或者异常关闭时，清空该目录下的文件，重启节点即可</strong></em></p>
<p>由于JRaft实现了raft group的概念，因此，完全可以利用raft group的设计，为每个功能模块单独创建一个raft group。这里给出部分代码，该代码体现了如何将LogProcessor嵌入到状态机中并为每个LogPrcessor创建一个Raft Group</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">synchronized</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">createMultiRaftGroup</span><span style="--0:#E1E4E8">(Collection</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">LogProcessor4CP</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> processors) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#99A0A6">// There is no reason why the LogProcessor cannot be processed because of the synchronization</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (</span><span style="--0:#F97583">!</span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.isStarted) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">.processors.</span><span style="--0:#B392F0">addAll</span><span style="--0:#E1E4E8">(processors);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String parentPath </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> Paths</span></div><div class="ec-line"><span style="--0:#E1E4E8">        .</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">(ApplicationUtils.</span><span style="--0:#B392F0">getNacosHome</span><span style="--0:#E1E4E8">(), </span><span style="--0:#9ECBFF">"data/protocol/raft"</span><span style="--0:#E1E4E8">).</span><span style="--0:#B392F0">toString</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">for</span><span style="--0:#E1E4E8"> (LogProcessor4CP processor </span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> processors) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String groupName </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> processor.</span><span style="--0:#B392F0">group</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (multiRaftGroup.</span><span style="--0:#B392F0">containsKey</span><span style="--0:#E1E4E8">(groupName)) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">throw</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">DuplicateRaftGroupException</span><span style="--0:#E1E4E8">(groupName);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Ensure that each Raft Group has its own configuration and NodeOptions</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Configuration configuration </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> conf.</span><span style="--0:#B392F0">copy</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    NodeOptions copy </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> nodeOptions.</span><span style="--0:#B392F0">copy</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    JRaftUtils.</span><span style="--0:#B392F0">initDirectory</span><span style="--0:#E1E4E8">(parentPath, groupName, copy);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Here, the LogProcessor is passed into StateMachine, and when the StateMachine</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// triggers onApply, the onApply of the LogProcessor is actually called</span></div><div class="ec-line"><span style="--0:#E1E4E8">    NacosStateMachine machine </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">NacosStateMachine</span><span style="--0:#E1E4E8">(</span><span style="--0:#79B8FF">this</span><span style="--0:#E1E4E8">, processor);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    copy.</span><span style="--0:#B392F0">setFsm</span><span style="--0:#E1E4E8">(machine);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    copy.</span><span style="--0:#B392F0">setInitialConf</span><span style="--0:#E1E4E8">(configuration);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Set snapshot interval, default 1800 seconds</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> doSnapshotInterval </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> ConvertUtils.</span><span style="--0:#B392F0">toInt</span><span style="--0:#E1E4E8">(raftConfig</span></div><div class="ec-line"><span style="--0:#E1E4E8">              .</span><span style="--0:#B392F0">getVal</span><span style="--0:#E1E4E8">(RaftSysConstants.RAFT_SNAPSHOT_INTERVAL_SECS),</span></div><div class="ec-line"><span style="--0:#E1E4E8">          RaftSysConstants.DEFAULT_RAFT_SNAPSHOT_INTERVAL_SECS);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// If the business module does not implement a snapshot processor, cancel the snapshot</span></div><div class="ec-line"><span style="--0:#E1E4E8">    doSnapshotInterval </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> CollectionUtils</span></div><div class="ec-line"><span style="--0:#E1E4E8">          .</span><span style="--0:#B392F0">isEmpty</span><span style="--0:#E1E4E8">(processor.</span><span style="--0:#B392F0">loadSnapshotOperate</span><span style="--0:#E1E4E8">()) </span><span style="--0:#F97583">?</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">0</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> doSnapshotInterval;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    copy.</span><span style="--0:#B392F0">setSnapshotIntervalSecs</span><span style="--0:#E1E4E8">(doSnapshotInterval);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Loggers.RAFT.</span><span style="--0:#B392F0">info</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"create raft group : {}"</span><span style="--0:#E1E4E8">, groupName);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    RaftGroupService raftGroupService </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">RaftGroupService</span><span style="--0:#E1E4E8">(groupName,</span></div><div class="ec-line"><span style="--0:#E1E4E8">          localPeerId, copy, rpcServer, </span><span style="--0:#79B8FF">true</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Because RpcServer has been started before, it is not allowed to start again here</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Node node </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> raftGroupService.</span><span style="--0:#B392F0">start</span><span style="--0:#E1E4E8">(</span><span style="--0:#79B8FF">false</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    machine.</span><span style="--0:#B392F0">setNode</span><span style="--0:#E1E4E8">(node);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    RouteTable.</span><span style="--0:#B392F0">getInstance</span><span style="--0:#E1E4E8">().</span><span style="--0:#B392F0">updateConfiguration</span><span style="--0:#E1E4E8">(groupName, configuration);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    RaftExecutor.</span><span style="--0:#B392F0">executeByCommon</span><span style="--0:#E1E4E8">(() </span><span style="--0:#F97583">-></span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">registerSelfToCluster</span><span style="--0:#E1E4E8">(groupName, localPeerId, configuration));</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// Turn on the leader auto refresh for this group</span></div><div class="ec-line"><span style="--0:#E1E4E8">    Random random </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">Random</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> period </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> nodeOptions.</span><span style="--0:#B392F0">getElectionTimeoutMs</span><span style="--0:#E1E4E8">() </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> random.</span><span style="--0:#B392F0">nextInt</span><span style="--0:#E1E4E8">(</span><span style="--0:#79B8FF">5</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">*</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">1000</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    RaftExecutor.</span><span style="--0:#B392F0">scheduleRaftMemberRefreshJob</span><span style="--0:#E1E4E8">(() </span><span style="--0:#F97583">-></span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">refreshRouteTable</span><span style="--0:#E1E4E8">(groupName),</span></div><div class="ec-line"><span style="--0:#E1E4E8">          nodeOptions.</span><span style="--0:#B392F0">getElectionTimeoutMs</span><span style="--0:#E1E4E8">(), period, TimeUnit.MILLISECONDS);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    multiRaftGroup.</span><span style="--0:#B392F0">put</span><span style="--0:#E1E4E8">(groupName,</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">RaftGroupTuple</span><span style="--0:#E1E4E8">(node, processor, raftGroupService, machine));</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="synchronized void createMultiRaftGroup(Collection<LogProcessor4CP> processors) {  // There is no reason why the LogProcessor cannot be processed because of the synchronization  if (!this.isStarted) {    this.processors.addAll(processors);    return;  }  final String parentPath = Paths        .get(ApplicationUtils.getNacosHome(), &#x22;data/protocol/raft&#x22;).toString();  for (LogProcessor4CP processor : processors) {    final String groupName = processor.group();    if (multiRaftGroup.containsKey(groupName)) {      throw new DuplicateRaftGroupException(groupName);    }    // Ensure that each Raft Group has its own configuration and NodeOptions    Configuration configuration = conf.copy();    NodeOptions copy = nodeOptions.copy();    JRaftUtils.initDirectory(parentPath, groupName, copy);    // Here, the LogProcessor is passed into StateMachine, and when the StateMachine    // triggers onApply, the onApply of the LogProcessor is actually called    NacosStateMachine machine = new NacosStateMachine(this, processor);    copy.setFsm(machine);    copy.setInitialConf(configuration);    // Set snapshot interval, default 1800 seconds    int doSnapshotInterval = ConvertUtils.toInt(raftConfig              .getVal(RaftSysConstants.RAFT_SNAPSHOT_INTERVAL_SECS),          RaftSysConstants.DEFAULT_RAFT_SNAPSHOT_INTERVAL_SECS);    // If the business module does not implement a snapshot processor, cancel the snapshot    doSnapshotInterval = CollectionUtils          .isEmpty(processor.loadSnapshotOperate()) ? 0 : doSnapshotInterval;    copy.setSnapshotIntervalSecs(doSnapshotInterval);    Loggers.RAFT.info(&#x22;create raft group : {}&#x22;, groupName);    RaftGroupService raftGroupService = new RaftGroupService(groupName,          localPeerId, copy, rpcServer, true);    // Because RpcServer has been started before, it is not allowed to start again here    Node node = raftGroupService.start(false);    machine.setNode(node);    RouteTable.getInstance().updateConfiguration(groupName, configuration);    RaftExecutor.executeByCommon(() -> registerSelfToCluster(groupName, localPeerId, configuration));    // Turn on the leader auto refresh for this group    Random random = new Random();    long period = nodeOptions.getElectionTimeoutMs() + random.nextInt(5 * 1000);    RaftExecutor.scheduleRaftMemberRefreshJob(() -> refreshRouteTable(groupName),          nodeOptions.getElectionTimeoutMs(), period, TimeUnit.MILLISECONDS);    multiRaftGroup.put(groupName,          new RaftGroupTuple(node, processor, raftGroupService, machine));  }}"><div></div></button></div></figure></div>
<p><a name="4czvB"></a></p>
<h4 id="疑问解答为什么要创建多个raft-group">疑问解答：为什么要创建多个raft group</h4>
<p>或许有的人会有疑问，既然之前已经设计出了LogProcessor，完全可以利用一个Raft Group，在状态机appl时，根据Log的group属性进行路由到不同的LogProcessor即可，每个功能模块就创建一个raft group，不是会消耗大量的资源吗？<br>正如之前所说，我们希望独立工作的模块之间相互不存在影响，比如A模块处理Log因为存在Block操作可能使得apply的速度缓慢，亦或者可能中途发生异常，对于Raft协议来说，当日志apply失败时，状态机将不能够继续向前推进，因为如果继续向前推进的话，由于上一步的apply失败，后面的所有apply都可能失败，将会导致这个节点的数据与其他节点的数据永远不一致。如果说我们将所有独立工作的模块，对于数据操作的请求处理放在同一个raft group，即一个状态机中，就不可避免的会出现上述所说的问题，某个模块在apply日志发生不可控的因素时，会影响其他模块的正常工作。</p>
<p><a name="2GyRw"></a></p>
<h3 id="jraft运维操作">JRaft运维操作</h3>
<p>为了使用者能够对JRaft进行相关简单的运维，比如Leader的切换，重置当前Raft集群成员，触发某个节点进行Snapshot操作等等，提供了一个简单的HTTP接口进行操作，并且该接口有一定的限制，即每次只会执行一条运维指令</p>
<p>1、切换某一个Raft Group的Leader节点</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"transferLeader"</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port} or ip:{raft_port},ip:{raft_port},ip:{raft_port}"</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;transferLeader&#x22;    &#x22;value&#x22;: &#x22;ip:{raft_port} or ip:{raft_port},ip:{raft_port},ip:{raft_port}&#x22;}"><div></div></button></div></figure></div>
<p><a name="Fs7VE"></a></p>
<p>2、重置某一个Raft Group的集群成员</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"resetRaftCluster"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port},ip:{raft_port},ip:{raft_port},ip:{raft_port}"</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;resetRaftCluster&#x22;,    &#x22;value&#x22;: &#x22;ip:{raft_port},ip:{raft_port},ip:{raft_port},ip:{raft_port}&#x22;}"><div></div></button></div></figure></div>
<p>注意，该操作是一个高危操作，仅仅当Raft集群的 n/2 + 1节点crash之后无法满足过半投票的要求才可以使用该运维命令，用于快速让当前剩余的节点重组Raft集群，对外提供服务，但是这个操作很大程度会造成数据的丢失<br></p>
<p><a name="VfG5T"></a></p>
<p>3、触发某一个Raft Group执行快照操作</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"doSnapshot"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port}"</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;doSnapshot&#x22;,    &#x22;value&#x22;: &#x22;ip:{raft_port}&#x22;}"><div></div></button></div></figure></div>
<p><a name="m9LfI"></a></p>
<p>4、移除某一个Raft Group中的某一成员</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"removePeer"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port}"</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;removePeer&#x22;,    &#x22;value&#x22;: &#x22;ip:{raft_port}&#x22;}"><div></div></button></div></figure></div>
<p><a name="ev3MW"></a></p>
<p>5、批量移除某一个Raft Group中的多个成员</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">POST </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">core</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">raft</span></div><div class="ec-line"><span style="--0:#E1E4E8">{</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"groupId"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"xxx"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"command"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"removePeers"</span><span style="--0:#E1E4E8">,</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#9ECBFF">"value"</span><span style="--0:#F97583">:</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"ip:{raft_port},ip:{raft_port},ip:{raft_port},..."</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="POST /nacos/v1/core/ops/raft{    &#x22;groupId&#x22;: &#x22;xxx&#x22;,    &#x22;command&#x22;: &#x22;removePeers&#x22;,    &#x22;value&#x22;: &#x22;ip:{raft_port},ip:{raft_port},ip:{raft_port},...&#x22;}"><div></div></button></div></figure></div>
<p><a name="GzMuP"></a></p>
<h3 id="jraft协议相关配置参数">JRaft协议相关配置参数</h3>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">### Sets the Raft cluster election timeout, default value is 5 second</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.election_timeout_ms=5000</span></div><div class="ec-line"><span style="--0:#99A0A6">### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.snapshot_interval_secs=30</span></div><div class="ec-line"><span style="--0:#99A0A6">### Requested retries, default value is 1</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.request_failoverRetries=1</span></div><div class="ec-line"><span style="--0:#99A0A6">### raft internal worker threads</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.core_thread_num=8</span></div><div class="ec-line"><span style="--0:#99A0A6">### Number of threads required for raft business request processing</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.cli_service_thread_num=4</span></div><div class="ec-line"><span style="--0:#99A0A6">### raft linear read strategy, defaults to index</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe</span></div><div class="ec-line"><span style="--0:#99A0A6">### rpc request timeout, default 5 seconds</span></div><div class="ec-line"><span style="--0:#9ECBFF">nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="### Sets the Raft cluster election timeout, default value is 5 secondnacos.core.protocol.raft.data.election_timeout_ms=5000### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minutenacos.core.protocol.raft.data.snapshot_interval_secs=30### Requested retries, default value is 1nacos.core.protocol.raft.data.request_failoverRetries=1### raft internal worker threadsnacos.core.protocol.raft.data.core_thread_num=8### Number of threads required for raft business request processingnacos.core.protocol.raft.data.cli_service_thread_num=4### raft linear read strategy, defaults to indexnacos.core.protocol.raft.data.read_index_type=ReadOnlySafe### rpc request timeout, default 5 secondsnacos.core.protocol.raft.data.rpc_request_timeout_ms=5000"><div></div></button></div></figure></div>
<h4 id="线性读参数解析">线性读参数解析</h4>
<ol>
<li><strong>ReadOnlySafe</strong>
<ol>
<li>该线性读模式，每次Follower进行读请求时，需要和Leader同步日志提交位点信息，而Leader，需要向过半的Follower发起证明自己是Leader的轻量的RPC请求，相当于一个Follower读，至少需要1 + （n/2）+ 1 次的RPC请求。</li>
</ol>
</li>
<li><strong>ReadOnlyLeaseBased</strong>
<ol>
<li>该线性读模式，每次Follower进行读请求时，Leader只需要判断自己的Leader租约是否过期了，如果没有过期，直接可以回复Follower自己是Leader，但是该机制对于机器时钟要求很严格，如果有做时钟同步的话，可以考虑使用该线性读模式。</li>
</ol>
</li>
</ol>
<p><a name="WiLDa"></a></p>
<h2 id="nacos内嵌分布式id">Nacos内嵌分布式ID</h2>
<p>nacos内嵌的分布式ID为Snakeflower，dataCenterId默认为1，workerId的值计算方式如下</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#9ECBFF">InetAddress address;</span></div><div class="ec-line"><span style="--0:#9ECBFF">try {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#9ECBFF">address = InetAddress.getLocalHost();</span></div><div class="ec-line"><span style="--0:#E1E4E8">} </span><span style="--0:#9ECBFF">catch (final UnknownHostException e) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#9ECBFF">throw new IllegalStateException(</span></div><div class="ec-line"><span style="--0:#E1E4E8">            </span><span style="--0:#9ECBFF">"Cannot get LocalHost InetAddress, please check your network!");</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line"><span style="--0:#9ECBFF">byte[] ipAddressByteArray = address.getAddress();</span></div><div class="ec-line"><span style="--0:#9ECBFF">workerId = (((ipAddressByteArray[ipAddressByteArray.length - 2] &#x26; 0B11)</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#9ECBFF">&#x3C;&#x3C; Byte.SIZE) + (ipAddressByteArray[ipAddressByteArray.length - 1]</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#FDAEB7;--0fs:italic">&#x26;</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">0xFF));</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="InetAddress address;try {  address = InetAddress.getLocalHost();} catch (final UnknownHostException e) {  throw new IllegalStateException(            &#x22;Cannot get LocalHost InetAddress, please check your network!&#x22;);}byte[] ipAddressByteArray = address.getAddress();workerId = (((ipAddressByteArray[ipAddressByteArray.length - 2] &#x26; 0B11)          << Byte.SIZE) + (ipAddressByteArray[ipAddressByteArray.length - 1]          &#x26; 0xFF));"><div></div></button></div></figure></div>
<p>如果需要手动指定dataCenterId以及workerId，则在application.properties或者启动时添加命令行参数</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#99A0A6">### set the dataCenterID manually</span></div><div class="ec-line"><span style="--0:#99A0A6"># nacos.core.snowflake.data-center=</span></div><div class="ec-line"><span style="--0:#99A0A6">### set the WorkerID manually</span></div><div class="ec-line"><span style="--0:#99A0A6"># nacos.core.snowflake.worker-id=</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="### set the dataCenterID manually# nacos.core.snowflake.data-center=### set the WorkerID manually# nacos.core.snowflake.worker-id="><div></div></button></div></figure></div>
<p><a name="ZLp5w"></a></p>
<h2 id="nacos内嵌的轻量的基于derby的分布式关系型存储">Nacos内嵌的轻量的基于Derby的分布式关系型存储</h2>
<p><a name="1B5KV"></a></p>
<h3 id="背景">背景</h3>
<ol>
<li>如果配置文件数量较少，在集群模式下需要高可用数据库集群作为支撑的成本太大，期望有一个轻量的分布式关系型存储来解决</li>
<li>nacos内部一些元数据信息存储，比如用户信息，命名空间信息</li>
<li>思路来源：<a href="https://github.com/rqlite/rqlite" referrerpolicy="unsafe-url" rel="nofollow" target="_blank">https://github.com/rqlite/rqlite</a></li>
</ol>
<p><a name="Du2qc"></a></p>
<h3 id="设计思路">设计思路</h3>
<p><a name="NzxHa"></a></p>
<h4 id="目标">目标</h4>
<p>设计目标，是期望nacos存在两种数据存储模式，一种是现在的方式，数据存储在外置数据源（关系型数据库）；第二种方式是内嵌存储数据源（Apache Derby）。用户能够使用命令行参数配置的方式，随意使用这两种数据存储模式<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1591015542106-f14d2579-229f-4bfb-a432-e40854e65d6d.png#align=left&#x26;display=inline&#x26;height=903&#x26;margin=%5Bobject%20Object%5D&#x26;name=image.png&#x26;originHeight=903&#x26;originWidth=1514&#x26;size=237497&#x26;status=done&#x26;style=none&#x26;width=1514" alt="image.png" referrerpolicy="no-referrer"></p>
<p><a name="LqUtU"></a></p>
<h4 id="总体">总体</h4>
<p>将一次请求操作涉及的SQL上下文按顺序保存起来。然后通过一致协议层将本次请求涉及的SQL上下文进行同步，然后每个节点将其解析并重新按顺序在一次数据库会话中执行。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/333972/1587204104465-2270480a-de25-4c84-a11b-6edd2de99e66.png#align=left&#x26;display=inline&#x26;height=814&#x26;margin=%5Bobject%20Object%5D&#x26;name=%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6%20%281%29.png&#x26;originHeight=814&#x26;originWidth=1149&#x26;size=130886&#x26;status=done&#x26;style=none&#x26;width=1149" alt="未命名文件 (1).png" referrerpolicy="no-referrer"></p>
<p><a name="yxFYn"></a></p>
<h4 id="谁可以处理请求">谁可以处理请求</h4>
<p>当使用者开启1.3.0的新特性——内嵌分布式关系型数据存储时，所有的写操作请求都将路由到Leader节点进行处理；但是，由于Raft状态机的特性，当某一个节点在apply数据库操作请求时发生非SQL逻辑错误引发的异常时，将导致状态机无法继续正常进行工作，此时将会触发配置管理模块的降级操作</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">registerSubscribe</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  NotifyCenter.</span><span style="--0:#B392F0">registerSubscribe</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">SmartSubscribe</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    @</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">onEvent</span><span style="--0:#E1E4E8">(Event </span><span style="--0:#FFAB70">event</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (event </span><span style="--0:#F97583">instanceof</span><span style="--0:#E1E4E8"> RaftDBErrorRecoverEvent) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        downgrading </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">false</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">      }</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">if</span><span style="--0:#E1E4E8"> (event </span><span style="--0:#F97583">instanceof</span><span style="--0:#E1E4E8"> RaftDBErrorEvent) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        downgrading </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">true</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">      }</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    @</span><span style="--0:#F97583">Override</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">canNotify</span><span style="--0:#E1E4E8">(Event </span><span style="--0:#FFAB70">event</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> (event </span><span style="--0:#F97583">instanceof</span><span style="--0:#E1E4E8"> RaftDBErrorEvent) </span><span style="--0:#F97583">||</span><span style="--0:#E1E4E8"> (event </span><span style="--0:#F97583">instanceof</span><span style="--0:#E1E4E8"> RaftDBErrorRecoverEvent);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  });</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private void registerSubscribe() {  NotifyCenter.registerSubscribe(new SmartSubscribe() {    @Override    public void onEvent(Event event) {      if (event instanceof RaftDBErrorRecoverEvent) {        downgrading = false;        return;      }      if (event instanceof RaftDBErrorEvent) {        downgrading = true;      }    }    @Override    public boolean canNotify(Event event) {      return (event instanceof RaftDBErrorEvent) || (event instanceof RaftDBErrorRecoverEvent);    }  });}"><div></div></button></div></figure></div>
<p>因此，综上所述，可以通过活动图来理解下，什么情况下需要将请求进行转发
<img src="https://cdn.nlark.com/yuque/__puml/db53c1ade61235d4c9659607b98ef7c6.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJGaWx0ZXIuZG9GaWx0ZXJcIlxuXG5pZiBcIuacrOiKgueCueaYr0xlYWRlclwiIHRoZW5cbiAgLWxlZnQtPlt0cnVlXSBcIuacrOiKgueCueWkhOeQhlwiXG4gIC0tPiAoKilcbmVsc2VcbiAgICBpZiBcIuezu-e7n-mZjee6p-W8gOWQr1wiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwi6L2s5Y-R57uZTGVhZGVyXCJcbiAgICAgICAgLS0-ICgqKVxuICAgIGVsc2VcbiAgICAgICAgaWYgXCLlhpnmk43kvZzor7fmsYJcIiB0aGVuXG4gICAgICAgICAgICAtLT5bdHJ1ZV0gXCLovazlj5Hnu5lMZWFkZXJcIlxuICAgICAgICAgICAgLS0-ICgqKVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICAtLT5bZmFsc2VdIFwi5pys6IqC54K55aSE55CGXCJcbiAgICAgICAgZW5kaWZcbiAgICBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IjFuWW9HIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC9kYjUzYzFhZGU2MTIzNWQ0Yzk2NTk2MDdiOThlZjdjNi5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt="" referrerpolicy="no-referrer"></p>
<p><a name="g1buf"></a></p>
<h4 id="相关数据承载对象">相关数据承载对象</h4>
<p>数据库的DML语句是select、insert、update、delete，根据SQL语句对于数据操作的性质，可以分为两大类：query以及update，select语句对应的是数据查询，insert、update、delete语句对应的是数据修改。同时在进行数据库操作时，为了避免SQL注入，使用的是PreparedStatement，因此需要SQL语句+参数，因此可以得到两个关于数据库操作的Request对象</p>
<ol>
<li>SelectRequest</li>
</ol>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">SelectRequest</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">implements</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">Serializable</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> serialVersionUID </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">2212052574976898602L</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 查询类别，因为目前使用的是JdbcTemplate，查询单个、查询多个，是否使用RowMapper转为对象</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">byte</span><span style="--0:#E1E4E8"> queryType;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// sql语句</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// select * from config_info where</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> String sql;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> String className;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public class SelectRequest implements Serializable {    private static final long serialVersionUID = 2212052574976898602L;    // 查询类别，因为目前使用的是JdbcTemplate，查询单个、查询多个，是否使用RowMapper转为对象    private byte queryType;    // sql语句    // select * from config_info where    private String sql;    private Object[] args;    private String className;}"><div></div></button></div></figure></div>
<ol start="2">
<li>ModifyRequest</li>
</ol>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">ModifyRequest</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">implements</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">Serializable</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> serialVersionUID </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">4548851816596520564L</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">int</span><span style="--0:#E1E4E8"> executeNo;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> String sql;</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public class ModifyRequest implements Serializable {    private static final long serialVersionUID = 4548851816596520564L;    private int executeNo;    private String sql;    private Object[] args;}"><div></div></button></div></figure></div>
<p><a name="moKl7"></a></p>
<h4 id="配置发布">配置发布</h4>
<p>配置发布操作涉及三个事务：</p>
<ol>
<li>config_info保存配置信息</li>
<li>config_tags_relation保存配置与标签的关联关系</li>
<li>his_config_info保存一条配置操作历史记录</li>
</ol>
<p>这三个事务都在配置发布这个大事务下，如果说我们对每个事务操作进行一个Raft协议提交，假设1、2两个事务通过Raft提交后都成功Apply了，第三个事务在进行Raft提交后apply失败，那么对于这个配置发布的大事务来说，是需要整体回滚的，否则就会违反原子性，那么可能需要说将事务回滚操作又进行一次Raft提交，那么整体的复杂程度上升，并且直接引入了分布式事务的管理，因此为了避免这个问题，我们将这三个事务涉及的SQL上下文进行整合成一个大的SQL上下文，对这大的SQL上下文进行Raft协议提交。保证了三个子事务在同一次数据库会话当中，成功解决原子性的问题，同时由于Raft协议对于事务日志的处理是串行执行的，因此相当于将数据库的事务隔离级别调整为串行化。</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addConfigInfo</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String srcIp,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String srcUser, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> ConfigInfo configInfo, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> Timestamp time,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> Map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">String, Object</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> configAdvanceInfo, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">boolean</span><span style="--0:#E1E4E8"> notify) {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">try</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String tenantTmp </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> StringUtils.</span><span style="--0:#B392F0">isBlank</span><span style="--0:#E1E4E8">(configInfo.</span><span style="--0:#B392F0">getTenant</span><span style="--0:#E1E4E8">()) </span><span style="--0:#F97583">?</span></div><div class="ec-line"><span style="--0:#E1E4E8">          StringUtils.EMPTY </span><span style="--0:#F97583">:</span></div><div class="ec-line"><span style="--0:#E1E4E8">          configInfo.</span><span style="--0:#B392F0">getTenant</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    configInfo.</span><span style="--0:#B392F0">setTenant</span><span style="--0:#E1E4E8">(tenantTmp);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#99A0A6">// 通过雪花ID算法获取数据库主键</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> configId </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> idGeneratorManager.</span><span style="--0:#B392F0">nextId</span><span style="--0:#E1E4E8">(RESOURCE_CONFIG_INFO_ID);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> hisId </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> idGeneratorManager.</span><span style="--0:#B392F0">nextId</span><span style="--0:#E1E4E8">(RESOURCE_CONFIG_HISTORY_ID);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">addConfigInfoAtomic</span><span style="--0:#E1E4E8">(configId, srcIp, srcUser, configInfo, time,</span></div><div class="ec-line"><span style="--0:#E1E4E8">          configAdvanceInfo);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    String configTags </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> configAdvanceInfo </span><span style="--0:#F97583">==</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">?</span></div><div class="ec-line"><span style="--0:#E1E4E8">          </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">:</span></div><div class="ec-line"><span style="--0:#E1E4E8">          (String) configAdvanceInfo.</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">(</span><span style="--0:#9ECBFF">"config_tags"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">addConfigTagsRelation</span><span style="--0:#E1E4E8">(configId, configTags, configInfo.</span><span style="--0:#B392F0">getDataId</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">          configInfo.</span><span style="--0:#B392F0">getGroup</span><span style="--0:#E1E4E8">(), configInfo.</span><span style="--0:#B392F0">getTenant</span><span style="--0:#E1E4E8">());</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#B392F0">insertConfigHistoryAtomic</span><span style="--0:#E1E4E8">(hisId, configInfo, srcIp, srcUser, time, </span><span style="--0:#9ECBFF">"I"</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    EmbeddedStorageContextUtils.</span><span style="--0:#B392F0">onModifyConfigInfo</span><span style="--0:#E1E4E8">(configInfo, srcIp, time);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    databaseOperate.</span><span style="--0:#B392F0">blockUpdate</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">finally</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line"><span style="--0:#E1E4E8">    EmbeddedStorageContextUtils.</span><span style="--0:#B392F0">cleanAllContext</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">  }</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addConfigInfoAtomic</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> id, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String srcIp,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String srcUser, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> ConfigInfo configInfo, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> Timestamp time,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      Map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">String, Object</span><span style="--0:#F97583">></span><span style="--0:#E1E4E8"> configAdvanceInfo) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  ...</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 参数处理</span></div><div class="ec-line"><span style="--0:#E1E4E8">    ...</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String sql </span><span style="--0:#F97583">=</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#9ECBFF">"INSERT INTO config_info(id, data_id, group_id, tenant_id, app_name, content, md5, src_ip, src_user, gmt_create,"</span></div><div class="ec-line"><span style="--0:#E1E4E8">            </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"gmt_modified, c_desc, c_use, effect, type, c_schema) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] { id, configInfo.</span><span style="--0:#B392F0">getDataId</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">        configInfo.</span><span style="--0:#B392F0">getGroup</span><span style="--0:#E1E4E8">(), tenantTmp, appNameTmp, configInfo.</span><span style="--0:#B392F0">getContent</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">        md5Tmp, srcIp, srcUser, time, time, desc, use, effect, type, schema, };</span></div><div class="ec-line"><span style="--0:#E1E4E8">  SqlContextUtils.</span><span style="--0:#B392F0">addSqlContext</span><span style="--0:#E1E4E8">(sql, args);</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> id;</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addConfigTagRelationAtomic</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> configId, String tagName, String dataId,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      String group, String tenant) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String sql </span><span style="--0:#F97583">=</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#9ECBFF">"INSERT INTO config_tags_relation(id,tag_name,tag_type,data_id,group_id,tenant_id) "</span></div><div class="ec-line"><span style="--0:#E1E4E8">            </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"VALUES(?,?,?,?,?,?)"</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] { configId, tagName, </span><span style="--0:#79B8FF">null</span><span style="--0:#E1E4E8">, dataId, group,</span></div><div class="ec-line"><span style="--0:#E1E4E8">        tenant };</span></div><div class="ec-line"><span style="--0:#E1E4E8">  SqlContextUtils.</span><span style="--0:#B392F0">addSqlContext</span><span style="--0:#E1E4E8">(sql, args);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">insertConfigHistoryAtomic</span><span style="--0:#E1E4E8">(</span><span style="--0:#F97583">long</span><span style="--0:#E1E4E8"> configHistoryId, ConfigInfo configInfo,</span></div><div class="ec-line"><span style="--0:#E1E4E8">      String srcIp, String srcUser, </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> Timestamp time, String ops) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">  ...</span></div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#99A0A6">// 参数处理</span></div><div class="ec-line"><span style="--0:#E1E4E8">    ...</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> String sql </span><span style="--0:#F97583">=</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#9ECBFF">"INSERT INTO his_config_info (id,data_id,group_id,tenant_id,app_name,content,md5,"</span></div><div class="ec-line"><span style="--0:#E1E4E8">            </span><span style="--0:#F97583">+</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">"src_ip,src_user,gmt_modified,op_type) VALUES(?,?,?,?,?,?,?,?,?,?,?)"</span><span style="--0:#E1E4E8">;</span></div><div class="ec-line"><span style="--0:#E1E4E8">  </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] args </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">Object</span><span style="--0:#E1E4E8">[] { configHistoryId, configInfo.</span><span style="--0:#B392F0">getDataId</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">        configInfo.</span><span style="--0:#B392F0">getGroup</span><span style="--0:#E1E4E8">(), tenantTmp, appNameTmp, configInfo.</span><span style="--0:#B392F0">getContent</span><span style="--0:#E1E4E8">(),</span></div><div class="ec-line"><span style="--0:#E1E4E8">        md5Tmp, srcIp, srcUser, time, ops };</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">  SqlContextUtils.</span><span style="--0:#B392F0">addSqlContext</span><span style="--0:#E1E4E8">(sql, args);</span></div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#99A0A6">/**</span></div><div class="ec-line"><span style="--0:#99A0A6"> * Temporarily saves all insert, update, and delete statements under</span></div><div class="ec-line"><span style="--0:#99A0A6"> * a transaction in the order in which they occur</span></div><div class="ec-line"><span style="--0:#99A0A6"> *</span></div><div class="ec-line"><span style="--0:#99A0A6"> * </span><span style="--0:#F97583">@author</span><span style="--0:#99A0A6"> &#x3C;a href="mailto:liaochuntao@live.com">liaochuntao&#x3C;/a></span></div><div class="ec-line"><span style="--0:#99A0A6"> */</span></div><div class="ec-line"><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">class</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">SqlContextUtils</span><span style="--0:#E1E4E8"> {</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">private</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">final</span><span style="--0:#E1E4E8"> ThreadLocal&#x3C;ArrayList&#x3C;</span><span style="--0:#F97583">ModifyRequest</span><span style="--0:#E1E4E8">>> SQL_CONTEXT </span><span style="--0:#F97583">=</span></div><div class="ec-line"><span style="--0:#E1E4E8">            ThreadLocal.</span><span style="--0:#B392F0">withInitial</span><span style="--0:#E1E4E8">(ArrayList</span><span style="--0:#F97583">::new</span><span style="--0:#E1E4E8">);</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">addSqlContext</span><span style="--0:#E1E4E8">(String </span><span style="--0:#FFAB70">sql</span><span style="--0:#E1E4E8">, Object... </span><span style="--0:#FFAB70">args</span><span style="--0:#E1E4E8">) {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        ArrayList&#x3C;</span><span style="--0:#F97583">ModifyRequest</span><span style="--0:#E1E4E8">> requests </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> SQL_CONTEXT.</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">        ModifyRequest context </span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">new</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">ModifyRequest</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">        context.</span><span style="--0:#B392F0">setExecuteNo</span><span style="--0:#E1E4E8">(requests.</span><span style="--0:#B392F0">size</span><span style="--0:#E1E4E8">());</span></div><div class="ec-line"><span style="--0:#E1E4E8">        context.</span><span style="--0:#B392F0">setSql</span><span style="--0:#E1E4E8">(sql);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        context.</span><span style="--0:#B392F0">setArgs</span><span style="--0:#E1E4E8">(args);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        requests.</span><span style="--0:#B392F0">add</span><span style="--0:#E1E4E8">(context);</span></div><div class="ec-line"><span style="--0:#E1E4E8">        SQL_CONTEXT.</span><span style="--0:#B392F0">set</span><span style="--0:#E1E4E8">(requests);</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> List&#x3C;</span><span style="--0:#F97583">ModifyRequest</span><span style="--0:#E1E4E8">> </span><span style="--0:#B392F0">getCurrentSqlContext</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        </span><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> SQL_CONTEXT.</span><span style="--0:#B392F0">get</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">    </span><span style="--0:#F97583">public</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">static</span><span style="--0:#E1E4E8"> </span><span style="--0:#F97583">void</span><span style="--0:#E1E4E8"> </span><span style="--0:#B392F0">cleanCurrentSqlContext</span><span style="--0:#E1E4E8">() {</span></div><div class="ec-line"><span style="--0:#E1E4E8">        SQL_CONTEXT.</span><span style="--0:#B392F0">remove</span><span style="--0:#E1E4E8">();</span></div><div class="ec-line"><span style="--0:#E1E4E8">    }</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#E1E4E8">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void addConfigInfo(final String srcIp,      final String srcUser, final ConfigInfo configInfo, final Timestamp time,      final Map<String, Object> configAdvanceInfo, final boolean notify) {  try {    final String tenantTmp = StringUtils.isBlank(configInfo.getTenant()) ?          StringUtils.EMPTY :          configInfo.getTenant();    configInfo.setTenant(tenantTmp);        // 通过雪花ID算法获取数据库主键    long configId = idGeneratorManager.nextId(RESOURCE_CONFIG_INFO_ID);    long hisId = idGeneratorManager.nextId(RESOURCE_CONFIG_HISTORY_ID);    addConfigInfoAtomic(configId, srcIp, srcUser, configInfo, time,          configAdvanceInfo);    String configTags = configAdvanceInfo == null ?          null :          (String) configAdvanceInfo.get(&#x22;config_tags&#x22;);    addConfigTagsRelation(configId, configTags, configInfo.getDataId(),          configInfo.getGroup(), configInfo.getTenant());    insertConfigHistoryAtomic(hisId, configInfo, srcIp, srcUser, time, &#x22;I&#x22;);    EmbeddedStorageContextUtils.onModifyConfigInfo(configInfo, srcIp, time);    databaseOperate.blockUpdate();  }  finally {    EmbeddedStorageContextUtils.cleanAllContext();  }}public long addConfigInfoAtomic(final long id, final String srcIp,      final String srcUser, final ConfigInfo configInfo, final Timestamp time,      Map<String, Object> configAdvanceInfo) {  ...    // 参数处理    ...  final String sql =        &#x22;INSERT INTO config_info(id, data_id, group_id, tenant_id, app_name, content, md5, src_ip, src_user, gmt_create,&#x22;            + &#x22;gmt_modified, c_desc, c_use, effect, type, c_schema) VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&#x22;;  final Object[] args = new Object[] { id, configInfo.getDataId(),        configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),        md5Tmp, srcIp, srcUser, time, time, desc, use, effect, type, schema, };  SqlContextUtils.addSqlContext(sql, args);  return id;}public void addConfigTagRelationAtomic(long configId, String tagName, String dataId,      String group, String tenant) {  final String sql =        &#x22;INSERT INTO config_tags_relation(id,tag_name,tag_type,data_id,group_id,tenant_id) &#x22;            + &#x22;VALUES(?,?,?,?,?,?)&#x22;;  final Object[] args = new Object[] { configId, tagName, null, dataId, group,        tenant };  SqlContextUtils.addSqlContext(sql, args);}public void insertConfigHistoryAtomic(long configHistoryId, ConfigInfo configInfo,      String srcIp, String srcUser, final Timestamp time, String ops) {  ...    // 参数处理    ...  final String sql =        &#x22;INSERT INTO his_config_info (id,data_id,group_id,tenant_id,app_name,content,md5,&#x22;            + &#x22;src_ip,src_user,gmt_modified,op_type) VALUES(?,?,?,?,?,?,?,?,?,?,?)&#x22;;  final Object[] args = new Object[] { configHistoryId, configInfo.getDataId(),        configInfo.getGroup(), tenantTmp, appNameTmp, configInfo.getContent(),        md5Tmp, srcIp, srcUser, time, ops };  SqlContextUtils.addSqlContext(sql, args);}/** * Temporarily saves all insert, update, and delete statements under * a transaction in the order in which they occur * * @author <a href=&#x22;mailto:liaochuntao@live.com&#x22;>liaochuntao</a> */public class SqlContextUtils {    private static final ThreadLocal<ArrayList<ModifyRequest>> SQL_CONTEXT =            ThreadLocal.withInitial(ArrayList::new);    public static void addSqlContext(String sql, Object... args) {        ArrayList<ModifyRequest> requests = SQL_CONTEXT.get();        ModifyRequest context = new ModifyRequest();        context.setExecuteNo(requests.size());        context.setSql(sql);        context.setArgs(args);        requests.add(context);        SQL_CONTEXT.set(requests);    }    public static List<ModifyRequest> getCurrentSqlContext() {        return SQL_CONTEXT.get();    }    public static void cleanCurrentSqlContext() {        SQL_CONTEXT.remove();    }}"><div></div></button></div></figure></div>
<p>通过一个时序图来更加直观的理解
<img src="https://cdn.nlark.com/yuque/__puml/618e8997395fbc74433ac4a60f67b6b4.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCJVc2VyXCIgYXMgVXNlclxuXG5wYXJ0aWNpcGFudCBcIkNvbmZpZ1NlcnZpY2VcIiBhcyBTZXJ2aWNlXG5wYXJ0aWNpcGFudCBcIlBlcnNpc3RlbmNlU2VydmljZVwiIGFzIFJlcG9zaXRvcnlcbnBhcnRpY2lwYW50IFwiRGVyYnlcIiBhcyBEQlxucGFydGljaXBhbnQgXCJTUUxDb250ZXh0VXRpbHNcIiBhcyBTUUxDb250ZXh0XG5wYXJ0aWNpcGFudCBcIkxvZ1Byb2Nlc3NvclwiIGFzIFByb2Nlc3NvclxucGFydGljaXBhbnQgXCJDb25zaXN0ZW5jeVByb3RvY29sXCIgYXMgUHJvdG9jb2xcbnBhcnRpY2lwYW50IFwiTG9nXCIgYXMgTG9nXG5cbmFjdGl2YXRlIFVzZXJcblxuVXNlciAtPiBTZXJ2aWNlOiDlj5HotbfphY3nva7lj5HluIPor7fmsYJcbmFjdGl2YXRlIFNlcnZpY2VcblxuU2VydmljZSAtPiBSZXBvc2l0b3J5OiDphY3nva7lj5HluINcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBTUUxDb250ZXh0OiDmi6bmiKrlvZPliY1TUUzkuIrkuIvmlodcbmFjdGl2YXRlIFNRTENvbnRleHRcblxuUmVwb3NpdG9yeSAtPiBSZXBvc2l0b3J5OiBjb21taXQg5pON5L2cXG5cblNRTENvbnRleHQgLT4gUmVwb3NpdG9yeTog5b2T5YmN6K-35rGC5raJ5Y-K55qE5omA5pyJU1FM5LiK5LiL5paHXG5cbmRlYWN0aXZhdGUgU1FMQ29udGV4dFxuXG5SZXBvc2l0b3J5IC0-IExvZzog5p6E5bu66K-35rGC5L2TXG5cbmFjdGl2YXRlIExvZ1xuZGVhY3RpdmF0ZSBMb2dcblxuUmVwb3NpdG9yeSAtPiBQcm90b2NvbDogc3VibWl0KCkg6L-b6KGM6K-35rGC5o-Q5LqkXG5hY3RpdmF0ZSBQcm90b2NvbFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb3RvY29sIC0-IFByb2Nlc3Nvcjogb25BcHBseSgpIOaWueazle-8jOeKtuaAgeacuuWkjeWItkxvZ1xuYWN0aXZhdGUgUHJvY2Vzc29yXG5cblByb2Nlc3NvciAtPiBSZXBvc2l0b3J5OiDmiafooYzmiYDmnInnmoRTUUzkuIrkuIvmlodcbmFjdGl2YXRlIFJlcG9zaXRvcnlcblxuUmVwb3NpdG9yeSAtPiBEQjog5pWw5o2u6JC95bqTXG5hY3RpdmF0ZSBEQlxuXG5EQiAtPiBSZXBvc2l0b3J5OiDnu5PmnZ_lubbov5Tlm57nu5PmnpxcbmRlYWN0aXZhdGUgREJcblxuUmVwb3NpdG9yeSAtPiBQcm9jZXNzb3I6IOi_lOWbnkxvZ0Z1dHVyZeW5tuiuvue9ruacrOasoeaJp-ihjOeahOe7k-aenFxuZGVhY3RpdmF0ZSBSZXBvc2l0b3J5XG5cblByb2Nlc3NvciAtPiBQcm90b2NvbDog6L-U5ZueTG9nRnV0dXJlXG5kZWFjdGl2YXRlIFByb2Nlc3NvclxuXG5Qcm90b2NvbCAtPiBTZXJ2aWNlOiDmnKzmrKHor7fmsYLnmoTnu5PmnpxcbmRlYWN0aXZhdGUgUHJvdG9jb2xcblxuU2VydmljZSAtPiBVc2VyXG5kZWFjdGl2YXRlIFNlcnZpY2VcbmRlYWN0aXZhdGUgVXNlclxuXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiVnQxNzciLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzYxOGU4OTk3Mzk1ZmJjNzQ0MzNhYzRhNjBmNjdiNmI0LnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=" alt="" referrerpolicy="no-referrer"></p>
<p><a name="AAJTE"></a></p>
<h3 id="如何使用新特性">如何使用新特性</h3>
<div class="expressive-code"><figure class="frame is-terminal not-content"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#B392F0">./startup.sh</span><span style="--0:#E1E4E8"> </span><span style="--0:#79B8FF">-p</span><span style="--0:#E1E4E8"> </span><span style="--0:#9ECBFF">embedded</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="./startup.sh -p embedded"><div></div></button></div></figure></div>
<p>是否启用内嵌的分布式关系型存储的活动图
<img src="https://cdn.nlark.com/yuque/__puml/1fd656ba3b39fe5de8fea78efdf98dd1.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbigqKSAtLT4gXCJDb25maWcuc3RhcnQoKVwiXG5cbmlmIFwi5Y2V5py65qih5byPXCIgdGhlblxuICAtcmlnaHQtPlt0cnVlXSBcInJldHVybiDpu5jorqTljZXmnLrlrZjlgqjooYzkuLpcIlxuICAtLT4gKCopXG5lbHNlXG4gaWYgXCLlt7LphY3nva7lpJbnva7lrZjlgqhcIiB0aGVuXG4gICAgLS0-W3RydWVdIFwicmV0dXJuIOWklue9ruaVsOaNruWtmOWCqOihjOS4ulwiXG4gICAgLS0-ICgqKVxuIGVsc2VcbiAgICBpZiBcIuW8gOWQr-WGheW1jOWtmOWCqFwiIHRoZW5cbiAgICAgICAgLS0-W3RydWVdIFwicmV0dXJuIOi9u-mHj-WGheW1jOWIhuW4g-W8j-WtmOWCqOihjOS4ulwiXG4gICAgICAgIC0tPiAoKilcbiAgICBlbHNlXG4gICAgICAgIC0-W2ZhbHNlXSBcInJldHVybiDpu5jorqTlpJbnva7mlbDmja7lrZjlgqjooYzkuLpcIlxuICAgICAgICAtLT4gKCopXG5cdFx0ZW5kaWZcbiBlbmRpZlxuZW5kaWZcblxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6IkNNN1VDIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC8xZmQ2NTZiYTNiMzlmZTVkZThmZWE3OGVmZGY5OGRkMS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9" alt="" referrerpolicy="no-referrer"></p>
<p><a name="9UAXN"></a></p>
<h3 id="新特性的相关运维操作">新特性的相关运维操作</h3>
<p>直接查询每个节点的derby存储的数据</p>
<div class="expressive-code"><figure class="frame not-content"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#E1E4E8">GET </span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">nacos</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">v1</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">cs</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">ops</span><span style="--0:#F97583">/</span><span style="--0:#E1E4E8">derby</span><span style="--0:#F97583">?</span><span style="--0:#E1E4E8">sql</span><span style="--0:#F97583">=</span><span style="--0:#E1E4E8">select </span><span style="--0:#F97583">*</span><span style="--0:#E1E4E8"> from config_info</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F97583">return</span><span style="--0:#E1E4E8"> List</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">Map</span><span style="--0:#F97583">&#x3C;</span><span style="--0:#E1E4E8">String, Object</span><span style="--0:#F97583">>></span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="GET /nacos/v1/cs/ops/derby?sql=select * from config_inforeturn List<Map<String, Object>>"><div></div></button></div></figure></div>
<p><a name="YcqO2"></a></p>
<h3 id="不足">不足</h3>
<ol>
<li>在数据库上层构建一层分布式数据操作同步层，对数据库的操作存在了限制，比如第一步insert操作，然后select操作，最后在update操作，这种在数据修改语句中穿插着查询语句的操作顺序是不支持的</li>
<li>限制了数据库的性能，由于间接的将数据库事务隔离级别调整为了串行化，人为的将并发能力降低了</li>
</ol>
<p><a name="7dul8"></a></p>
<h3 id="未来演进">未来演进</h3>
<p>将于Apache Derby官方一起尝试基于Raft实现BingLog的同步复制操作，从底层实现数据库同步能力</p>  </div> </main> </div>  <div class="pb-6 astro-7jjqptxk"> <div class="pagination-links astro-u2l5gyhi"> <a href="/blog/article-nacos120-guide/" rel="prev" class="astro-u2l5gyhi"> <svg aria-hidden="true" class="astro-u2l5gyhi astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17 11H9.41l3.3-3.29a1.004 1.004 0 1 0-1.42-1.42l-5 5a1 1 0 0 0-.21.33 1 1 0 0 0 0 .76 1 1 0 0 0 .21.33l5 5a1.002 1.002 0 0 0 1.639-.325 1 1 0 0 0-.219-1.095L9.41 13H17a1 1 0 0 0 0-2Z"/></svg>  <span class="astro-u2l5gyhi"> 上一篇 <br class="astro-u2l5gyhi"> <span class="link-title astro-u2l5gyhi">Nacos 1.2.0权限控制介绍和使用</span> </span> </a> <a href="/blog/article-pilot-mcp/" rel="next" class="astro-u2l5gyhi"> <svg aria-hidden="true" class="astro-u2l5gyhi astro-c6vsoqas" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="--sl-icon-size: 1.5rem;"><path d="M17.92 11.62a1.001 1.001 0 0 0-.21-.33l-5-5a1.003 1.003 0 1 0-1.42 1.42l3.3 3.29H7a1 1 0 0 0 0 2h7.59l-3.3 3.29a1.002 1.002 0 0 0 .325 1.639 1 1 0 0 0 1.095-.219l5-5a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76Z"/></svg>  <span class="astro-u2l5gyhi"> 下一篇 <br class="astro-u2l5gyhi"> <span class="link-title astro-u2l5gyhi">Pilot MCP协议介绍</span> </span> </a> </div>  </div> </div> <div class="right-sidebar-panel w-[25%] fixed h-full hidden 2xl:inline-block xl:inline-block lg:inline-block md:inline-block astro-7jjqptxk"> <markdown-toc data-min-h="1" data-max-h="4" class="isMobile astro-koteama4" style="--depth: 0;"><nav aria-labelledby="starlight__on-this-page" class="starlight__on-this-page astro-koteama4" style="--depth: 0;"><h2 id="starlight__on-this-page" class="heading astro-koteama4" style="--depth: 0;">本页内容</h2><ul class="astro-oshslw7j" style="--depth: 0;"> <li class="astro-oshslw7j" style="--depth: 0;"> <a href="#_top" class="astro-oshslw7j" style="--depth: 0;"> <span class="astro-oshslw7j" style="--depth: 0;">概述</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 0;"> <a href="#nacos-130-特性以及功能使用文档" class="astro-oshslw7j" style="--depth: 0;"> <span class="astro-oshslw7j" style="--depth: 0;">Nacos 1.3.0 特性以及功能使用文档</span> </a> <ul class="astro-oshslw7j" style="--depth: 1;"> <li class="astro-oshslw7j" style="--depth: 1;"> <a href="#概述" class="astro-oshslw7j" style="--depth: 1;"> <span class="astro-oshslw7j" style="--depth: 1;">概述</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 1;"> <a href="#系统参数变化" class="astro-oshslw7j" style="--depth: 1;"> <span class="astro-oshslw7j" style="--depth: 1;">系统参数变化</span> </a> <ul class="astro-oshslw7j" style="--depth: 2;"> <li class="astro-oshslw7j" style="--depth: 2;"> <a href="#新增" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">新增</span> </a>  </li> </ul>  </li><li class="astro-oshslw7j" style="--depth: 1;"> <a href="#nacos的未来整体逻辑架构及其组件" class="astro-oshslw7j" style="--depth: 1;"> <span class="astro-oshslw7j" style="--depth: 1;">Nacos的未来整体逻辑架构及其组件</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 1;"> <a href="#nacos集群成员节点寻址模式" class="astro-oshslw7j" style="--depth: 1;"> <span class="astro-oshslw7j" style="--depth: 1;">Nacos集群成员节点寻址模式</span> </a> <ul class="astro-oshslw7j" style="--depth: 2;"> <li class="astro-oshslw7j" style="--depth: 2;"> <a href="#寻址模式详细" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">寻址模式详细</span> </a> <ul class="astro-oshslw7j" style="--depth: 3;"> <li class="astro-oshslw7j" style="--depth: 3;"> <a href="#fileconfigmemberlookup" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">FileConfigMemberLookup</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 3;"> <a href="#addressservermemberlookup" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">AddressServerMemberLookup</span> </a>  </li> </ul>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#节点管理和寻址模式如何结合的" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">节点管理和寻址模式如何结合的</span> </a>  </li> </ul>  </li><li class="astro-oshslw7j" style="--depth: 1;"> <a href="#nacos一致性协议协议层抽象" class="astro-oshslw7j" style="--depth: 1;"> <span class="astro-oshslw7j" style="--depth: 1;">Nacos一致性协议协议层抽象</span> </a> <ul class="astro-oshslw7j" style="--depth: 2;"> <li class="astro-oshslw7j" style="--depth: 2;"> <a href="#一致协议抽象" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">一致协议抽象</span> </a> <ul class="astro-oshslw7j" style="--depth: 3;"> <li class="astro-oshslw7j" style="--depth: 3;"> <a href="#consistencyprotocol" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">ConsistencyProtocol</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 3;"> <a href="#数据操作请求提交对象loggetrequest" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">数据操作请求提交对象：Log、GetRequest</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 3;"> <a href="#功能模块使用一致性协议logprocessor" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">功能模块使用一致性协议：LogProcessor</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 3;"> <a href="#综述" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">综述</span> </a>  </li> </ul>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#一致性协议层工作流程" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">一致性协议层工作流程</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#nacos一致性协议层之cp协议的实现选择jraft" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">Nacos一致性协议层之CP协议的实现选择——JRaft</span> </a> <ul class="astro-oshslw7j" style="--depth: 3;"> <li class="astro-oshslw7j" style="--depth: 3;"> <a href="#疑问解答为什么要创建多个raft-group" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">疑问解答：为什么要创建多个raft group</span> </a>  </li> </ul>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#jraft运维操作" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">JRaft运维操作</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#jraft协议相关配置参数" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">JRaft协议相关配置参数</span> </a> <ul class="astro-oshslw7j" style="--depth: 3;"> <li class="astro-oshslw7j" style="--depth: 3;"> <a href="#线性读参数解析" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">线性读参数解析</span> </a>  </li> </ul>  </li> </ul>  </li><li class="astro-oshslw7j" style="--depth: 1;"> <a href="#nacos内嵌分布式id" class="astro-oshslw7j" style="--depth: 1;"> <span class="astro-oshslw7j" style="--depth: 1;">Nacos内嵌分布式ID</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 1;"> <a href="#nacos内嵌的轻量的基于derby的分布式关系型存储" class="astro-oshslw7j" style="--depth: 1;"> <span class="astro-oshslw7j" style="--depth: 1;">Nacos内嵌的轻量的基于Derby的分布式关系型存储</span> </a> <ul class="astro-oshslw7j" style="--depth: 2;"> <li class="astro-oshslw7j" style="--depth: 2;"> <a href="#背景" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">背景</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#设计思路" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">设计思路</span> </a> <ul class="astro-oshslw7j" style="--depth: 3;"> <li class="astro-oshslw7j" style="--depth: 3;"> <a href="#目标" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">目标</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 3;"> <a href="#总体" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">总体</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 3;"> <a href="#谁可以处理请求" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">谁可以处理请求</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 3;"> <a href="#相关数据承载对象" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">相关数据承载对象</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 3;"> <a href="#配置发布" class="astro-oshslw7j" style="--depth: 3;"> <span class="astro-oshslw7j" style="--depth: 3;">配置发布</span> </a>  </li> </ul>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#如何使用新特性" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">如何使用新特性</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#新特性的相关运维操作" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">新特性的相关运维操作</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#不足" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">不足</span> </a>  </li><li class="astro-oshslw7j" style="--depth: 2;"> <a href="#未来演进" class="astro-oshslw7j" style="--depth: 2;"> <span class="astro-oshslw7j" style="--depth: 2;">未来演进</span> </a>  </li> </ul>  </li> </ul>  </li> </ul> </nav></markdown-toc> </div> </div>  </body></html>  